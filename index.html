<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Financeiro | BPO Consult&#243;rios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
:root {
      --bg: #0f172a;
      --bg-dark: #0b1220;
      --card: #1e293b;
      --card-light: #24304a;
      --accent: #38bdf8;
      --accent-2: #22d3ee;
      --danger: #f87171;
      --positive: #4ade80;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 10px;
      --shadow-sm: 0 6px 16px rgba(2,6,23,0.24);
      --shadow-md: 0 12px 28px rgba(2,6,23,0.32);
      --shadow-inset: inset 0 1px 0 rgba(255,255,255,0.04);
      --border-subtle: 1px solid rgba(148,163,184,0.18);
    }
    body.theme-light {
      --bg: #f2f4f7;
      --bg-dark: #e9edf2;
      --card: #f8fafc;
      --card-light: #f1f5f9;
      --accent: #2563eb;
      --accent-2: #38bdf8;
      --danger: #dc2626;
      --positive: #16a34a;
      --text: #0f172a;
      --muted: #475569;
      --shadow-sm: 0 6px 16px rgba(15,23,42,0.08);
      --shadow-md: 0 14px 28px rgba(15,23,42,0.1);
      --border-subtle: 1px solid rgba(15,23,42,0.08);
      background: var(--bg);
      color: var(--text);
    }
    body.theme-light .login-view {
      background: url("fundo_bpo.png") center / cover no-repeat fixed;
    }
    body.theme-light .login-card {
      background: rgba(22, 28, 45, 0.85);
      border: 1px solid rgba(56, 189, 248, 0.2);
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      color: #e2e8f0;
    }
    body.theme-light .login-card input {
      background: rgba(15, 23, 42, 0.9);
      color: #e2e8f0;
      border-color: rgba(148,163,184,0.22);
    }
    body.theme-light .app-shell {
      background: var(--bg-dark);
    }
    body.theme-light aside.sidebar {
      background: #f8fafc;
      border-right: 1px solid rgba(15,23,42,0.08);
    }
    body.theme-light nav button {
      color: var(--muted);
    }
    body.theme-light nav button.active {
      color: var(--text);
      background: rgba(37,99,235,0.08);
      border-color: rgba(37,99,235,0.3);
    }
    body.theme-light .card,
    body.theme-light .chart-wrapper,
    body.theme-light .toast {
      background: var(--card);
      border: 1px solid rgba(15,23,42,0.08);
      box-shadow: 0 6px 16px rgba(15,23,42,0.08);
      color: var(--text);
    }
    body.theme-light .highlight-card {
      background: var(--card-light);
      border-color: rgba(37,99,235,0.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }
    body.theme-light table th,
    body.theme-light table td {
      border-bottom: 1px solid rgba(15,23,42,0.08);
      color: var(--text);
    }
    body.theme-light table tbody tr:hover {
      background: rgba(37,99,235,0.04);
    }
    body.theme-light .badge {
      color: var(--text);
    }
    body.theme-light .badge.receita {
      background: rgba(22,163,74,0.15);
      color: #16a34a;
    }
    body.theme-light .badge.despesa {
      background: rgba(220,38,38,0.15);
      color: #dc2626;
    }
    body.theme-light .btn-secondary,
    body.theme-light .theme-toggle {
      border: 1px solid rgba(15,23,42,0.2);
      color: var(--text);
      background: #ffffff;
    }
    body.theme-light nav button:hover {
      background: rgba(37,99,235,0.08);
      color: var(--text);
    }
      body.theme-light .competency-toolbar select {
        background: #ffffff;
        border: 1px solid rgba(15,23,42,0.15);
        color: var(--text);
        box-shadow: 0 2px 4px rgba(15,23,42,0.06);
      }
    body.theme-light input[type="file"] {
      background: #ffffff;
      color: var(--text);
      border: 1px dashed rgba(37,99,235,0.5);
    }
    body.theme-light input,
    body.theme-light select,
    body.theme-light textarea {
      background: #ffffff;
      color: var(--text);
      border: 1px solid rgba(15,23,42,0.15);
    }
    body.theme-light input:focus,
    body.theme-light select:focus,
    body.theme-light textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.18);
    }
    body.theme-light .chart-wrapper {
      color: var(--text);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
    }
    h1, h2, h3, h4 { margin: 0; }
    .hidden { display: none !important; }
    #login-image-loader {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(8, 12, 22, 0.85);
      z-index: 9999;
    }
    .login-image-loader__img {
      width: 96px;
      height: 96px;
      display: block;
    }
    .login-view {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background: url("fundo_bpo.png") center / cover no-repeat fixed;
    }
    .login-card {
      width: min(420px, 100%);
      background: rgba(22, 28, 45, 0.8);
      border: 1px solid rgba(56, 189, 248, 0.2);
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    .login-card h1 {
      font-size: 1.75rem;
      margin-bottom: 0.25rem;
    }
    .login-card p { margin-top: 0; color: var(--muted); }
    label { display: block; font-weight: 600; margin-bottom: 0.35rem; }
    input, select, button, textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: var(--radius-sm);
        border: 1px solid rgba(148,163,184,0.22);
        background: rgba(15,23,42,0.9);
        color: var(--text);
        font-family: inherit;
        font-size: 0.95rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
      }
      body:not(.theme-light) input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1) brightness(1.2);
      }
      input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: rgba(56,189,248,0.7);
        box-shadow: 0 0 0 3px rgba(56,189,248,0.18);
      }
      .btn {
        cursor: pointer;
        border: none;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        font-weight: 600;
        letter-spacing: 0.02em;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
        filter: brightness(1.02);
      }
      .btn:active { transform: translateY(0); }
      .btn-secondary {
        background: rgba(15,23,42,0.4);
        border: 1px solid rgba(148,163,184,0.3);
        box-shadow: none;
      }
      .btn-secondary:hover {
        border-color: rgba(56,189,248,0.5);
        background: rgba(56,189,248,0.08);
      }
      .theme-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        background: rgba(15,23,42,0.35);
        border: 1px solid rgba(148,163,184,0.35);
        color: var(--text);
        padding: 0.45rem 1rem;
        border-radius: 999px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: background 0.2s, color 0.2s, border-color 0.2s;
      }
      .theme-toggle:hover {
        background: rgba(56,189,248,0.15);
        border-color: rgba(56,189,248,0.45);
      }
      .app-shell {
        display: grid;
        grid-template-columns: 260px 1fr;
        min-height: 100vh;
      }
      aside.sidebar {
        background: #0a1222;
        padding: 2rem 1.5rem;
        border-right: 1px solid rgba(148,163,184,0.16);
      }
      .brand {
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--text);
      }
      .brand-logo {
        width: 46px;
        height: 46px;
        border-radius: 12px;
        border: 1px solid rgba(148,163,184,0.3);
        background: rgba(56,189,248,0.12);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        font-weight: 700;
        color: var(--accent);
        flex-shrink: 0;
      }
      .brand-logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
      }
      .brand-logo.has-image img {
        display: block;
      }
      .brand-logo.has-image span {
        display: none;
      }
      .brand-body {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        min-width: 0;
      }
      .brand-name {
        font-weight: 700;
        font-size: 1.05rem;
        letter-spacing: 0.02em;
        text-transform: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .brand-select {
        width: 100%;
        font-size: 0.8rem;
        padding: 0.35rem 0.6rem;
        border-radius: 10px;
      }
      nav button {
        width: 100%;
        margin-bottom: 0.6rem;
        background: transparent;
        border: 1px solid transparent;
        padding: 0.85rem 1rem;
        border-radius: var(--radius-md);
        color: var(--muted);
        text-align: left;
        cursor: pointer;
        transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
      }
      nav button:hover {
        background: rgba(148,163,184,0.08);
        color: var(--text);
      }
      nav button.active {
        color: var(--text);
        border-color: rgba(56,189,248,0.45);
        background: rgba(56,189,248,0.12);
        box-shadow: inset 0 0 0 1px rgba(56,189,248,0.18);
      }
      .nav-icon {
        width: 18px;
        height: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: currentColor;
      }
      .nav-icon svg {
        width: 18px;
        height: 18px;
        stroke: currentColor;
      }
      header.app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 2rem 3rem 1rem;
        border-bottom: 1px solid rgba(148,163,184,0.16);
        background: linear-gradient(135deg, rgba(56,189,248,0.12), transparent);
        backdrop-filter: blur(8px);
      }
    .user-meta span {
      display: block;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .content { padding: 1.5rem 3rem 3rem; }
      .competency-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 0.5rem;
        align-items: flex-end;
      }
      .competency-toolbar label {
        display: block;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin-bottom: 0.35rem;
        text-align: center;
      }
    .competency-toolbar select {
      width: 180px;
    }
    .competency-toolbar[data-role="chart-toolbar"] {
      justify-content: flex-end;
      width: 100%;
    }
    .competency-toolbar[data-role="chart-toolbar"] label {
      font-size: 0.7rem;
    }
    .competency-toolbar[data-role="chart-toolbar"] select {
      width: 210px;
      padding: 0.32rem 0.7rem;
    }
    .account-checkboxes {
      border: 1px dashed rgba(56,189,248,0.4);
      border-radius: 12px;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      max-height: 220px;
      overflow-y: auto;
      background: rgba(56,189,248,0.05);
    }
            .account-checkboxes label {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.4rem;
      border-radius: 8px;
      background: rgba(37,99,235,0.04);
      text-align: left;
      cursor: pointer;
      width: 100%;
      min-height: 38px;
    }
    .account-checkboxes input[type="checkbox"] {
      appearance: auto;
      width: 16px;
      height: 16px;
      margin: 0;
      accent-color: var(--accent);
      flex-shrink: 0;
    }
    .account-checkboxes span {
      flex: 1;
      text-align: left;
      font-size: 0.9rem;
      color: var(--text);
    }
    .account-select-label {
      text-align: left;
    }
    .account-group-pill {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      background: rgba(37,99,235,0.08);
      border: 1px solid rgba(37,99,235,0.2);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      min-width: 260px;
    }
    .account-group-pill .association-field {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }
    .association-input {
      width: min(240px, 100%);
      padding: 0.45rem 0.6rem;
      font-size: 0.85rem;
    }
    .association-input.saved {
      border-color: rgba(74,222,128,0.6);
      color: var(--positive);
      background: rgba(74,222,128,0.08);
    }
    .account-group-pill strong {
      display: block;
      font-size: 1rem;
    }
    .account-group-accounts {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 0.25rem;
    }
    .account-card {
      max-width: 520px;
      margin: 0 auto;
      width: 100%;
    }
    .transaction-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
      align-items: flex-end;
    }
    .transaction-filters label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 0.2rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }
    .transaction-filters input,
    .transaction-filters select {
      min-width: 150px;
    }
    .grid {
      display: grid;
      gap: 1.25rem;
    }
    .contas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
      align-items: start;
      justify-items: start;
    }
    .contas-grid .account-card {
      max-width: none;
      margin: 0;
    }
    .grid.kpi {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      margin-bottom: 2rem;
    }
      .grid.highlights {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        margin-bottom: 1.25rem;
      }
      #highlight-grid {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
      }
    .highlight-row {
      display: grid;
      gap: 1.25rem;
    }
    .highlight-row.three {
      grid-template-columns: repeat(3, 1fr);
    }
    .highlight-row.four {
      grid-template-columns: repeat(4, 1fr);
    }
    .highlight-row .highlight-card {
      width: 100%;
    }
      .card {
        background: var(--card);
        border: var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 1.35rem 1.5rem;
        box-shadow: var(--shadow-sm), var(--shadow-inset);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .card:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md), var(--shadow-inset);
      }
      .highlight-card {
        background: linear-gradient(135deg, rgba(56,189,248,0.16), rgba(30,41,59,0.85));
        border-color: rgba(56,189,248,0.28);
        min-height: 120px;
        text-align: center;
      }
      .highlight-card .card-title {
        font-size: 0.85rem;
        font-weight: 700;
      }
      .highlight-card .card-value {
        font-size: 1.8rem;
        font-weight: 700;
      }
      .card-title {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--muted);
        margin-bottom: 0.4rem;
      }
      .card-value {
        font-size: 2rem;
        font-weight: 700;
      }
      .kpi-card {
        text-align: center;
      }
      .kpi-card[data-toggle] {
        cursor: pointer;
      }
      .kpi-card .card-title {
        font-size: 0.85rem;
        font-weight: 700;
      }
      .kpi-card .card-value {
        font-size: 2.1rem;
        font-weight: 700;
      }
      .highlight-group {
        transition: opacity 0.25s ease, transform 0.25s ease, max-height 0.3s ease;
        overflow: hidden;
        transform-origin: top;
        will-change: max-height, opacity, transform;
      }
      /* Receitas: sem afastamento extra nem divisoria do KPI */
      .highlight-group[data-group="receitas"]:not([hidden]) {
        margin-top: 0;
        padding-top: 0;
        border-top: 0;
      }
      /* Despesas: separador opcional para leitura */
      .highlight-group[data-group="despesas"]:not([hidden]) {
        margin-top: 0.5rem;
        padding-top: 0.75rem;
        border-top: 0;
      }
      .highlight-group[hidden] {
        display: block;
        max-height: 0;
        opacity: 0;
        transform: translateY(-6px);
        pointer-events: none;
        margin-top: 0;
        padding-top: 0;
        border-top: 0;
      }
      .highlight-group:not([hidden]) {
        max-height: 2000px;
        opacity: 1;
        transform: translateY(0);
      }
      .highlight-group .highlight-row + .highlight-row {
        margin-top: 1rem;
      }
      /* Ajusta o respiro interno das receitas para ficar alinhado ao bloco de despesas */
      .highlight-group[data-group="receitas"] .highlight-row {
        gap: 1rem;
      }
    .chart-wrapper {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      border: var(--border-subtle);
      box-shadow: var(--shadow-sm);
    }
    .chart-header {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      min-height: 48px;
      margin-bottom: 1rem;
    }
    .chart-header .competency-toolbar {
      margin-bottom: 0;
    }
    .chart-title {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 0.18em;
      color: var(--muted);
      margin-bottom: 0;
      white-space: nowrap;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 0.85rem;
      text-align: left;
      border-bottom: 1px solid rgba(148,163,184,0.15);
    }
    th {
      color: var(--muted);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.2rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .badge.receita { background: rgba(74,222,128,0.15); color: var(--positive); }
    .badge.despesa { background: rgba(248,113,113,0.15); color: var(--danger); }
    .badge.venda-recibo { background: rgba(74,222,128,0.18); color: var(--positive); }
    .badge.venda-nota { background: rgba(56,189,248,0.18); color: var(--accent); }
    .badge.ok { background: rgba(74,222,128,0.18); color: var(--positive); }
    .badge.neutral { background: rgba(148,163,184,0.2); color: var(--muted); }
    .form-grid { display: grid; gap: 1rem; }
    .two { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .vendas-import-grid {
      display: grid;
      gap: 1.25rem;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      margin-bottom: 1.5rem;
    }
    .conditional-field { display: none; }
    .conditional-field.active { display: block; }
    .lucro-options-title {
      display: block;
      margin-bottom: 0.35rem;
      font-weight: 600;
      color: var(--text);
    }
    .lucro-options {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .lucro-option {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.4rem 0.6rem;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.2);
      background: rgba(15,23,42,0.35);
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }
    .lucro-option:hover {
      border-color: rgba(56,189,248,0.6);
      background: rgba(56,189,248,0.08);
    }
    .lucro-option input {
      margin: 0;
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
      flex-shrink: 0;
    }
    .lucro-option span {
      font-weight: 600;
      color: var(--text);
      line-height: 1;
    }
    .iss-valor-field {
      margin-top: 0.75rem;
    }
    .toast {
      position: fixed;
      right: 2rem;
      bottom: 2rem;
      background: var(--card);
      border: 1px solid rgba(148,163,184,0.2);
      padding: 1rem 1.25rem;
      border-radius: 14px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    body.loading {
      cursor: progress;
    }
    body.loading::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.55);
      z-index: 999;
    }
    body.loading::after {
      content: "Processando...";
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: var(--card);
      border: var(--border-subtle);
      padding: 0.9rem 1.4rem;
      border-radius: 14px;
      box-shadow: var(--shadow-md);
      z-index: 1000;
      color: var(--text);
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .param-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.55rem 0.9rem;
      border-radius: 12px;
      border: 1px solid rgba(248,113,113,0.35);
      background: rgba(248,113,113,0.12);
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 600;
    }
    @media (max-width: 960px) {
      .app-shell { grid-template-columns: 1fr; }
      aside.sidebar {
        display: flex;
        overflow-x: auto;
        border-right: none;
        border-bottom: 1px solid rgba(148,163,184,0.2);
      }
      nav button { min-width: 180px; }
      header.app-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }
      .content { padding: 1.5rem; }
      .highlight-row.three,
      .highlight-row.four {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }
  
#role-label,
#clinic-label {
  display: none;
}</style>
</head>
<body>
  <section id="login-view" class="login-view">
    <div class="login-card">
      <img src="logo.png" alt="BPO Consult&#243;rios" style="max-width:220px;width:100%;height:auto;display:block;margin:0 auto 1rem">
      <form id="login-form">
        <label for="user">Usu&#225;rio</label>
        <input id="user" name="user" autocomplete="username" required>

        <label for="pass">Senha</label>
        <input id="pass" type="password" name="pass" autocomplete="current-password" required>

        <button class="btn" style="margin-top:1rem">Entrar</button>
      </form>
    </div>
  </section>

  <div id="login-image-loader" class="hidden" aria-hidden="true">
    <img
      class="login-image-loader__img"
      src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80'><circle cx='40' cy='40' r='28' stroke='%2338bdf8' stroke-opacity='0.25' stroke-width='6' fill='none'/><path d='M40%2012a28%2028%200%200%201%2028%2028' stroke='%2338bdf8' stroke-width='6' fill='none' stroke-linecap='round'><animateTransform attributeName='transform' type='rotate' from='0%2040%2040' to='360%2040%2040' dur='0.9s' repeatCount='indefinite'/></path></svg>"
      alt="Carregando">
  </div>

  <div id="dashboard" class="hidden app-shell">
      <aside class="sidebar">
        <div class="brand" id="company-brand">
          <div class="brand-logo" id="company-logo" aria-hidden="true">
            <img id="company-logo-img" alt="">
            <span id="company-logo-fallback">BO</span>
          </div>
          <div class="brand-body">
            <div class="brand-name" id="company-name">BPO Operacional</div>
            <select id="company-switcher" class="brand-select" data-role="admin-only"></select>
          </div>
        </div>
        <nav>
          <button data-section="overview" class="active">
            <span class="nav-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
                <rect x="3.5" y="3.5" width="7" height="7" rx="2"></rect>
                <rect x="13.5" y="3.5" width="7" height="7" rx="2"></rect>
                <rect x="3.5" y="13.5" width="7" height="7" rx="2"></rect>
                <rect x="13.5" y="13.5" width="7" height="7" rx="2"></rect>
              </svg>
            </span>
            <span>Vis&#227;o Geral</span>
          </button>
          <button data-section="indicadores">
            <span class="nav-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
                <path d="M4 19h16"></path>
                <rect x="6.5" y="10.5" width="3" height="6" rx="1"></rect>
                <rect x="11" y="7.5" width="3" height="9" rx="1"></rect>
                <rect x="15.5" y="5.5" width="3" height="11" rx="1"></rect>
              </svg>
            </span>
            <span>Indicadores</span>
          </button>
          <button data-section="transacoes" data-role="admin-only">
            <span class="nav-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
                <path d="M4 6h16"></path>
                <path d="M4 12h16"></path>
                <path d="M4 18h10"></path>
              </svg>
            </span>
            <span>Extrato</span>
          </button>
          <button data-section="vendas" data-role="admin-only">
            <span class="nav-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
                <path d="M4 16l5-5 4 4 7-7"></path>
                <path d="M16 8h4v4"></path>
              </svg>
            </span>
            <span>Vendas</span>
          </button>
          <button data-section="empresas" data-role="admin-only">
            <span class="nav-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
                <path d="M4 20V6a2 2 0 0 1 2-2h6v16"></path>
                <path d="M12 8h6a2 2 0 0 1 2 2v10"></path>
                <path d="M8 8h2"></path>
                <path d="M8 12h2"></path>
                <path d="M8 16h2"></path>
                <path d="M14 12h2"></path>
                <path d="M14 16h2"></path>
              </svg>
            </span>
            <span>Empresas</span>
          </button>
          <button data-section="contas" data-role="admin-only">
            <span class="nav-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
                <path d="M12 3l2 3h4l1 3-2 2 1 4-3 1-2 3-3-1-3 1-2-3-3-1 1-4-2-2 1-3h4l2-3z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </span>
            <span>Conta e Categoria</span>
          </button>
          <button data-section="usuarios" data-role="admin-only">
            <span class="nav-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
                <path d="M16 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"></path>
                <path d="M4 20a8 8 0 0 1 16 0"></path>
              </svg>
            </span>
            <span>Usuários</span>
          </button>
          
        </nav>
      </aside>

    <div>
      <header class="app-header">
        <div>
          <h2 id="welcome-text">Bom dia</h2>
          <div class="user-meta">
            <span id="role-label">Perfil: --</span>
            <span id="clinic-label"></span>
          </div>
        </div>
        <div style="display:flex;gap:0.75rem;align-items:center">
          <button id="theme-toggle" class="theme-toggle" type="button">Modo Claro</button>
          <button id="logout" class="btn-secondary" style="width:auto;padding-inline:1.5rem">Sair</button>
        </div>
      </header>

      <main class="content">
        <section id="overview-section">
          <div class="competency-toolbar" data-role="filter-toolbar">
            <div>
              <label for="filter-period">Per&#237;odo</label>
              <select id="filter-period"></select>
            </div>
            <div>
              <label for="filter-period-value">Refer&#234;ncia</label>
              <select id="filter-period-value"></select>
            </div>
            <div>
              <label for="filter-year">Ano</label>
              <select id="filter-year"></select>
            </div>
            <div>
              <label for="filter-account-group">GRUPO</label>
              <select id="filter-account-group"></select>
            </div>
          </div>
          <div class="grid highlights" id="highlight-grid"></div>
          <div class="grid kpi" id="kpi-grid"></div>

          <div class="grid" style="grid-template-columns: 1fr">
            <div class="chart-header">
              <div class="chart-title">PANORAMA FINANCEIRO</div>
              <div class="competency-toolbar" data-role="chart-toolbar">
                <div>
                  <label for="filter-chart-mode">PER&#205;ODO DO GR&#193;FICO</label>
                  <select id="filter-chart-mode"></select>
                </div>
                <div id="chart-year-filter">
                  <label for="filter-chart-year">Ano</label>
                  <select id="filter-chart-year"></select>
                </div>
              </div>
            </div>
            <div class="chart-wrapper">
              <canvas id="cashflowChart" height="70"></canvas>
            </div>
          </div>
        </section>

        <section id="indicadores-section" class="hidden">
          <div class="competency-toolbar" data-role="indicadores-toolbar">
            <div>
              <label for="indicadores-month">M&#234;s</label>
              <select id="indicadores-month"></select>
            </div>
            <div>
              <label for="indicadores-year">Ano</label>
              <select id="indicadores-year"></select>
            </div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin:1.25rem 0 1rem;gap:0.75rem;flex-wrap:wrap">
            <h3 style="font-size:1.6rem">Indicadores</h3>
          </div>
          <div class="grid kpi" id="indicadores-grid"></div>
        </section>

        <section id="transacoes-section" class="hidden" data-role="admin-only">
          <div class="card" data-role="admin-only" style="margin-bottom:1rem">
            <h3>Importar dados Conta Azul</h3>
            <p style="color:var(--muted)">Formatos aceitos: CSV padr&#227;o ou Extratos (.xls/.xlsx)</p>
            <input type="file" id="csvInput" accept=".csv,.xls,.xlsx">
            <button id="process-import" class="btn" style="margin-top:0.8rem">Processar</button>
          </div>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;gap:0.75rem;flex-wrap:wrap">
              <h3>Extrato de Movimenta&#231;&#245;es</h3>
              <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
                <button id="clear-transaction-filters" class="btn-secondary" style="width:auto;padding-inline:1.25rem">
                  Limpar filtros
                </button>
                <button id="delete-filtered-transactions" class="btn-secondary hidden" style="width:auto;padding-inline:1.25rem">
                  Excluir extrato filtrado
                </button>
              </div>
            </div>
            <form id="transaction-filter-form" class="transaction-filters">
              <div>
                <label for="filter-start-date">Data Inicial</label>
                <input type="date" id="filter-start-date" name="startDate">
              </div>
              <div>
                <label for="filter-end-date">Data Final</label>
                <input type="date" id="filter-end-date" name="endDate">
              </div>
              <div>
                <label for="filter-type">Tipo</label>
                <select id="filter-type" name="type">
                  <option value="all">Receitas e Despesas</option>
                  <option value="receita">Somente Receitas</option>
                  <option value="despesa">Somente Despesas</option>
                </select>
              </div>
              <div>
                <label for="filter-parametro">Par&#226;metro</label>
                <select id="filter-parametro" name="parametro">
                  <option value="all">Todos</option>
                </select>
              </div>
              <div style="min-width:220px;flex:1">
                <label for="filter-description">Descri&#231;&#227;o</label>
                <input type="text" id="filter-description" name="descriptionSearch" placeholder="Buscar descri&#231;&#227;o">
              </div>
            </form>
            <div id="missing-param-indicator" class="param-indicator hidden" style="margin:0.75rem 0 1rem"></div>
            <div style="overflow-x:auto">
              <table id="transaction-table">
                <thead>
                  <tr>
                    <th>Data</th><th>Conta</th><th>DESCRI&#199;&#195;O</th><th>CATEGORIA</th><th>PARAMETRO</th><th>Tipo</th><th>Valor</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="vendas-section" class="hidden" data-role="admin-only">
          <div class="vendas-import-grid">
            <div class="card">
              <h3>Importa&#231;&#227;o de Notas Fiscais</h3>
              <p style="color:var(--muted)">Formatos aceitos: .csv, .xls, .xlsx</p>
              <input type="file" id="vendas-notas-input" accept=".csv,.xls,.xlsx">
              <button id="importar-notas" class="btn" style="margin-top:0.8rem">Importar Notas Fiscais</button>
            </div>
            <div class="card">
              <h3>Importa&#231;&#227;o de Recibos</h3>
              <p style="color:var(--muted)">Formatos aceitos: .csv, .xls, .xlsx</p>
              <input type="file" id="vendas-recibos-input" accept=".csv,.xls,.xlsx">
              <button id="importar-recibos" class="btn" style="margin-top:0.8rem">Importar Recibos</button>
            </div>
          </div>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;gap:0.75rem;flex-wrap:wrap">
              <h3>Vendas Importadas</h3>
              <div style="display:flex;gap:0.6rem;flex-wrap:wrap">
                <button id="clear-vendas-filters" class="btn-secondary" style="width:auto;padding-inline:1.25rem">
                  Limpar filtros
                </button>
                <button id="delete-filtered-vendas" class="btn-secondary hidden" style="width:auto;padding-inline:1.25rem">
                  Excluir venda filtrada
                </button>
              </div>
            </div>
            <form id="vendas-filter-form" class="transaction-filters" style="margin-bottom:1rem">
              <div>
                <label for="vendas-filter-start-date">Data Inicial</label>
                <input type="date" id="vendas-filter-start-date" name="startDate">
              </div>
              <div>
                <label for="vendas-filter-end-date">Data Final</label>
                <input type="date" id="vendas-filter-end-date" name="endDate">
              </div>
              <div>
                <label for="vendas-filter-type">Tipo</label>
                <select id="vendas-filter-type" name="type">
                  <option value="all">Todos</option>
                  <option value="nota">Nota fiscal</option>
                  <option value="recibo">Recibo</option>
                </select>
              </div>
              <div style="min-width:220px;flex:1">
                <label for="vendas-filter-description">Descri&#231;&#227;o</label>
                <input type="text" id="vendas-filter-description" name="descriptionSearch" placeholder="Buscar descri&#231;&#227;o">
              </div>
            </form>
            <div style="overflow-x:auto">
                <table id="vendas-table">
                  <thead>
                    <tr>
                      <th>Tipo</th><th>Data</th><th>N&#250;mero</th><th>Paciente</th><th>Valor</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div id="vendas-pagination" style="display:flex;justify-content:space-between;align-items:center;margin-top:0.75rem;gap:0.75rem;flex-wrap:wrap">
                <div id="vendas-page-info" style="color:var(--muted);font-size:0.85rem">
                  Mostrando 0 – 0 de 0 registros
                </div>
                <div style="display:flex;align-items:center;gap:0.5rem">
                  <label style="font-size:0.85rem;color:var(--muted)">Por p&#225;gina</label>
                  <select id="vendas-page-size" style="width:90px">
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100" selected>100</option>
                  </select>
                  <button id="vendas-prev-page" class="btn-secondary" style="width:auto">Anterior</button>
                  <button id="vendas-next-page" class="btn-secondary" style="width:auto">Pr&#243;ximo</button>
                </div>
              </div>
            </div>
          </section>

        <section id="empresas-section" class="hidden" data-role="admin-only">
          <div class="card" style="margin-bottom:1.5rem">
            <h3>Cadastro de Empresa</h3>
            <form id="empresa-form" class="form-grid two" style="margin-top:1rem">
              <div>
                <label for="empresa-logo">Logo da Empresa</label>
                <input type="file" id="empresa-logo" name="empresaLogo" accept="image/*">
              </div>
              <div>
                <label for="empresa-nome">Nome da Empresa</label>
                <input id="empresa-nome" name="empresaNome" required>
              </div>
              <div>
                <label for="empresa-cnpj">CNPJ</label>
                <input id="empresa-cnpj" name="empresaCnpj" placeholder="00.000.000/0000-00" required>
              </div>
              <div>
                <label for="empresa-livro">Possui Livro Caixa?</label>
                <select id="empresa-livro" name="empresaLivro">
                  <option value="sim">Sim</option>
                  <option value="nao">Não</option>
                </select>
              </div>
              <div>
                <label for="empresa-regime">Regime Tribut&#225;rio</label>
                <select id="empresa-regime" name="empresaRegime" required>
                  <option value="">Selecione</option>
                  <option value="simples_nacional">Simples Nacional</option>
                  <option value="lucro_presumido">Lucro Presumido</option>
                </select>
              </div>
              <div id="empresa-simples-fields" class="hidden">
                <label for="empresa-simples-anexo">Anexo</label>
                <select id="empresa-simples-anexo" name="empresaSimplesAnexo">
                  <option value="">Selecione</option>
                  <option value="III">Anexo III</option>
                  <option value="V">Anexo V</option>
                </select>
              </div>
              <div id="empresa-lucro-fields" class="hidden">
                <span class="lucro-options-title">Op&#231;&#245;es do Lucro Presumido</span>
                <div class="lucro-options">
                  <label class="lucro-option">
                    <input type="checkbox" id="empresa-aliquota-hospitalar" name="empresaAliquotaHospitalar">
                    <span>Al&#237;quota Hospitalar</span>
                  </label>
                  <label class="lucro-option">
                    <input type="checkbox" id="empresa-iss-fixo" name="empresaIssFixo">
                    <span>ISS Fixo</span>
                  </label>
                </div>
                <div id="empresa-iss-aliquota-field" class="conditional-field iss-aliquota-field">
                  <label for="empresa-iss-aliquota">Al&#237;quota do ISS (%)</label>
                  <input type="number" id="empresa-iss-aliquota" name="empresaIssAliquota" min="0" max="100" step="0.01" inputmode="decimal">
                </div>
                <div id="empresa-iss-valor-field" class="conditional-field iss-valor-field">
                  <label for="empresa-iss-valor">Valor do ISS Fixo (R$)</label>
                  <input type="number" id="empresa-iss-valor" name="empresaIssValor" min="0" step="0.01" inputmode="decimal">
                </div>
              </div>
              <div style="grid-column:1 / -1">
                <button class="btn" type="submit">Cadastrar Empresa</button>
              </div>
            </form>
          </div>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;gap:0.75rem;flex-wrap:wrap">
              <h3>Empresas Cadastradas</h3>
            </div>
            <div style="overflow-x:auto">
              <table id="empresas-table">
                <thead>
                  <tr>
                    <th>Logo</th><th>Nome da Empresa</th><th>CNPJ</th><th>Livro Caixa</th><th>Regime Tribut&#225;rio</th><th>Detalhe</th><th>A&#231;&#245;es</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="contas-section" class="hidden">
          <div class="contas-grid">
            <div class="card account-card">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap">
              <div>
                <h3>Contas Banc&#225;rio</h3>
                <p style="color:var(--muted);margin:0"></p>
              </div>
            </div>
            <form id="account-group-form" class="form-grid" style="margin-top:1rem">
              <input name="groupName" placeholder="Nome do grupo banc&#225;rio" required>
              <div>
                <label class="account-select-label" style="display:block;margin-bottom:0.35rem;font-weight:600">Selecione as contas</label>
                <div id="account-checkboxes" class="account-checkboxes"></div>
              </div>
              <div>
                <label style="font-weight:600;margin-bottom:0.35rem;display:block">
                  Vínculo com Vendas
                </label>
                <div class="account-checkboxes">
                  <label>
                    <input type="checkbox" name="vendasTipo" value="recibo" checked>
                    <span>Recibos</span>
                  </label>
                  <label>
                    <input type="checkbox" name="vendasTipo" value="nota" checked>
                    <span>Notas Fiscais</span>
                  </label>
                </div>
              </div>
              <button class="btn">Criar Grupo</button>
            </form>
            <div id="account-group-list" style="margin-top:1rem;display:flex;flex-wrap:wrap;gap:0.75rem"></div>
          </div>
            <div class="card account-card">
            <div>
              <h3>Parametriza&#231;&#227;o de Categorias</h3>
              <p style="color:var(--muted);margin:0"></p>
            </div>
<div style="margin-top:1.25rem">
              <h4 style="margin:0 0 0.5rem 0">Categorias Financeira</h4>
              <form id="dashboard-category-form" class="form-grid two">
                <input name="dashboardCategoryName" placeholder="Nova Categoria" required>
                <button class="btn">Adicionar Categoria</button>
              </form>
              <div id="dashboard-category-list" style="margin-top:1rem;display:flex;flex-direction:column;gap:0.5rem"></div>
            </div>
            <div id="category-mapping-list" style="margin-top:1.25rem;display:flex;flex-direction:column;gap:0.75rem"></div>
            </div>
          </div>
        </section>

        <section id="usuarios-section" class="hidden" data-role="admin-only">
          <div class="card" style="margin-bottom:1.5rem">
            <h3>Cadastro de Usuários</h3>
            <form id="user-form" class="form-grid two" style="margin-top:1rem">
              <div>
                <label for="user-name">Nome completo</label>
                <input id="user-name" name="userName" required>
              </div>
              <div>
                <label for="user-username">Usuário (login)</label>
                <input id="user-username" name="userUsername" required>
              </div>
              <div>
                <label for="user-password">Senha</label>
                <input id="user-password" name="userPassword" type="password" required>
              </div>
              <div>
                <label for="user-role">Tipo de Usuário</label>
                <select id="user-role" name="userRole" required>
                  <option value="admin">BPO / Equipe</option>
                  <option value="client">Cliente</option>
                </select>
              </div>
              <div id="user-company-field" class="conditional-field">
                <label for="user-company">Empresa vinculada</label>
                <select id="user-company" name="userCompany"></select>
              </div>
              <div style="grid-column:1 / -1">
                <button class="btn" type="submit">Cadastrar Usuário</button>
              </div>
            </form>
          </div>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;gap:0.75rem;flex-wrap:wrap">
              <h3>Usuários Cadastrados</h3>
            </div>
            <div style="overflow-x:auto">
              <table id="users-table">
                <thead>
                  <tr>
                    <th>Nome</th><th>Usuário</th><th>Tipo</th><th>Empresa</th><th>Status</th><th>Ações</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      getFirestore, collection, collectionGroup, doc, getDocs, getDoc,
      addDoc, setDoc, updateDoc, deleteDoc, query, where, orderBy, limit, startAfter, writeBatch, onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

    // Configuracao
    const firebaseConfig = {
      apiKey: "AIzaSyD1xgUIFG_9Xfs3VYj5Vw8ZNptaKaw5vM0",
      authDomain: "maxxi-dashboard.firebaseapp.com",
      projectId: "maxxi-dashboard",
      storageBucket: "maxxi-dashboard.appspot.com",
      messagingSenderId: "298804235038",
      appId: "1:298804235038:web:1ceb30a39249edb12b570f"
    };

    // Inicializacao
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const secondaryApp = initializeApp(firebaseConfig, "secondary");
    const secondaryAuth = getAuth(secondaryApp);

    // Disponibiliza globalmente para o dashboard
    window.firebaseConfig = firebaseConfig;
    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.db = db;
    window.storage = storage;
    window.firebaseReady = Promise.resolve({
      app,
      auth,
      db,
      storage,
      secondaryAuth,
      authFns: { signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword },
      fns: {
        collection,
        collectionGroup,
        doc,
        getDocs,
        getDoc,
        addDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        query,
        where,
        orderBy,
        limit,
        startAfter,
        writeBatch,
        onSnapshot,
        ref,
        uploadBytes,
        getDownloadURL,
        deleteObject
      }
    });
  </script>

  <script>
    let users = [];

    let clinics = [];

    let categories = [];
    let categoryItems = [];
    let accountRegistry = [];
    const accountRegistrySet = new Set();
    let accountGroups = [];
    let empresas = [];
    const DEFAULT_VENDAS_TIPOS = ["recibo", "nota"];
    const DEFAULT_DASHBOARD_CATEGORIES = [
      "1.1.1 - Esp\u00e9cie",
      "1.1.2 - Cheques",
      "1.1.3 - Pix ou TED",
      "1.1.4 - Cart\u00e3o de D\u00e9bito",
      "1.1.5 - Cart\u00e3o de Cr\u00e9dito",
      "1.1.6 - Boleto",
      "1.1.7 - Receitas a Identificar",
      "1.1.99 - Outras Receitas Operacionais",
      "1.2.1 - Rendimentos e Estornos",
      "1.2.2 - Conta Virtual - Antecipac\u00f5es",
      "1.2.99 - Outras Receitas Financeiras",
      "1.3.1 - Descontos e Ressarcimentos",
      "1.3.2 - Despesas na Venda de M\u00e1quinas e Equip.",
      "1.3.3 - Venda de M\u00e1quinas e Equipamentos",
      "1.3.4 - Aporte de s\u00f3cios",
      "1.3.5 - Estorno de Pagamentos",
      "1.3.6 - Estorno de Pacientes",
      "1.3.99 - Outras Receitas N\u00e3o Operacionais",
      "2.1.1 - Simples Nacional (DAS)",
      "2.1.2 - ISS",
      "2.1.3 - PIS",
      "2.1.4 - COFINS",
      "2.1.5 - IRPJ",
      "2.1.6 - CSLL",
      "2.1.7 - ICMS",
      "2.1.8 - IOF",
      "2.1.9 - IPTU",
      "2.1.10 - Outros Impostos",
      "2.2.1 - Material para Procedimentos",
      "2.2.2 - Material Hospitalar",
      "2.2.3 - Manuten\u00e7\u00e3o de Equipamento",
      "2.2.4 - Enfermeiro Coleta Sangue",
      "2.2.5 - Seguro de Equipamento",
      "2.2.6 - Administradora de Im\u00f3veis",
      "2.2.99 - Outros Custos Operacionais",
      "2.3.1 - Brindes",
      "2.3.2 - Ag\u00eancias de Publicidade",
      "2.3.3 - Material Publicit\u00e1rio",
      "2.3.4 - Impulsionamento Digital",
      "2.3.5 - Eventos",
      "2.3.6 - Servi\u00e7os de Foto e V\u00eddeo",
      "2.3.99 - Outras Despesas de Marketing",
      "2.4.1 - Retiradas de S\u00f3cios",
      "2.4.2 - Pr\u00f3-labore",
      "2.4.3 - Pr\u00eamios e B\u00f4nus",
      "2.4.4 - Sal\u00e1rios",
      "2.4.5 - Comiss\u00f5es",
      "2.4.6 - Insalubridade",
      "2.4.7 - Vale-Alimenta\u00e7\u00e3o",
      "2.4.8 - Vale-Transporte",
      "2.4.9 - Seguro Sa\u00fade e Dental",
      "2.4.10 - FGTS",
      "2.4.11 - F\u00e9rias",
      "2.4.12 - 13o Sal\u00e1rio",
      "2.4.13 - Contribui\u00e7\u00e3o Sindical",
      "2.4.14 - INSS",
      "2.4.15 - INSS Patronal",
      "2.4.16 - IRRF",
      "2.4.17 - Rescis\u00f5es",
      "2.4.18 - Cursos e Treinamentos",
      "2.4.19 - PCMSO Funcion\u00e1rios",
      "2.4.20 - Coparticipa\u00e7\u00e3o Planos Sa\u00fade",
      "2.4.99 - Outras Despesas com Pessoal",
      "2.5.1 - Aluguel",
      "2.5.2 - Energia El\u00e9trica",
      "2.5.3 - Telefonia e Internet",
      "2.5.4 - Dedetiza\u00e7\u00e3o",
      "2.5.5 - Manuten\u00e7\u00f5es",
      "2.5.6 - Softwares e Aplicativos",
      "2.5.7 - Certificados Digitais",
      "2.5.8 - Honor\u00e1rios Cont\u00e1beis",
      "2.5.9 - Honor\u00e1rios Advocat\u00edcios",
      "2.5.10 - Consultorias",
      "2.5.11 - Materiais de Escrit\u00f3rio",
      "2.5.12 - Supermercados",
      "2.5.13 - Taxas e Emolumentos",
      "2.5.14 - Seguros",
      "2.5.15 - Lavanderia",
      "2.5.16 - Despesas com Frete",
      "2.5.17 - Sociedades e Conselhos de Classe",
      "2.5.18 - Servi\u00e7o de Limpeza",
      "2.5.19 - Outras Despesas com Im\u00f3vel",
      "2.5.20 - Despesas a Identificar",
      "2.5.21 - Honor\u00e1rios BPO Financeiro",
      "2.5.99 - Outras Despesas Administrativas",
      "2.6.1 - Tarifas Banc\u00e1rias",
      "2.6.2 - Manuten\u00e7\u00e3o da Conta Corrente",
      "2.6.3 - Juros da Conta Corrente",
      "2.6.4 - Taxa de Cart\u00e3o",
      "2.6.5 - Taxa de Antecipac\u00e3o do Cart\u00e3o",
      "2.6.6 - Aluguel de M\u00e1quina de Cart\u00e3o",
      "2.6.7 - Conta Virtual - Acerto",
      "2.6.99 - Outras Despesas Financeiras",
      "2.7.1 - M\u00e1quinas e Equipamentos",
      "2.7.2 - Instala\u00e7\u00f5es",
      "2.7.3 - Equipamentos de Inform\u00e1tica",
      "2.7.4 - M\u00f3veis e Utens\u00edlios Administrativos",
      "2.7.5 - Ve\u00edculos",
      "2.7.99 - Outras Despesas com Ativos",
      "2.8.1 - Empr\u00e9stimos",
      "2.8.2 - Compra",
      "2.8.3 - Empr\u00e9stimo Pessoal"
    ];
    const DASHBOARD_ASSOCIATION_OPTIONS = [
      "PIX / Dinheiro / Transferencias",
      "Cartao de Credito e Debito",
      "Aportes e Outras Receitas",
      "Despesa Fixa",
      "Despesas Diversas",
      "Impostos",
      "Investimento",
      "Custo com Marketing",
      "Custo de Equipe",
      "Custo de Insumos",
      "Retiradas"
    ];
    let dashboardCategories = [];
    let categoryMappings = [];

    // Dataset imutavel (NUNCA filtrar diretamente)
    let allTransactions = [];

    // Dataset apenas para renderizacao do Extrato
    let filteredTransactions = [];
    let currentPage = 1;
    let pageSize = 100;
    let vendas = [];
    let vendasCurrentPage = 1;
    let vendasPageSize = 100;
    let vendasFiltered = [];

    const MONTHS_NAMES = [
      "Janeiro", "Fevereiro", "Mar o", "Abril", "Maio", "Junho",
      "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
    ];
    const QUARTER_LABELS = [
      { value: "1", label: "1  Trimestre" },
      { value: "2", label: "2  Trimestre" },
      { value: "3", label: "3  Trimestre" },
      { value: "4", label: "4  Trimestre" }
    ];
    const SEMESTER_LABELS = [
      { value: "1", label: "1  Semestre" },
      { value: "2", label: "2  Semestre" }
    ];
    const PERIOD_TYPE_OPTIONS = [
      { value: "month", label: "Mensal" },
      { value: "quarter", label: "Trimestral" },
      { value: "semester", label: "Semestral" }
    ];

    function getPreviousMonthSelection(baseDate = new Date()) {
      const reference = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
      reference.setMonth(reference.getMonth() - 1);
      return {
        periodValue: String(reference.getMonth() + 1).padStart(2, "0"),
        year: String(reference.getFullYear())
      };
    }

    function getIndicadoresDefaultPeriod(baseDate = new Date()) {
      const reference = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
      reference.setMonth(reference.getMonth() - 1);
      return {
        month: String(reference.getMonth() + 1),
        year: String(reference.getFullYear())
      };
    }

    const defaultOverviewPeriod = getPreviousMonthSelection();

    const overviewHighlights = [
      { id: "pixDinheiroTransferencias", label: "PIX / Dinheiro / Transferencias", color: "var(--positive)", calc: (agg) => getAggregateParametroTotal(agg, "PIX / Dinheiro / Transferencias") },
      { id: "cartoes", label: "Cartao de Credito e Debito", color: "var(--positive)", calc: (agg) => getAggregateParametroTotal(agg, "Cartao de Credito e Debito") },
      { id: "aportes", label: "Aportes e Outras Receitas", color: "var(--positive)", calc: (agg) => getAggregateParametroTotal(agg, "Aportes e Outras Receitas") },
      { id: "despesaFixa", label: "Despesa Fixa", color: "var(--danger)", calc: (agg) => getAggregateParametroTotal(agg, "Despesa Fixa") },
      { id: "despesasDiversas", label: "Despesas Diversas", color: "var(--danger)", calc: (agg) => getAggregateParametroTotal(agg, "Despesas Diversas") },
      { id: "impostos", label: "Impostos", color: "var(--danger)", calc: (agg) => getAggregateParametroTotal(agg, "Impostos") },
      { id: "investimentos", label: "Investimento", color: "var(--danger)", calc: (agg) => getAggregateParametroTotal(agg, "Investimento") },
      { id: "insumos", label: "Custo de Insumos", color: "var(--danger)", calc: (agg) => getAggregateParametroTotal(agg, "Custo de Insumos") },
      { id: "marketing", label: "Custo com Marketing", color: "var(--danger)", calc: (agg) => getAggregateParametroTotal(agg, "Custo com Marketing") },
      { id: "equipe", label: "Custo de Equipe", color: "var(--danger)", calc: (agg) => getAggregateParametroTotal(agg, "Custo de Equipe") },
      { id: "retiradas", label: "Retiradas", color: "var(--danger)", calc: (agg) => getAggregateParametroTotal(agg, "Retiradas") }
    ];

    const THEME_STORAGE_KEY = "dashboard_theme";
    const VALID_THEMES = ["dark", "light"];

    const state = {
      user: null,
      chartCashflow: null,
      companyScopeId: "",
      // Filtros EXCLUSIVOS da Visao Geral
      overviewFilters: {
        periodType: "month",
        periodValue: defaultOverviewPeriod.periodValue,
        year: defaultOverviewPeriod.year,
        accountGroup: "all"
      },
      // Filtros EXCLUSIVOS dos Indicadores
      indicadoresFilters: {
        month: "",
        year: ""
      },
      overviewChartFilters: {
        mode: "last12",
        year: String(new Date().getFullYear())
      },
      // Filtros EXCLUSIVOS do Extrato
      transactionFilters: {
        start: "",
        end: "",
        month: "",
        year: "",
        type: "all",
        parametro: "all",
        descriptionSearch: ""
      },
      vendasFilters: {
        start: "",
        end: "",
        type: "all",
        descriptionSearch: ""
      },
      theme: "dark"
    };
    window.state = state;
    let overviewDefaultApplied = false;
    let indicadoresFiltersInitialized = false;
    const highlightToggleState = { receitas: false, despesas: false };
    const TRANSACTION_PAGE_SIZE = 100;
    const AGGREGATE_PAGE_SIZE = 500;
    // Cache pages and aggregates per company/period to avoid refetching and heavy recomputes.
    const transactionCache = new Map();
    const transactionAggregateCache = new Map();
    const transactionState = {
      key: "",
      pageIndex: 0,
      loading: false,
      aggregateToken: 0,
      snapshotKey: "",
      snapshotReady: false,
      unsubscribe: null
    };


      const qs = (sel) => document.querySelector(sel);
      const qsa = (sel) => [...document.querySelectorAll(sel)];
      const escapeAttribute = (value = "") =>
        value
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/"/g, "&quot;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    const escapeHtml = (value = "") => escapeAttribute(value);
      const readFileAsDataUrl = (file) =>
      new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error("file_read_failed"));
        reader.readAsDataURL(file);
      });

    const debounce = (fn, delay = 300) => {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
      };
    };

    async function getFirebase() {
      if (!window.firebaseReady) {
        throw new Error("firebase_not_ready");
      }
      return window.firebaseReady;
    }

    function normalizeUserProfile(data = {}, id = "") {
      return {
        id,
        name: data.name || "",
        username: data.username || "",
        role: data.role || "client",
        companyId: data.companyId || "",
        clinicId: data.companyId || "",
        active: data.active !== false
      };
    }

    function mapCompanyRecord(data, id) {
      return {
        id,
        nome: data.name || "",
        cnpj: data.cnpj || "",
        livroCaixa: data.hasLivroCaixa === true,
        logoUrl: data.logoUrl || "",
        regimeTributario: data.regimeTributario || "",
        simplesAnexo: data.simplesAnexo || "",
        aliquotaHospitalar: data.aliquotaHospitalar === true,
        issFixo: data.issFixo === true,
        issValor: Number(data.issValor) || 0,
        issAliquota: Number(data.issAliquota) || 0
      };
    }

    function mapTransactionRecord(data, id) {
      const category = data.category || "";
      const resolvedParametro = resolveParametro(category) || "";
      return {
        id,
        clinicId: data.companyId || "",
        type: data.type || "",
        category,
        description: data.description || data.category || "",
        parametro: data.parametro || resolvedParametro,
        amount: Number(data.amount) || 0,
        date: data.date || "",
        year: Number(data.year) || null,
        month: Number(data.month) || null,
        paymentMethod: data.paymentMethod || "",
        expenseGroup: data.expenseGroup || "",
        accountName: data.accountName || ""
      };
    }

    function mapVendaRecord(data, id) {
      return {
        id,
        clinicId: data.companyId || "",
        tipo: data.tipo || "",
        numero: data.numero || "",
        paciente: data.paciente || "",
        valor: Number(data.valor) || 0,
        data: data.data || ""
      };
    }

    function resetAccountRegistry() {
      accountRegistry = [];
      accountRegistrySet.clear();
    }

    function registerAccount(name) {
      if (!name) return;
      const trimmed = name.trim();
      if (!trimmed || accountRegistrySet.has(trimmed)) return;
      accountRegistrySet.add(trimmed);
      accountRegistry.push(trimmed);
    }

    function registerAccountsFromTransactions(items) {
      if (!Array.isArray(items)) return;
      items.forEach((t) => registerAccount(t.accountName));
    }

    async function loadUsers(profile) {
      if (!profile) return;
      const { db, fns } = await getFirebase();
      const { collection, getDocs } = fns;
      if (profile.role !== "admin") {
        users = [profile];
        return;
      }
      const snap = await getDocs(collection(db, "users"));
      users = snap.docs.map((docSnap) => normalizeUserProfile(docSnap.data(), docSnap.id));
    }

    async function loadCompanies(profile) {
      if (!profile) return;
      const { db, fns } = await getFirebase();
      const { collection, getDocs, doc, getDoc, query, where } = fns;
      if (profile.role === "admin") {
        const snap = await getDocs(collection(db, "companies"));
        empresas = snap.docs.map((docSnap) => mapCompanyRecord(docSnap.data(), docSnap.id));
      } else if (profile.companyId) {
        const companySnap = await getDoc(doc(db, "companies", profile.companyId));
        empresas = companySnap.exists() ? [mapCompanyRecord(companySnap.data(), companySnap.id)] : [];
      } else {
        empresas = [];
      }
      clinics = empresas.map((empresa) => ({ id: empresa.id, name: empresa.nome }));
      if (profile.role === "admin") {
        const companyIds = empresas.map((empresa) => empresa.id);
        state.companyScopeId = companyIds.includes(state.companyScopeId)
          ? state.companyScopeId
          : (companyIds[0] || "");
      } else {
        state.companyScopeId = profile.companyId || profile.clinicId || "";
      }
    }

    async function ensureCompanyByName(name) {
      const trimmed = (name || "").trim();
      if (!trimmed) return "";
      const existing = clinics.find((clinic) => clinic.name === trimmed);
      if (existing) return existing.id;
      const { db, fns } = await getFirebase();
      const { collection, doc, setDoc } = fns;
      const ref = doc(collection(db, "companies"));
      await setDoc(ref, {
        id: ref.id,
        name: trimmed,
        cnpj: "",
        hasLivroCaixa: false,
        logoUrl: "",
        regimeTributario: "",
        simplesAnexo: "",
        aliquotaHospitalar: false,
        issFixo: false,
        issValor: 0,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
      await loadCompanies(state.user);
      return ref.id;
    }

    async function loadCategories() {
      const { db, fns } = await getFirebase();
      const { getDocs } = fns;
      const companyId = resolveScopedCompanyId();
      if (!companyId) {
        categoryItems = [];
        categories = [];
        return;
      }
      const snap = await getDocs(getCompanyCollectionRef(db, fns, companyId, "categories"));
      categoryItems = snap.docs
        .map((docSnap) => ({ id: docSnap.id, name: docSnap.data().name || "" }))
        .filter((item) => item.name);
      categories = categoryItems.map((item) => item.name);
    }

    async function createCategory(name, companyIdOverride) {
      const trimmed = name.trim();
      if (!trimmed) return;
      if (categories.includes(trimmed)) return;
      const { db, fns } = await getFirebase();
      const { doc, setDoc } = fns;
      const companyId = companyIdOverride || resolveScopedCompanyId();
      if (!companyId) return;
      const ref = doc(getCompanyCollectionRef(db, fns, companyId, "categories"));
      await setDoc(ref, { id: ref.id, name: trimmed });
      await loadCategories();
    }

    async function deleteCategoryByName(name) {
      const item = categoryItems.find((cat) => cat.name === name);
      if (!item) return;
      const { db, fns } = await getFirebase();
      const companyId = resolveScopedCompanyId();
      if (!companyId) return;
      await fns.deleteDoc(fns.doc(db, "companies", companyId, "categories", item.id));
      await loadCategories();
    }

    async function removeCategory(name) {
      if (!name) return;
      try {
        await deleteCategoryByName(name);
        renderCategoryMappings();
        renderCategoryTags();
      } catch (error) {
        console.error(error);
        showToast("Falha ao remover categoria.", "error");
      }
    }

    async function ensureDashboardCategories() {
      const { db, fns } = await getFirebase();
      const { doc, getDocs, setDoc, writeBatch } = fns;
      const companyId = resolveScopedCompanyId();
      if (!companyId) {
        dashboardCategories = [];
        return;
      }
      const collectionRef = getCompanyCollectionRef(db, fns, companyId, "dashboardCategories");
      const snap = await getDocs(collectionRef);
      if (!snap.empty) {
        dashboardCategories = snap.docs.map((docSnap) => ({
          id: docSnap.id,
          name: docSnap.data().name || "",
          accountingName: docSnap.data().accountingName || ""
        }));
        return;
      }
      const batch = writeBatch(db);
      DEFAULT_DASHBOARD_CATEGORIES.forEach((name) => {
        const ref = doc(collectionRef);
        batch.set(ref, { id: ref.id, name, accountingName: "" });
      });
      await batch.commit();
      const seeded = await getDocs(collectionRef);
      dashboardCategories = seeded.docs.map((docSnap) => ({
        id: docSnap.id,
        name: docSnap.data().name || "",
        accountingName: docSnap.data().accountingName || ""
      }));
    }

    async function loadCategoryMappings() {
      const { db, fns } = await getFirebase();
      const { getDocs } = fns;
      const companyId = resolveScopedCompanyId();
      if (!companyId) {
        categoryMappings = [];
        return;
      }
      const snap = await getDocs(getCompanyCollectionRef(db, fns, companyId, "categoryMappings"));
      categoryMappings = snap.docs.map((docSnap) => ({
        id: docSnap.id,
        source: docSnap.data().source || "",
        targetId: docSnap.data().targetId || "",
        parametro: docSnap.data().parametro || ""
      }));
    }

    function normalizeVendasTipoValue(value) {
      const normalized = normalizeText(value);
      if (!normalized) return "";
      if (normalized.includes("recibo")) return "recibo";
      if (normalized.includes("nota")) return "nota";
      return normalized;
    }

    function normalizeVendasTipos(value) {
      if (!Array.isArray(value)) return [...DEFAULT_VENDAS_TIPOS];
      const normalized = value
        .map((tipo) => normalizeVendasTipoValue(tipo))
        .filter(Boolean);
      return normalized.length ? normalized : [...DEFAULT_VENDAS_TIPOS];
    }

    async function loadAccountGroups() {
      const { db, fns } = await getFirebase();
      const { getDocs } = fns;
      const companyId = resolveScopedCompanyId();
      if (!companyId) {
        accountGroups = [];
        return;
      }
      const snap = await getDocs(getCompanyCollectionRef(db, fns, companyId, "accountGroups"));
      accountGroups = snap.docs.map((docSnap) => ({
        id: docSnap.id,
        name: docSnap.data().name || "",
        accounts: Array.isArray(docSnap.data().accounts) ? docSnap.data().accounts : [],
        vendasTipos: normalizeVendasTipos(docSnap.data().vendasTipos)
      }));
    }

    function resolveCompanyIdFilter() {
      if (!state.user) return "";
      if (state.user.role !== "admin") return state.user.companyId || state.user.clinicId || "";
      return state.companyScopeId || "";
    }

    function resolveScopedCompanyId() {
      if (!state.user) return "";
      if (state.user.role !== "admin") return state.user.companyId || state.user.clinicId || "";
      const selected = getActiveCompanyId();
      if (selected) return selected;
      if (clinics.length === 1) return clinics[0].id;
      if (empresas.length === 1) return empresas[0].id;
      return "";
    }

    function getCompanyCollectionRef(db, fns, companyId, collectionName) {
      return fns.collection(db, "companies", companyId, collectionName);
    }

    function normalizeDateRange(value, isEnd) {
      if (!value) return null;
      const date = parseDateInput(value);
      if (Number.isNaN(date.getTime())) return null;
      if (isEnd) {
        date.setHours(23, 59, 59, 999);
      } else {
        date.setHours(0, 0, 0, 0);
      }
      return date;
    }

    function normalizeFilterDate(value) {
      if (!value) return null;
      const date = parseDateInput(value);
      if (Number.isNaN(date.getTime())) return null;
      date.setHours(0, 0, 0, 0);
      return date;
    }

    function resolveTransactionFilters() {
      return {
        companyId: resolveCompanyIdFilter()
      };
    }

    function resolveTransactionDeleteFilters() {
      const { start, end, type } = state.transactionFilters;
      return {
        companyId: resolveCompanyIdFilter(),
        type: type !== "all" ? type : null,
        startDate: normalizeDateRange(start, false),
        endDate: normalizeDateRange(end, true)
      };
    }

    function getTransactionCacheKey(filters = resolveTransactionFilters()) {
      const company = filters.companyId || "all";
      const year = filters.year || "all";
      const period = filters.month
        ? `m${filters.month}`
        : filters.monthRange
          ? `r${filters.monthRange.start}-${filters.monthRange.end}`
          : "all";
      return `${company}_${year}_${period}`;
    }

    function ensureTransactionCacheEntry(key) {
      if (!transactionCache.has(key)) {
        transactionCache.set(key, { pages: [], lastDocs: [], hasMore: true });
      }
      return transactionCache.get(key);
    }

    function buildTransactionsQuery(filters, options = {}) {
      return getFirebase().then(({ db, fns }) => {
        const { collection, collectionGroup, query, where, orderBy, limit, startAfter } = fns;
        const baseCollection = filters.companyId
          ? collection(db, "companies", filters.companyId, "transactions")
          : collectionGroup(db, "transactions");
        const constraints = [baseCollection];
        if (filters.year) constraints.push(where("year", "==", filters.year));
        if (filters.month) {
          constraints.push(where("month", "==", filters.month));
        } else if (filters.monthRange) {
          constraints.push(where("month", ">=", filters.monthRange.start));
          constraints.push(where("month", "<=", filters.monthRange.end));
        }
        if (filters.type) constraints.push(where("type", "==", filters.type));
        if (filters.startDate) constraints.push(where("date", ">=", filters.startDate));
        if (filters.endDate) constraints.push(where("date", "<=", filters.endDate));
        constraints.push(orderBy("date", "desc"));
        if (options.startAfterDoc) constraints.push(startAfter(options.startAfterDoc));
        if (options.limit) constraints.push(limit(options.limit));
        return query(...constraints);
      });
    }

    function buildTransactionsListenerQuery(filters) {
      return getFirebase().then(({ db, fns }) => {
        const { collection, collectionGroup, query } = fns;
        const baseCollection = filters.companyId
          ? collection(db, "companies", filters.companyId, "transactions")
          : collectionGroup(db, "transactions");
        return query(baseCollection);
      });
    }

    function stopTransactionListener() {
      if (transactionState.unsubscribe) {
        transactionState.unsubscribe();
        transactionState.unsubscribe = null;
      }
      transactionState.snapshotKey = "";
      transactionState.snapshotReady = false;
    }

    async function ensureTransactionListener(filters) {
      if (!state.user) return;
      const listenerKey = filters.companyId || "all";
      if (transactionState.snapshotKey === listenerKey) return;
      stopTransactionListener();
      transactionState.snapshotKey = listenerKey;
      transactionState.snapshotReady = false;
      const { fns } = await getFirebase();
      const q = await buildTransactionsListenerQuery(filters);
      transactionState.unsubscribe = fns.onSnapshot(
        q,
        (snap) => {
          if (!transactionState.snapshotReady) {
            transactionState.snapshotReady = true;
            return;
          }
          if (!snap.docChanges().length) return;
          invalidateTransactionCache();
          debouncedRealtimeRefresh();
        },
        (error) => {
          console.error("Falha no listener de lancamentos.", error);
        }
      );
    }

    async function loadTransactionsPage(filters, pageIndex) {
      if (!state.user) return;
      const key = transactionState.key || getTransactionCacheKey(filters);
      transactionState.key = key;
      const cacheEntry = ensureTransactionCacheEntry(key);
      if (cacheEntry.pages[pageIndex]) {
        allTransactions = cacheEntry.pages[pageIndex];
        populateParametroFilter(allTransactions);
        return;
      }
      if (transactionState.loading) return;
      transactionState.loading = true;
      try {
        const startAfterDoc = pageIndex > 0 ? cacheEntry.lastDocs[pageIndex - 1] : null;
        const q = await buildTransactionsQuery(filters, {
          startAfterDoc,
          limit: TRANSACTION_PAGE_SIZE
        });
        const { fns } = await getFirebase();
        const snap = await fns.getDocs(q);
        const items = snap.docs.map((docSnap) => mapTransactionRecord(docSnap.data(), docSnap.id));
        cacheEntry.pages[pageIndex] = items;
        cacheEntry.lastDocs[pageIndex] = snap.docs[snap.docs.length - 1] || null;
        cacheEntry.hasMore = snap.docs.length === TRANSACTION_PAGE_SIZE;
        allTransactions = items;
        console.table(
          allTransactions.map((t) => ({
            descricao: t.description,
            parametro: t.parametro
          }))
        );
        populateParametroFilter(allTransactions);
        registerAccountsFromTransactions(items);
      } catch (error) {
        console.error("Falha ao carregar transacoes.", error);
        allTransactions = [];
        cacheEntry.pages[pageIndex] = [];
      } finally {
        transactionState.loading = false;
      }
    }

    function flattenTransactionCache(cacheEntry) {
      return cacheEntry.pages.flat();
    }

    async function loadAllTransactions(filters) {
      if (!state.user) return;
      const key = transactionState.key || getTransactionCacheKey(filters);
      transactionState.key = key;
      const cacheEntry = ensureTransactionCacheEntry(key);
      if (!cacheEntry.hasMore && cacheEntry.pages.length) {
        allTransactions = flattenTransactionCache(cacheEntry);
        populateParametroFilter(allTransactions);
        registerAccountsFromTransactions(allTransactions);
        return;
      }
      if (transactionState.loading) return;
      transactionState.loading = true;
      try {
        let pageIndex = 0;
        let startAfterDoc = null;
        cacheEntry.pages = [];
        cacheEntry.lastDocs = [];
        cacheEntry.hasMore = true;
        while (cacheEntry.hasMore) {
          const q = await buildTransactionsQuery(filters, {
            startAfterDoc,
            limit: TRANSACTION_PAGE_SIZE
          });
          const { fns } = await getFirebase();
          const snap = await fns.getDocs(q);
          const items = snap.docs.map((docSnap) => mapTransactionRecord(docSnap.data(), docSnap.id));
          cacheEntry.pages[pageIndex] = items;
          cacheEntry.lastDocs[pageIndex] = snap.docs[snap.docs.length - 1] || null;
          cacheEntry.hasMore = snap.docs.length === TRANSACTION_PAGE_SIZE;
          startAfterDoc = cacheEntry.lastDocs[pageIndex];
          pageIndex += 1;
          await new Promise((resolve) => setTimeout(resolve, 0));
        }
        allTransactions = flattenTransactionCache(cacheEntry);
        populateParametroFilter(allTransactions);
        registerAccountsFromTransactions(allTransactions);
      } catch (error) {
        console.error("Falha ao carregar todas as transacoes.", error);
        allTransactions = [];
        cacheEntry.pages = [];
        cacheEntry.lastDocs = [];
        cacheEntry.hasMore = true;
      } finally {
        transactionState.loading = false;
      }
    }

    async function loadTransactions(profile) {
      if (!profile) return;
      const filters = resolveTransactionFilters();
      const key = getTransactionCacheKey(filters);
      if (transactionState.key !== key) {
        transactionState.key = key;
        transactionState.pageIndex = 0;
      }
      await loadAllTransactions(filters);
    }

    async function loadVendas(profile) {
      if (!profile) return;
      try {
        const { db, fns } = await getFirebase();
        const { collection, collectionGroup, getDocs, query, where } = fns;
        const companyId = resolveScopedCompanyId();
        let snap;
        if (companyId) {
          snap = await getDocs(collection(db, "companies", companyId, "vendas"));
        } else if (profile.role === "admin") {
          snap = await getDocs(collectionGroup(db, "vendas"));
        } else if (profile.companyId) {
          const collectionRef = collectionGroup(db, "vendas");
          snap = await getDocs(query(collectionRef, where("companyId", "==", profile.companyId)));
        } else {
          vendas = [];
          return;
        }
        vendas = snap.docs.map((docSnap) => mapVendaRecord(docSnap.data(), docSnap.id));
      } catch (error) {
        console.error("Falha ao carregar vendas.", error);
        vendas = [];
      }
    }

    async function loadAllData(profile) {
      try {
        await loadCompanies(profile);
      } catch (error) {
        console.error("Falha ao carregar empresas.", error);
        empresas = [];
        clinics = [];
        state.companyScopeId = profile?.companyId || profile?.clinicId || "";
      }
      const results = await Promise.allSettled([
        loadUsers(profile),
        loadCategories(),
        ensureDashboardCategories(),
        loadCategoryMappings(),
        loadAccountGroups(),
        loadVendas(profile)
      ]);
      const rejected = results.filter((result) => result.status === "rejected");
      if (rejected.length) {
        console.error("Falha ao carregar dados iniciais.", rejected);
      }
    }

    async function refreshCompanyScopedData() {
      if (!state.user) return;
      await Promise.all([
        loadCategories(),
        ensureDashboardCategories(),
        loadCategoryMappings(),
        loadAccountGroups(),
        loadVendas(state.user)
      ]);
      refreshUI();
    }

      function setLoading(isLoading) {
        document.body.classList.toggle("loading", isLoading);
      }

    function invalidateTransactionCache() {
      transactionCache.clear();
      transactionAggregateCache.clear();
      transactionState.key = "";
      transactionState.pageIndex = 0;
      transactionState.aggregateToken += 1;
      allTransactions = [];
      filteredTransactions = [];
      resetAccountRegistry();
    }

    function getCurrentTransactionsPage() {
      return allTransactions;
    }

      function getAggregateForCurrentFilters() {
        const key = getTransactionCacheKey();
        return transactionAggregateCache.get(key)?.data || null;
      }

      function setupHighlightToggles() {
        const kpiGrid = qs("#kpi-grid");
        const highlightGrid = qs("#highlight-grid");
        if (!kpiGrid || !highlightGrid) return;
        if (kpiGrid.dataset.toggleBound === "true") return;
        kpiGrid.addEventListener("click", (event) => {
          const toggleCard = event.target.closest("[data-toggle]");
          if (!toggleCard || !kpiGrid.contains(toggleCard)) return;
          const groupName = toggleCard.dataset.toggle;
          if (!groupName) return;
          const group = highlightGrid.querySelector(`[data-group="${groupName}"]`);
          if (!group) return;
          const willShow = group.hasAttribute("hidden");
          group.toggleAttribute("hidden");
          highlightToggleState[groupName] = willShow;
          toggleCard.setAttribute("aria-expanded", willShow ? "true" : "false");
        });
        kpiGrid.dataset.toggleBound = "true";
      }

    async function addDashboardCategory(name) {
      const trimmed = name.trim();
      if (!trimmed) return null;
      const exists = dashboardCategories.find((cat) => cat.name.toLowerCase() === trimmed.toLowerCase());
      if (exists) return exists.id;
      const { db, fns } = await getFirebase();
      const { doc, setDoc } = fns;
      const companyId = resolveScopedCompanyId();
      if (!companyId) return null;
      const ref = doc(getCompanyCollectionRef(db, fns, companyId, "dashboardCategories"));
      await setDoc(ref, { id: ref.id, name: trimmed, accountingName: "" });
      await ensureDashboardCategories();
      return ref.id;
    }

    function getDashboardCategoryName(id) {
      return dashboardCategories.find((cat) => cat.id === id)?.name ?? id;
    }

    function findCategoryMapping(category) {
      if (!categoryMappings.length) return null;
      const exact = categoryMappings.find((map) => map.source === category);
      if (exact) return exact;
      const normalized = normalizeText(category);
      if (!normalized) return null;
      return categoryMappings.find((map) => normalizeText(map.source) === normalized) || null;
    }

    function resolveCategory(category) {
      if (!categoryMappings.length) return category;
      const match = findCategoryMapping(category);
      return match ? getDashboardCategoryName(match.targetId) : category;
    }

    function resolveParametro(category) {
      const mapping = findCategoryMapping(category);
      if (mapping) return mapping.parametro || null;
      const normalized = normalizeText(category);
      if (!normalized) return null;
      const direct = dashboardCategories.find((cat) => normalizeText(cat.name) === normalized);
      return direct?.accountingName || null;
    }

    function createAggregateSeed() {
      return {
        byParametro: {},
        byType: { receita: 0, despesa: 0 },
        byMonth: {},
        byTypeDays: {
          receita: { sum: 0, count: 0 },
          despesa: { sum: 0, count: 0 }
        }
      };
    }

    function aggregateTransactions(transactions) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      return transactions.reduce((acc, t) => {
        if (!t) return acc;
        const amount = Number(t.amount) || 0;
        const resolvedParametro = (t.parametro || resolveParametro(t.category) || "").trim() || "Sem parametro";
        acc.byParametro[resolvedParametro] = (acc.byParametro[resolvedParametro] || 0) + amount;
        if (t.type === "receita" || t.type === "despesa") {
          acc.byType[t.type] += amount;
        }
        const date = parseDateInput(t.date);
        if (!Number.isNaN(date.getTime())) {
          const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
          if (!acc.byMonth[key]) acc.byMonth[key] = { receita: 0, despesa: 0 };
          if (t.type === "receita" || t.type === "despesa") {
            acc.byMonth[key][t.type] += amount;
            const days = Math.round((today - date) / 86400000);
            acc.byTypeDays[t.type].sum += days;
            acc.byTypeDays[t.type].count += 1;
          }
        }
        return acc;
      }, createAggregateSeed());
    }

    function mergeAggregates(base, extra) {
      if (!extra) return base;
      Object.entries(extra.byParametro || {}).forEach(([key, value]) => {
        base.byParametro[key] = (base.byParametro[key] || 0) + value;
      });
      Object.entries(extra.byType || {}).forEach(([key, value]) => {
        base.byType[key] = (base.byType[key] || 0) + value;
      });
      Object.entries(extra.byMonth || {}).forEach(([key, value]) => {
        if (!base.byMonth[key]) base.byMonth[key] = { receita: 0, despesa: 0 };
        base.byMonth[key].receita += value.receita || 0;
        base.byMonth[key].despesa += value.despesa || 0;
      });
      Object.entries(extra.byTypeDays || {}).forEach(([key, value]) => {
        if (!base.byTypeDays[key]) base.byTypeDays[key] = { sum: 0, count: 0 };
        base.byTypeDays[key].sum += value.sum || 0;
        base.byTypeDays[key].count += value.count || 0;
      });
      return base;
    }

    function getAggregateParametroTotal(agg, parametro) {
      return agg?.byParametro?.[parametro] ?? 0;
    }

    function getTotalByType(agg, type) {
      if (agg?.byType && Number.isFinite(agg.byType[type])) return agg.byType[type];
      return Object.values(agg || {})
        .filter((item) => item && item.type === type)
        .reduce((sum, item) => sum + (Number(item.total) || 0), 0);
    }

    function calcPercentual(valor, totalBase) {
      if (!totalBase || totalBase <= 0) return 0;
      return (valor / totalBase) * 100;
    }

    function sumReceitasPorParametro(agg) {
      const parametros = [
        "PIX / Dinheiro / Transferencias",
        "Cartao de Credito e Debito",
        "Aportes e Outras Receitas"
      ];
      return parametros.reduce((acc, key) => acc + getAggregateParametroTotal(agg, key), 0);
    }

    function sumDespesasPorParametro(agg) {
      const parametros = [
        "Despesa Fixa",
        "Despesas Diversas",
        "Impostos",
        "Investimento",
        "Custo com Marketing",
        "Custo de Equipe",
        "Custo de Insumos",
        "Retiradas"
      ];
      return parametros.reduce((acc, key) => acc + getAggregateParametroTotal(agg, key), 0);
    }

    const normalizeText = (value = "") => {
      if (value === null || value === undefined) return "";
      return value
        .toString()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();
    };
    function normalizeType(value) {
      if (!value) return "";
      return value.toString().trim().toLowerCase();
    }
    function normalizeParametro(value) {
      if (!value) return "";
      return value
        .toString()
        .trim()
        .toLowerCase()
        .replace(/\s+/g, " ");
    }
    function normalizeHeader(text = "") {
      return text
        .toString()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();
    }

    function populateParametroFilter(transactions) {
      const select = document.getElementById("filter-parametro");
      if (!select) return;

      const map = new Map();

      transactions.forEach((t) => {
        if (!t.parametro) return;

        const original = t.parametro.toString().trim();
        if (!original) return;

        const normalized = normalizeParametro(original);

        // Evita duplicacao mantendo o texto original
        if (!map.has(normalized)) {
          map.set(normalized, original);
        }
      });

      const options = Array.from(map.entries()).sort((a, b) =>
        a[1].localeCompare(b[1], "pt-BR")
      );

      select.innerHTML =
        `<option value="all">Todos</option>` +
        options
          .map(
            ([value, label]) =>
              `<option value="${escapeAttribute(value)}">${escapeHtml(label)}</option>`
          )
          .join("");
    }

    function findColumn(headers, possibilities) {
      return headers.find((h) =>
        possibilities.some((p) => normalizeHeader(h).includes(p))
      );
    }

    function formatIsoLocal(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function formatIsoUTC(date) {
      const year = date.getUTCFullYear();
      const month = String(date.getUTCMonth() + 1).padStart(2, "0");
      const day = String(date.getUTCDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function parseBrazilianDate(value) {
      if (value === null || value === undefined || value === "") return "";
      if (value instanceof Date) return formatIsoLocal(value);
      if (typeof value === "number" && Number.isFinite(value)) {
        const excelEpoch = Date.UTC(1899, 11, 30);
        const millis = Math.round((value - Math.floor(value)) * 86400000);
        const date = new Date(excelEpoch + Math.floor(value) * 86400000 + millis);
        return formatIsoUTC(date);
      }
      const text = value.toString().trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(text)) return text;
      const parts = text.split(/[\/]/);
      if (parts.length === 3) {
        const day = parts[0];
        const month = parts[1];
        const year = parts[2];
        const iso = `${year.padStart(4, "0")}-${month.padStart(2, "0")}-${day.padStart(2, "0")}`;
        if (!Number.isNaN(new Date(iso))) return iso;
      }
      const parsed = new Date(text);
      if (!Number.isNaN(parsed.getTime())) return formatIsoLocal(parsed);
      return "";
    }

    function parseNFDateSafe(value) {
      if (!value) return "";
      if (value instanceof Date) {
        return value.toISOString().slice(0, 10);
      }
      if (typeof value === "number" && Number.isFinite(value)) {
        const excelEpoch = Date.UTC(1899, 11, 30);
        const date = new Date(excelEpoch + Math.floor(value) * 86400000);
        return date.toISOString().slice(0, 10);
      }
      let text = value.toString().trim();
      if (text.includes(" ")) {
        text = text.split(" ")[0];
      }
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(text)) {
        const [day, month, year] = text.split("/");
        return `${year}-${month}-${day}`;
      }
      const parsed = new Date(text);
      if (!Number.isNaN(parsed.getTime())) {
        return parsed.toISOString().slice(0, 10);
      }
      return "";
    }

    function getRowCellByIndex(row, headers, index) {
      if (!row) return undefined;
      if (Array.isArray(row)) return row[index];
      if (!Array.isArray(headers) || index < 0 || index >= headers.length) return undefined;
      const header = headers[index];
      if (header === undefined || header === null) return undefined;
      return row[header];
    }

    function resolveDataNotaFiscal(row, headers) {
      return parseNFDateSafe(getRowCellByIndex(row, headers, 64));
    }

    function parseExtratoAmount(value) {
      if (typeof value === "number") return value;
      if (!value) return NaN;
      let text = value.toString().trim();
      const isNegative = /^-/.test(text) || (text.includes("(") && text.includes(")"));
      text = text.replace(/[-()R$\s]/gi, "").replace(/\./g, "").replace(",", ".");
      const amount = Number(text);
      if (!Number.isFinite(amount)) return NaN;
      return isNegative ? -amount : amount;
    }

    function parseNotaFiscalValor(raw) {
      if (raw === null || raw === undefined || raw === "") return 0;

      // XLS / XLSX: já vem como número correto
      if (typeof raw === "number" && Number.isFinite(raw)) {
        return raw;
      }

      let text = raw.toString().trim();

      // Remove moeda e espaços
      text = text.replace(/R\$/gi, "").replace(/\s/g, "");

      // CSV simples: 1200, 800
      if (/^\d+$/.test(text)) {
        return Number(text);
      }

      // Formato PT-BR completo: 1.200,00
      if (/^\d{1,3}(\.\d{3})*,\d{2}$/.test(text)) {
        return Number(text.replace(/\./g, "").replace(",", "."));
      }

      // Formato: 800,00
      if (/^\d+,\d{2}$/.test(text)) {
        return Number(text.replace(",", "."));
      }

      // Fallback seguro
      const n = Number(text);
      return Number.isFinite(n) ? n : 0;
    }

    function mapExtratoType(text) {
      const normalized = normalizeText(text);
      if (normalized.includes("credito")) return "receita";
      if (normalized.includes("debito")) return "despesa";
      return null;
    }

    function mapPaymentMethod(label = "") {
      const normalized = normalizeText(label);
      if (!normalized) return "";
      if (normalized.includes("pix")) return "pix";
      if (normalized.includes("dinheiro") || normalized.includes("cash")) return "dinheiro";
      if (normalized.includes("transfer")) return "transferencia";
      if (normalized.includes("debito")) return "cartao_debito";
      if (normalized.includes("credito")) return "cartao_credito";
      if (normalized.includes("aporte")) return "aporte";
      return "outras";
    }

    function inferExpenseGroup(text = "") {
      const normalized = normalizeText(text);
      if (!normalized) return "despesas_diversas";
      if (/(insumo|material|medic|equipamento)/.test(normalized)) return "insumos";
      if (/(retirada|pro labore|prolabore|distribuicao)/.test(normalized)) return "retiradas";
      if (/(impost|taxa|gps|fgts|inss|iss|ir)/.test(normalized)) return "impostos";
      if (/(marketing|trafego|anuncio|ads|google|facebook|instagram|meta)/.test(normalized)) return "marketing";
      if (/(salario|folha|estagi|equipe|colaborador|funcionar|honorario)/.test(normalized)) return "equipe";
      if (/(aluguel|energia|luz|agua|internet|telefone|manutencao|contrato)/.test(normalized)) return "despesa_fixa";
      return "despesas_diversas";
    }

    function showToast(message, type = "info") {
      const toast = qs("#toast");
      toast.textContent = message;
      toast.style.borderColor = type === "error" ? "rgba(248,113,113,0.6)" : "rgba(56,189,248,0.5)";
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3200);
    }

    function initializeTheme() {
      const saved = localStorage.getItem(THEME_STORAGE_KEY);
      const theme = VALID_THEMES.includes(saved) ? saved : "dark";
      applyTheme(theme);
    }

    function applyTheme(theme) {
      state.theme = theme;
      document.body.classList.toggle("theme-light", theme === "light");
      localStorage.setItem(THEME_STORAGE_KEY, theme);
      updateThemeToggleLabel();
      if (state.user) {
        updateDashboard();
      }
    }

    function toggleTheme() {
      const next = state.theme === "light" ? "dark" : "light";
      applyTheme(next);
    }

    function updateThemeToggleLabel() {
      const toggle = qs("#theme-toggle");
      if (!toggle) return;
      toggle.textContent = state.theme === "light" ? "Modo Escuro" : "Modo Claro";
    }

    function getThemeColor(variable) {
      return getComputedStyle(document.body).getPropertyValue(variable)?.trim();
    }

    function getGreetingByHour(date = new Date()) {
      const hour = date.getHours();
      if (hour >= 5 && hour < 12) return "Bom dia";
      if (hour >= 12 && hour < 18) return "Boa tarde";
      return "Boa noite";
    }
    async function handleLogin(evt) {
      evt.preventDefault();
      const form = evt.target;
      const email = form.user.value.trim();
      const password = form.pass.value.trim();
      if (!email || !password) {
        showToast("Preencha usuario e senha.", "error");
        return;
      }
      const loginImageLoader = document.getElementById("login-image-loader");
      if (loginImageLoader) loginImageLoader.classList.remove("hidden");
      try {
        const { auth, db, authFns, fns } = await getFirebase();
        const cred = await authFns.signInWithEmailAndPassword(auth, email, password);
        const profileSnap = await fns.getDoc(fns.doc(db, "users", cred.user.uid));
        if (!profileSnap.exists()) {
          await authFns.signOut(auth);
          showToast("Perfil nao encontrado.", "error");
          return;
        }
        const profile = normalizeUserProfile(profileSnap.data(), profileSnap.id);
        if (!profile.active) {
          await authFns.signOut(auth);
          showToast("Usuario inativo.", "error");
          return;
        }
        state.user = profile;
        await loadAllData(profile);
        invalidateTransactionCache();
        try {
          await refreshTransactionsAndDashboard();
        } catch (error) {
          console.error("Falha ao carregar transacoes iniciais.", error);
        }
        qs("#login-view").classList.add("hidden");
        qs("#dashboard").classList.remove("hidden");
        const greeting = getGreetingByHour();
        qs("#welcome-text").textContent = `${greeting}, ${profile.name || "Usuario"}`;
        qs("#role-label").textContent = profile.role === "admin" ? "Administrador" : "Cliente";
        const clinic = clinics.find((c) => c.id === profile.companyId);
        qs("#clinic-label").textContent = clinic ? `Consultorio: ${clinic.name}` : "";
        refreshUI();
        showToast("Login realizado com sucesso!");
      } catch (err) {
        console.error(err);
        showToast("Usuario ou senha invalidos.", "error");
      } finally {
        const loader = document.getElementById("login-image-loader");
        if (loader) loader.classList.add("hidden");
      }
    }

    function refreshUI() {
      toggleAdminSections();
      populateSelects();
      renderAccountGroupFilter();
      populateCompanySwitcher();
      renderCompanyBrand();
      applyOverviewDefaultPeriod();
      populateCompetencySelectors();
      populateOverviewChartFilters();
      updateDashboard();
      applyTransactionFilters();
      renderVendas();
      renderEmpresas();
      renderUsers();
      renderCategoryTags();
      renderAccountGroups();
      renderAccountOptions();
      renderMappingSourceOptions();
      renderDashboardCategories();
      renderCategoryMappings();
      syncTransactionFiltersUI();
      syncVendasFiltersUI();
      updateUserFormType();
      updateFilteredDeleteButton();
    }

    function applyOverviewDefaultPeriod() {
      if (overviewDefaultApplied) return;
      const previous = getPreviousMonthSelection();
      state.overviewFilters.periodType = "month";
      state.overviewFilters.periodValue = previous.periodValue;
      state.overviewFilters.year = previous.year;
      overviewDefaultApplied = true;
    }

    function toggleAdminSections() {
      const isAdmin = state.user.role === "admin";
      qsa("[data-role='admin-only']").forEach((node) => {
        if (node.tagName === "SECTION") {
          if (!isAdmin) node.classList.add("hidden");
          return;
        }
        node.classList.toggle("hidden", !isAdmin);
      });
    }

    function populateSelects() {
      const select = qs("#transaction-form select[name='clinic']");
      if (!select) return;
      select.innerHTML = clinics.map((c) => `<option value="${c.id}">${c.name}</option>`).join("");
    }

    function getPeriodValueOptions(periodType) {
      if (periodType === "quarter") return QUARTER_LABELS;
      if (periodType === "semester") return SEMESTER_LABELS;
      return MONTHS_NAMES.map((name, idx) => ({
        value: String(idx + 1).padStart(2, "0"),
        label: name
      }));
    }

    function getPeriodValueLabel(periodType) {
      if (periodType === "quarter") return "Trimestre";
      if (periodType === "semester") return "Semestre";
      return "M\u00eas";
    }

    function populatePeriodValueSelect(selectEl) {
      const periodType = state.overviewFilters.periodType;
      const options = getPeriodValueOptions(periodType);
      const validValues = options.map((opt) => opt.value);
      const sanitizedValue = (state.overviewFilters.periodValue === "all" || validValues.includes(state.overviewFilters.periodValue))
        ? state.overviewFilters.periodValue
        : "all";
      state.overviewFilters.periodValue = sanitizedValue || "all";
      const allLabel = periodType === "quarter"
        ? "Todos os trimestres"
        : (periodType === "semester" ? "Todos os semestres" : "Todos os meses");
      const optionHtml = ['<option value="all">' + allLabel + "</option>"]
        .concat(options.map((opt) => {
          const selected = state.overviewFilters.periodValue === opt.value ? "selected" : "";
          return `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
        }));
      selectEl.innerHTML = optionHtml.join("");
      selectEl.value = state.overviewFilters.periodValue;

      const label = qs("label[for='filter-period-value']");
      if (label) label.textContent = getPeriodValueLabel(periodType);
    }

    function populateCompetencySelectors() {
      const periodSelect = qs("#filter-period");
      const periodValueSelect = qs("#filter-period-value");
      const yearSelect = qs("#filter-year");
      if (!periodSelect || !periodValueSelect || !yearSelect) return;

      const validTypes = PERIOD_TYPE_OPTIONS.map((opt) => opt.value);
      const sanitizedType = validTypes.includes(state.overviewFilters.periodType)
        ? state.overviewFilters.periodType
        : "month";
      state.overviewFilters.periodType = sanitizedType;
      periodSelect.innerHTML = PERIOD_TYPE_OPTIONS
        .map((opt) => `<option value="${opt.value}">${opt.label}</option>`)
        .join("");
      periodSelect.value = state.overviewFilters.periodType;

      populatePeriodValueSelect(periodValueSelect);

      const currentYear = new Date().getFullYear();
      const years = Array.from({ length: 6 }, (_, idx) => currentYear - idx);
      const selectedYear = Number(state.overviewFilters.year);
      if (Number.isFinite(selectedYear) && !years.includes(selectedYear)) {
        years.unshift(selectedYear);
      }
      const sanitizedYear = (state.overviewFilters.year === "all" || years.includes(Number(state.overviewFilters.year)))
        ? state.overviewFilters.year
        : "all";
      state.overviewFilters.year = sanitizedYear || "all";
      const yearOptions = ['<option value="all">Todos os anos</option>']
        .concat(years.map((year) => {
          const selected = state.overviewFilters.year === String(year) ? "selected" : "";
          return `<option value="${year}" ${selected}>${year}</option>`;
        }));
      yearSelect.innerHTML = yearOptions.join("");
      yearSelect.value = state.overviewFilters.year;
    }

    function getChartAvailableYears() {
      const years = new Set();
      (allTransactions || []).forEach((t) => {
        const date = parseDateInput(t.date);
        if (!Number.isNaN(date.getTime())) years.add(date.getFullYear());
      });
      const sorted = [...years].sort((a, b) => b - a);
      if (!sorted.length) sorted.push(new Date().getFullYear());
      return sorted;
    }

    function updateChartYearVisibility() {
      const wrap = qs("#chart-year-filter");
      if (!wrap) return;
      wrap.classList.toggle("hidden", state.overviewChartFilters.mode !== "year");
    }

    function populateOverviewChartFilters() {
      const modeSelect = qs("#filter-chart-mode");
      const yearSelect = qs("#filter-chart-year");
      if (!modeSelect || !yearSelect) return;
      const modeOptions = [
        { value: "last12", label: "Ultimos 12 meses" },
        { value: "year", label: "Por ano" }
      ];
      const validModes = modeOptions.map((opt) => opt.value);
      const sanitizedMode = validModes.includes(state.overviewChartFilters.mode)
        ? state.overviewChartFilters.mode
        : "last12";
      state.overviewChartFilters.mode = sanitizedMode;
      modeSelect.innerHTML = modeOptions
        .map((opt) => `<option value="${opt.value}">${opt.label}</option>`)
        .join("");
      modeSelect.value = state.overviewChartFilters.mode;

      const years = getChartAvailableYears();
      if (!years.includes(Number(state.overviewChartFilters.year))) {
        state.overviewChartFilters.year = String(years[0]);
      }
      yearSelect.innerHTML = years
        .map((year) => {
          const selected = state.overviewChartFilters.year === String(year) ? "selected" : "";
          return `<option value="${year}" ${selected}>${year}</option>`;
        })
        .join("");
      yearSelect.value = state.overviewChartFilters.year;
      updateChartYearVisibility();
    }

    function getChartRange() {
      const now = new Date();
      if (state.overviewChartFilters.mode === "year") {
        const year = Number(state.overviewChartFilters.year);
        const start = new Date(year, 0, 1);
        const end = new Date(year, 11, 31, 23, 59, 59, 999);
        return { start, end };
      }
      const start = new Date(now.getFullYear(), now.getMonth() - 11, 1);
      const end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
      return { start, end };
    }

    function getChartMonthLabels(start, end) {
      const labels = [];
      const cursor = new Date(start.getFullYear(), start.getMonth(), 1);
      while (cursor <= end) {
        labels.push(`${cursor.getFullYear()}-${String(cursor.getMonth() + 1).padStart(2, "0")}`);
        cursor.setMonth(cursor.getMonth() + 1);
      }
      return labels;
    }

    function getChartTransactions() {
      const { start, end } = getChartRange();
      const filtered = filterTransactionsUntilToday(allTransactions || []);
      return filtered.filter((t) => {
        const date = parseDateInput(t.date);
        if (Number.isNaN(date.getTime())) return false;
        return date >= start && date <= end;
      });
    }

    function aggregateChartVendasByMonth(rangeStart, rangeEnd) {
      const byMonth = {};
      getVisibleVendas().forEach((item) => {
        const d = parseDateInput(item.data);
        if (Number.isNaN(d.getTime())) return;
        if (d < rangeStart || d > rangeEnd) return;
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
        byMonth[key] = (byMonth[key] ?? 0) + (Number(item.valor) || 0);
      });
      return byMonth;
    }

    function renderAccountGroupFilter() {
      const select = qs("#filter-account-group");
      if (!select) return;
      select.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "all";
      allOpt.textContent = "Todos os Grupos";
      select.appendChild(allOpt);
      accountGroups.forEach((group) => {
        const opt = document.createElement("option");
        opt.value = group.id;
        opt.textContent = group.name;
        select.appendChild(opt);
      });
      const fallback = state.overviewFilters.accountGroup || "all";
      const hasGroup = accountGroups.some((group) => group.id === fallback);
      state.overviewFilters.accountGroup = hasGroup ? fallback : "all";
      select.value = state.overviewFilters.accountGroup;
    }

    function aggregateChartTotalsByMonth(transactions, labels) {
      const receitaParametros = new Set([
        "PIX / Dinheiro / Transferencias",
        "Cartao de Credito e Debito",
        "Aportes e Outras Receitas"
      ]);
      const despesaParametros = new Set([
        "Despesa Fixa",
        "Despesas Diversas",
        "Impostos",
        "Investimento",
        "Custo com Marketing",
        "Custo de Equipe",
        "Custo de Insumos",
        "Retiradas"
      ]);
      const labelSet = new Set(labels);
      const byMonth = {};
      transactions.forEach((t) => {
        if (!t) return;
        const date = parseDateInput(t.date);
        if (Number.isNaN(date.getTime())) return;
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
        if (!labelSet.has(key)) return;
        const parametro = (t.parametro || resolveParametro(t.category) || "").trim();
        const amount = Number(t.amount) || 0;
        if (!byMonth[key]) byMonth[key] = { receita: 0, despesa: 0 };
        if (t.type === "receita" && receitaParametros.has(parametro)) {
          byMonth[key].receita += amount;
        } else if (t.type === "despesa" && despesaParametros.has(parametro)) {
          byMonth[key].despesa += amount;
        }
      });
      return {
        revenue: labels.map((label) => byMonth[label]?.receita ?? 0),
        expense: labels.map((label) => byMonth[label]?.despesa ?? 0)
      };
    }

    function resolveSelectedAccountGroup() {
      const groupId = state.overviewFilters.accountGroup;
      if (!groupId || groupId === "all") return null;
      return accountGroups.find((group) => group.id === groupId) || null;
    }

    function vendaPermitidaParaGrupo(venda, grupo) {
      if (!grupo) return true;
      const tipos = normalizeVendasTipos(grupo.vendasTipos);
      const vendaTipo = normalizeVendaTipo(venda?.tipo ?? "");
      return tipos.includes(vendaTipo);
    }

    function applyAccountGroupFilterToVendas(data) {
      const group = resolveSelectedAccountGroup();
      if (!group) return data;
      return data.filter((item) => vendaPermitidaParaGrupo(item, group));
    }

    function getActiveCompanyId() {
      if (!state.user) return "";
      if (state.user.role !== "admin") return state.user.companyId || state.user.clinicId || "";
      if (state.companyScopeId) return state.companyScopeId;
      return empresas[0]?.id || "";
    }

    function resolveImportCompanyId() {
      if (!state.user) return "";
      if (state.user.role !== "admin") return state.user.companyId || state.user.clinicId || "";
      return getActiveCompanyId();
    }

    function getCompanyInitials(name) {
      const trimmed = (name || "").trim();
      if (!trimmed) return "BO";
      const parts = trimmed.split(/\s+/).filter(Boolean);
      const initials = parts.slice(0, 2).map((part) => part[0]).join("").toUpperCase();
      return initials || "BO";
    }

    function renderCompanyBrand() {
      const nameEl = qs("#company-name");
      const logoWrap = qs("#company-logo");
      const logoImg = qs("#company-logo-img");
      const logoFallback = qs("#company-logo-fallback");
      if (!nameEl || !logoWrap || !logoImg || !logoFallback) return;
      let displayName = "BPO Operacional";
      let logoUrl = "";
      const activeId = getActiveCompanyId();
      const activeCompany = activeId ? empresas.find((empresa) => empresa.id === activeId) : null;
      if (activeCompany) {
        displayName = activeCompany.nome || displayName;
        logoUrl = activeCompany.logoUrl || "";
      } else if (state.user?.role === "admin" && state.companyScopeId) {
        displayName = "Empresa nao encontrada";
      } else if (state.user) {
        displayName = "Empresa nao vinculada";
      }
      nameEl.textContent = displayName || "BPO Operacional";
      logoImg.alt = displayName ? `Logo ${displayName}` : "Logo da empresa";
      if (logoUrl) {
        logoImg.src = logoUrl;
        logoWrap.classList.add("has-image");
      } else {
        logoImg.removeAttribute("src");
        logoWrap.classList.remove("has-image");
      }
      logoFallback.textContent = getCompanyInitials(displayName);
    }

    function populateCompanySwitcher() {
      const select = qs("#company-switcher");
      if (!select) return;
      const isAdmin = state.user?.role === "admin";
      if (!isAdmin) {
        select.innerHTML = "";
        return;
      }
      const sortedCompanies = [...empresas].sort((a, b) => a.nome.localeCompare(b.nome));
      if (!sortedCompanies.length) {
        select.innerHTML = `<option value="">Nenhuma empresa cadastrada</option>`;
        select.value = "";
        state.companyScopeId = "";
        return;
      }
      const options = sortedCompanies.map((empresa) => {
        const selected = state.companyScopeId === empresa.id ? "selected" : "";
        return `<option value="${empresa.id}" ${selected}>${escapeHtml(empresa.nome)}</option>`;
      });
      select.innerHTML = options.join("");
      const companyIds = sortedCompanies.map((empresa) => empresa.id);
      const sanitized = companyIds.includes(state.companyScopeId)
        ? state.companyScopeId
        : companyIds[0];
      state.companyScopeId = sanitized || "";
      select.value = state.companyScopeId || "";
    }

      function applyOverviewAccountGroupFilter(transactions) {
        const groupId = state.overviewFilters.accountGroup;
        if (!groupId || groupId === "all") return transactions;
        const group = accountGroups.find((item) => item.id === groupId);
        if (!group) return transactions;
        const accountsInGroup = group.accounts || [];
        return transactions.filter((t) => accountsInGroup.includes(t.accountName));
      }

      function resolveDashboardAggregate(data) {
        const { periodValue, year } = state.overviewFilters;
        const hasAccountGroup = state.overviewFilters.accountGroup && state.overviewFilters.accountGroup !== "all";
        const hasPeriodFilter = [periodValue, year].some((value) => value && value !== "all");
        const cached = hasAccountGroup || hasPeriodFilter ? null : getAggregateForCurrentFilters();
        if (cached) return cached;
        const baseData = filterTransactionsUntilToday(data ?? getCurrentTransactionsPage());
        return aggregateTransactions(baseData);
      }

      function renderFinancialHighlights(data) {
        const container = qs("#highlight-grid");
        if (!container) return;
        const aggregate = resolveDashboardAggregate(data);
        const totalReceitas = getTotalByType(aggregate, "receita");
        const totalDespesas = sumDespesasPorParametro(aggregate);
        const revenueIds = new Set(["pixDinheiroTransferencias", "cartoes", "aportes"]);
        const expenseIds = new Set([
          "despesaFixa",
          "despesasDiversas",
          "impostos",
          "investimentos",
          "retiradas",
          "equipe",
          "insumos",
          "marketing"
        ]);
        const buildPercentMap = (items, totalBase) => {
          if (!items.length || !totalBase) return {};
          const raw = items.map((item) => calcPercentual(item.calc(aggregate), totalBase));
          const rounded = raw.map((value) => Number(value.toFixed(1)));
          const roundedSum = rounded.reduce((sum, value) => sum + value, 0);
          const diff = Number((100 - roundedSum).toFixed(1));
          if (Number.isFinite(diff)) {
            const lastIndex = rounded.length - 1;
            rounded[lastIndex] = Number((rounded[lastIndex] + diff).toFixed(1));
          }
          return items.reduce((acc, item, idx) => {
            acc[item.id] = rounded[idx];
            return acc;
          }, {});
        };
        const getHighlight = (id) => overviewHighlights.find((item) => item.id === id);
        const rowsReceitas = [
          { className: "four", items: ["pixDinheiroTransferencias", "cartoes", "aportes"].map(getHighlight).filter(Boolean) }
        ];
        const rowsDespesas = [
          { className: "four", items: ["despesaFixa", "despesasDiversas", "impostos", "investimentos"].map(getHighlight).filter(Boolean) },
          { className: "four", items: ["marketing", "equipe", "insumos", "retiradas"].map(getHighlight).filter(Boolean) }
        ];
        const receitaItems = rowsReceitas.flatMap((row) => row.items);
        const despesaItems = rowsDespesas.flatMap((row) => row.items);
        const receitaPercentMap = buildPercentMap(receitaItems, totalReceitas);
        const despesaPercentMap = buildPercentMap(despesaItems, totalDespesas);
        const renderRows = (rows) => rows.map((row) => `
          <div class="highlight-row ${row.className}">
            ${row.items.map((item) => `
              ${item ? (() => {
                const value = item.calc(aggregate);
                const percent = revenueIds.has(item.id)
                  ? receitaPercentMap[item.id]
                  : (expenseIds.has(item.id) ? despesaPercentMap[item.id] : 0);
                const percentLabel = Number.isFinite(percent) ? `${percent.toFixed(1)}%` : "0.0%";
                return `
              <div class="card highlight-card">
                <div class="card-title">${item.label}</div>
                <div class="card-value" style="color:${item.color ?? "var(--text)"}">
                  ${formatCurrency(value)}
                  <span style="font-size:0.85rem;color:var(--muted);font-weight:500">(${percentLabel})</span>
                </div>
              </div>
                `;
              })() : ""}
            `).join("")}
          </div>
        `).join("");
        container.innerHTML = `
          <div class="highlight-group" data-group="receitas"${highlightToggleState.receitas ? "" : " hidden"}>
            ${renderRows(rowsReceitas)}
          </div>
          <div class="highlight-group" data-group="despesas"${highlightToggleState.despesas ? "" : " hidden"}>
            ${renderRows(rowsDespesas)}
          </div>
        `;
      }

      function renderKPIs(data) {
        const aggregate = resolveDashboardAggregate(data);
        const revenue = sumReceitasPorParametro(aggregate);
        const expense = sumDespesasPorParametro(aggregate);
        const totalVendas = applyCompetencyFilterToVendas(getVisibleVendas())
          .reduce((acc, item) => acc + (Number(item.valor) || 0), 0);
        const clinicsCount = state.user.role === "admin" ? clinics.length : 1;
        const cards = [
          { label: "TOTAL DE RECEBIMENTOS", value: formatCurrency(revenue), accent: "var(--positive)", background: "rgba(134,239,172,0.2)", toggle: "receitas" },
          { label: "TOTAL DE VENDAS", value: formatCurrency(totalVendas), accent: "#facc15", background: "rgba(250,204,21,0.2)" },
          { label: "TOTAL DE DESPESAS", value: formatCurrency(expense), accent: "var(--danger)", background: "rgba(248,113,113,0.2)", toggle: "despesas" },
          { label: "Resultado", value: formatCurrency(revenue - expense), accent: "var(--accent)", background: "rgba(56,189,248,0.2)" },
        ];
        qs("#kpi-grid").innerHTML = cards.map((card) => `
          <div class="card kpi-card"${card.toggle ? ` data-toggle="${card.toggle}" aria-expanded="${highlightToggleState[card.toggle] ? "true" : "false"}"` : ""}${card.background ? ` style="background:${card.background}"` : ""}>
            <div class="card-title">${card.label}</div>
            <div class="card-value" style="color:${card.accent}">${card.value}</div>
          </div>`).join("");
        setupHighlightToggles();
      }

      function populateIndicadoresFilters() {
        const monthSelect = qs("#indicadores-month");
        const yearSelect = qs("#indicadores-year");
        if (!monthSelect || !yearSelect) return;

        const monthLabels = [
          "Janeiro", "Fevereiro", "Mar\u00e7o", "Abril", "Maio", "Junho",
          "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ];
        monthSelect.innerHTML = monthLabels
          .map((label, index) => `<option value="${index + 1}">${label}</option>`)
          .join("");

        const currentYear = new Date().getFullYear();
        const yearOptions = [];
        for (let i = 0; i <= 5; i += 1) {
          yearOptions.push(String(currentYear - i));
        }
        yearSelect.innerHTML = yearOptions
          .map((year) => `<option value="${year}">${year}</option>`)
          .join("");

        if (!indicadoresFiltersInitialized) {
          const handleChange = () => {
            state.indicadoresFilters.month = monthSelect.value;
            state.indicadoresFilters.year = yearSelect.value;
            renderIndicadores();
          };
          monthSelect.addEventListener("change", handleChange);
          yearSelect.addEventListener("change", handleChange);
          indicadoresFiltersInitialized = true;
        }
      }

      function applyIndicadoresDefaultPeriod() {
        const monthSelect = qs("#indicadores-month");
        const yearSelect = qs("#indicadores-year");
        if (!monthSelect || !yearSelect) return;
        const previous = getIndicadoresDefaultPeriod();
        state.indicadoresFilters.month = previous.month;
        state.indicadoresFilters.year = previous.year;
        monthSelect.value = previous.month;
        yearSelect.value = previous.year;
        renderIndicadores();
      }

      function initIndicadoresFilters() {
        populateIndicadoresFilters();
        applyIndicadoresDefaultPeriod();
      }

      function getIndicadoresFiltrados() {
        const baseData = Array.isArray(allTransactions) ? allTransactions : [];
        const monthValue = state.indicadoresFilters.month ? Number(state.indicadoresFilters.month) : null;
        const yearValue = state.indicadoresFilters.year ? Number(state.indicadoresFilters.year) : null;
        if (!monthValue && !yearValue) return baseData;
        return baseData.filter((t) => {
          let txYear = Number(t.year);
          let txMonth = Number(t.month);
          if ((!Number.isFinite(txYear) || !Number.isFinite(txMonth)) && t.date) {
            const parsed = parseDateInput(t.date);
            if (!Number.isNaN(parsed.getTime())) {
              txYear = parsed.getFullYear();
              txMonth = parsed.getMonth() + 1;
            }
          }
          if (yearValue && txYear !== yearValue) return false;
          if (monthValue && txMonth !== monthValue) return false;
          return true;
        });
      }

      function renderIndicadores(data = getIndicadoresFiltrados()) {
        const container = qs("#indicadores-grid");
        if (!container) return;
        const aggregate = resolveDashboardAggregate(data);
        const revenue = aggregate.byType.receita || 0;
        const expense = aggregate.byType.despesa || 0;
        const margin = revenue ? ((revenue - expense) / revenue) * 100 : 0;
        const liquidity = expense ? revenue / expense : 0;
        const pmp = aggregate.byTypeDays.despesa.count
          ? Math.round(aggregate.byTypeDays.despesa.sum / aggregate.byTypeDays.despesa.count)
          : 0;
        const pmr = aggregate.byTypeDays.receita.count
          ? Math.round(aggregate.byTypeDays.receita.sum / aggregate.byTypeDays.receita.count)
          : 0;
        const cards = [
          { label: "Margem de Lucro", value: revenue ? `${margin.toFixed(1)}%` : "0%" },
          { label: "Índice de Liquidez", value: expense ? liquidity.toFixed(2) : "0" },
          { label: "Prazo Médio de Pagamento (PMP)", value: `${pmp} dias` },
          { label: "Prazo Médio de Recebimento (PMR)", value: `${pmr} dias` }
        ];
        container.innerHTML = cards.map((card) => `
          <div class="card kpi-card">
            <div class="card-title">${card.label}</div>
            <div class="card-value">${card.value}</div>
          </div>`).join("");
      }

      function getOverviewTransactions() {
        const { periodType, periodValue, year } = state.overviewFilters;
        const baseData = Array.isArray(allTransactions) ? allTransactions : [];
        const filtered = baseData.filter((t) => {
          if (year !== "all" && t.year !== Number(year)) return false;

          if (periodValue !== "all") {
            if (periodType === "month" && t.month !== Number(periodValue)) return false;
            if (periodType === "quarter") {
              if (!t.month) return false;
              const q = Math.ceil(t.month / 3);
              if (q !== Number(periodValue)) return false;
            }
            if (periodType === "semester") {
              if (!t.month) return false;
              const s = t.month <= 6 ? 1 : 2;
              if (s !== Number(periodValue)) return false;
            }
          }

          return true;
        });

        return applyOverviewAccountGroupFilter(filtered);
      }

      function refreshOverview() {
        const overviewData = getOverviewTransactions();
        renderFinancialHighlights(overviewData);
        renderKPIs(overviewData);
        renderIndicadores();
        renderCharts(overviewData);
      }

      function applyOverviewFilters() {
        refreshOverview();
      }

      function updateDashboard() {
        refreshOverview();
      }

    const debouncedRefreshTransactions = debounce(() => refreshTransactionsAndDashboard(), 350);
    const debouncedRealtimeRefresh = debounce(() => refreshTransactionsAndUI(), 350);

    function renderTransactionTable(data = filteredTransactions) {
      const tbody = qs("#transaction-table tbody");
      if (!tbody) return;
      const baseData = Array.isArray(data) ? data : [];
      const totalPages = Math.max(1, Math.ceil(baseData.length / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = baseData.slice(start, end);
      updateMissingParametroIndicator(baseData);
      const sorted = pageData.slice();
      const sortedCategories = categories.slice().sort((a, b) => a.localeCompare(b));
      const categorySet = new Set(sortedCategories);
      const baseOptionsHtml = sortedCategories
        .map((category) => `<option value="${escapeAttribute(category)}">${escapeHtml(category)}</option>`)
        .join("");
      tbody.textContent = "";
      if (!sorted.length) {
        const emptyRow = document.createElement("tr");
        const emptyCell = document.createElement("td");
        emptyCell.colSpan = 7;
        emptyCell.style.textAlign = "center";
        emptyCell.style.color = "var(--muted)";
        emptyCell.textContent = "Sem lançamentos.";
        emptyRow.appendChild(emptyCell);
        tbody.appendChild(emptyRow);
        renderTransactionPagination();
        return;
      }
      const fragment = document.createDocumentFragment();
      sorted.forEach((t) => {
        const tr = document.createElement("tr");
        const account = t.accountName ?? (clinics.find((c) => c.id === t.clinicId)?.name ?? "-");
        const description = t.description || t.category || "-";
        const parametro = t.parametro || resolveParametro(t.category || "-") || "-";
        const badgeClass = `badge ${t.type}`;

        const tdDate = document.createElement("td");
        tdDate.textContent = formatDate(t.date);

        const tdAccount = document.createElement("td");
        tdAccount.textContent = account;

        const tdDescription = document.createElement("td");
        tdDescription.textContent = description;

        const tdCategory = document.createElement("td");
        const select = document.createElement("select");
        select.dataset.transactionCategory = t.id;
        if (!baseOptionsHtml) {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "Nenhuma categoria";
          select.appendChild(option);
        } else {
          if (t.category && !categorySet.has(t.category)) {
            const customOption = document.createElement("option");
            customOption.value = t.category;
            customOption.textContent = t.category;
            select.appendChild(customOption);
          }
          select.insertAdjacentHTML("beforeend", baseOptionsHtml);
          select.value = t.category || "";
        }
        tdCategory.appendChild(select);

        const tdParametro = document.createElement("td");
        tdParametro.textContent = parametro;

        const tdTipo = document.createElement("td");
        const badge = document.createElement("span");
        badge.className = badgeClass;
        badge.textContent = t.type;
        tdTipo.appendChild(badge);

        const tdValor = document.createElement("td");
        tdValor.textContent = formatCurrency(t.amount);

        tr.appendChild(tdDate);
        tr.appendChild(tdAccount);
        tr.appendChild(tdDescription);
        tr.appendChild(tdCategory);
        tr.appendChild(tdParametro);
        tr.appendChild(tdTipo);
        tr.appendChild(tdValor);
        fragment.appendChild(tr);
      });
      tbody.appendChild(fragment);
      renderTransactionPagination();
    }

    function ensureTransactionPaginationControls() {
      const table = qs("#transaction-table");
      if (!table) return null;
      let pagination = qs("#transaction-pagination");
      if (pagination) return pagination;
      const wrapper = table.closest(".card");
      if (!wrapper) return null;
      pagination = document.createElement("div");
      pagination.id = "transaction-pagination";
      pagination.style.display = "flex";
      pagination.style.justifyContent = "space-between";
      pagination.style.alignItems = "center";
      pagination.style.gap = "0.75rem";
      pagination.style.flexWrap = "wrap";
      pagination.style.marginTop = "0.75rem";
      if (!pagination.dataset.bound) {
        pagination.addEventListener("click", handleTransactionPaginationClick);
        pagination.addEventListener("change", handleTransactionPaginationClick);
        pagination.dataset.bound = "true";
      }
      wrapper.appendChild(pagination);
      return pagination;
    }

    function renderTransactionPagination() {
      const pagination = ensureTransactionPaginationControls();
      if (!pagination) return;
      const total = filteredTransactions.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      const hasPrev = currentPage > 1;
      const hasNext = currentPage < totalPages;
      const startIndex = (currentPage - 1) * pageSize;
      const startCount = total ? startIndex + 1 : 0;
      const endCount = total ? Math.min(startIndex + pageSize, total) : 0;
      pagination.innerHTML = `
        <div style="color:var(--muted);font-size:0.85rem">Mostrando ${startCount} - ${endCount} de ${total} registros</div>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center">
          <label style="color:var(--muted);font-size:0.85rem">Por pagina</label>
          <select id="transaction-page-size" class="input" style="width:auto;padding:0.35rem 0.6rem">
            <option value="20"${pageSize === 20 ? " selected" : ""}>20</option>
            <option value="50"${pageSize === 50 ? " selected" : ""}>50</option>
            <option value="100"${pageSize === 100 ? " selected" : ""}>100</option>
          </select>
          <button class="btn-secondary" data-page="prev" ${hasPrev ? "" : "disabled"} style="width:auto;padding:0.35rem 0.8rem">Anterior</button>
          <button class="btn-secondary" data-page="next" ${hasNext ? "" : "disabled"} style="width:auto;padding:0.35rem 0.8rem">Proximo</button>
        </div>
      `;
    }

    function handleTransactionPaginationClick(evt) {
      const pageSizeSelect = evt.target.closest("#transaction-page-size");
      if (pageSizeSelect) {
        if (evt.type === "click") return;
        const nextSize = Number(pageSizeSelect.value);
        if (Number.isFinite(nextSize) && nextSize > 0) {
          pageSize = nextSize;
          currentPage = 1;
          renderTransactionTable(filteredTransactions);
        }
        return;
      }
      const button = evt.target.closest("button[data-page]");
      if (!button || button.hasAttribute("disabled")) return;
      const direction = button.dataset.page;
      if (direction === "prev") {
        goToTransactionPage(currentPage - 1);
      } else if (direction === "next") {
        goToTransactionPage(currentPage + 1);
      }
    }

    function goToTransactionPage(nextIndex) {
      if (nextIndex < 1) return;
      currentPage = nextIndex;
      renderTransactionTable(filteredTransactions);
    }

    function getVisibleVendas() {
      if (!state.user) return [];
      if (state.user.role === "admin") {
        const selectedCompany = getActiveCompanyId();
        if (selectedCompany) return vendas.filter((item) => item.clinicId === selectedCompany);
        return [...vendas];
      }
      return vendas.filter((item) => item.clinicId === state.user.clinicId);
    }

    function applyCompetencyFilterToVendas(data) {
      const { periodType, periodValue, year } = state.overviewFilters;
      const scopedData = applyAccountGroupFilterToVendas(data);
      if (
        (periodValue === "all" || !periodValue) &&
        (year === "all" || !year)
      ) {
        return scopedData;
      }
      return scopedData.filter((item) => {
        const d = parseDateInput(item.data);
        if (Number.isNaN(d.getTime())) return false;
        const transMonth = String(d.getMonth() + 1).padStart(2, "0");
        const transQuarter = String(Math.ceil((d.getMonth() + 1) / 3));
        const transSemester = String(Math.ceil((d.getMonth() + 1) / 6));
        const matchesPeriod = periodValue === "all" || (
          (periodType === "month" && transMonth === periodValue) ||
          (periodType === "quarter" && transQuarter === periodValue) ||
          (periodType === "semester" && transSemester === periodValue)
        );
        const matchesYear = year === "all" || String(d.getFullYear()) === year;
        return matchesPeriod && matchesYear;
      });
    }

    function applyVendasFilters(data) {
      const { start, end, type, descriptionSearch } = state.vendasFilters;
      const startDate = normalizeDateRange(start, false);
      const endDate = normalizeDateRange(end, true);
      const search = normalizeText(descriptionSearch);

      const scopedData = applyAccountGroupFilterToVendas(data);
      vendasFiltered = scopedData.filter((item) => {
        if (startDate || endDate) {
          const vendaDate = parseDateInput(item.data);
          if (Number.isNaN(vendaDate.getTime())) return false;
          if (startDate && vendaDate < startDate) return false;
          if (endDate && vendaDate > endDate) return false;
        }

        if (type !== "all") {
          const vendaTipo = normalizeVendaTipo(item.tipo);
          if (vendaTipo !== type) return false;
        }

        if (search) {
          const haystack = normalizeText(`${item.paciente ?? ""} ${item.numero ?? ""}`);
          if (!haystack.includes(search)) return false;
        }

        return true;
      }).sort((a, b) => parseDateInput(b.data) - parseDateInput(a.data));

      vendasCurrentPage = 1;
      renderVendasTable();
    }

    function renderVendasTable() {
      const tbody = qs("#vendas-table tbody");
      if (!tbody) return;
      tbody.textContent = "";

      const total = vendasFiltered.length;
      const startIndex = (vendasCurrentPage - 1) * vendasPageSize;
      const endIndex = Math.min(startIndex + vendasPageSize, total);
      const pageItems = vendasFiltered.slice(startIndex, endIndex);

      if (!pageItems.length) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--muted)">Nenhuma venda importada.</td></tr>`;
      } else {
        const rows = pageItems.map((item) => {
          const badgeClass = item.tipo === "Recibo" ? "venda-recibo" : "venda-nota";
          return `
            <tr>
              <td><span class="badge ${badgeClass}">${item.tipo}</span></td>
              <td>${formatDate(item.data)}</td>
              <td>${escapeHtml(item.numero)}</td>
              <td>${escapeHtml(item.paciente)}</td>
              <td>${formatCurrency(item.valor)}</td>
            </tr>`;
        }).join("");
        tbody.innerHTML = rows;
      }

      const info = qs("#vendas-page-info");
      if (info) {
        const startLabel = total === 0 ? 0 : startIndex + 1;
        info.textContent = `Mostrando ${startLabel} – ${endIndex} de ${total} registros`;
      }

      const prevButton = qs("#vendas-prev-page");
      if (prevButton) prevButton.disabled = vendasCurrentPage === 1;
      const nextButton = qs("#vendas-next-page");
      if (nextButton) nextButton.disabled = endIndex >= total;

      updateFilteredVendasDeleteButton();
    }

    function renderVendas() {
      applyVendasFilters(getVisibleVendas());
    }

    function renderCategoryTags() {
      const datalist = qs("#category-list");
      if (datalist) {
        datalist.innerHTML = categories.map((c) => `<option value="${c}">`).join("");
      }
      const container = qs("#category-tags");
      if (!container) return;
      container.innerHTML = categories.map((c) => `
        <span class="badge" style="background:rgba(56,189,248,0.12);color:var(--accent)">
          ${c}
          <button data-remove="${c}" style="background:transparent;border:none;color:var(--muted);margin-left:0.4rem;cursor:pointer">&times;</button>
        </span>`).join("");
    }

    function renderAccountGroups() {
      const container = qs("#account-group-list");
      if (!container) return;
      if (!accountGroups.length) {
        container.innerHTML = `<p style="color:var(--muted)">Nenhum grupo cadastrado.</p>`;
        renderAccountGroupFilter();
        return;
      }
      container.innerHTML = accountGroups.map((group) => `
        <div class="account-group-pill">
          <div>
            <strong>${group.name}</strong>
            <div class="account-group-accounts">${group.accounts.map((acc) => `<span>${acc}</span>`).join(", ")}</div>
          </div>
          <button data-remove-group="${group.id}" class="btn-secondary" style="width:auto;padding:0.35rem 0.75rem">Remover</button>
        </div>
      `).join("");
      renderAccountGroupFilter();
    }

    function renderAccountOptions() {
      const container = qs("#account-checkboxes");
      if (!container) return;
      if (!accountRegistry.length) {
        container.innerHTML = "<p style='color:var(--muted)'>Importe dados financeiros para detectar contas banc&#225;rias.</p>";
        return;
      }
      container.innerHTML = accountRegistry
        .sort((a, b) => a.localeCompare(b))
        .map((account) => `
          <label>
            <input type="checkbox" name="accountOption" value="${account}">
            ${account}
          </label>
        `).join("");
    }

    function syncTransactionFiltersUI() {
      const form = qs("#transaction-filter-form");
      if (!form) return;
      form.startDate.value = state.transactionFilters.start || "";
      form.endDate.value = state.transactionFilters.end || "";
      if (form.month) {
        form.month.value = state.transactionFilters.month || "";
      }
      if (form.year) {
        form.year.value = state.transactionFilters.year || "";
      }
      form.type.value = state.transactionFilters.type || "all";
      if (form.parametro) {
        form.parametro.value = state.transactionFilters.parametro || "all";
      }
      if (form.descriptionSearch) {
        form.descriptionSearch.value = state.transactionFilters.descriptionSearch || "";
      }
    }

    function syncVendasFiltersUI() {
      const form = qs("#vendas-filter-form");
      if (!form) return;
      form.startDate.value = state.vendasFilters.start || "";
      form.endDate.value = state.vendasFilters.end || "";
      form.type.value = state.vendasFilters.type || "all";
      if (form.descriptionSearch) {
        form.descriptionSearch.value = state.vendasFilters.descriptionSearch || "";
      }
    }

    function renderMappingSourceOptions() {
      const select = qs("#mapping-source");
      if (!select) return;
      if (!categories.length) {
        select.innerHTML = "<option value=\"\">Nenhuma categoria dispon&#237;vel</option>";
        return;
      }
      select.innerHTML = categories
        .sort((a, b) => a.localeCompare(b))
        .map((c) => `<option value="${c}">${c}</option>`)
        .join("");
    }

    function renderMappingTargetOptions() {
      const select = qs("#mapping-target");
      if (!select) return;
      if (!dashboardCategories.length) {
        select.innerHTML = "<option value=\"\">Nenhuma categoria dispon&#237;vel</option>";
        return;
      }
      const sorted = [...dashboardCategories].sort((a, b) => a.name.localeCompare(b.name));
      select.innerHTML = sorted
        .map((cat) => `<option value="${cat.id}">${cat.name}</option>`)
        .join("");
    }

    function renderCategoryMappings() {
      const container = qs("#category-mapping-list");
      if (!container) return;
      const registeredCategoriesSet = new Set(
        dashboardCategories.map((cat) => cat.name)
      );
      const uncategorizedItems = categoryItems.filter((item) =>
        !registeredCategoriesSet.has(item.name)
      );
      container.innerHTML = "";
      uncategorizedItems.forEach((item) => {
        const div = document.createElement("div");
        div.className = "account-group-pill";
        const safeName = escapeAttribute(JSON.stringify(item.name));
        div.innerHTML = `
          <strong>${escapeHtml(item.name)}</strong>
          <button class="btn-secondary" onclick="removeCategory(${safeName})">
            Remover
          </button>
        `;
        container.appendChild(div);
      });
    }

    function renderDashboardAssociationOptions(selected) {
      const safeSelected = selected || "";
      const placeholderSelected = safeSelected ? "" : " selected";
      const options = DASHBOARD_ASSOCIATION_OPTIONS.map((option) => {
        const escaped = escapeAttribute(option);
        const isSelected = option === safeSelected ? " selected" : "";
        return `<option value="${escaped}"${isSelected}>${escapeHtml(option)}</option>`;
      }).join("");
      return `<option value=""${placeholderSelected}>Selecione</option>${options}`;
    }

    function renderDashboardCategories() {
      renderMappingTargetOptions();
      const container = qs("#dashboard-category-list");
      if (!container) return;
      if (!dashboardCategories.length) {
        container.innerHTML = `<p style="color:var(--muted)">Nenhuma categoria cadastrada.</p>`;
        return;
      }
      const sorted = [...dashboardCategories].sort((a, b) => a.name.localeCompare(b.name));
      container.innerHTML = sorted
        .map((cat) => `
          <div class="account-group-pill">
            <div class="association-field">
              <strong>${cat.name}</strong>
              <select class="association-input ${cat.accountingName ? "saved" : ""}" data-assoc-dashboard="${cat.id}">
                ${renderDashboardAssociationOptions(cat.accountingName)}
              </select>
            </div>
            <div style="display:flex;gap:0.4rem">
              <button data-save-dashboard="${cat.id}" class="btn-secondary" style="width:auto;padding:0.35rem 0.75rem">Salvar</button>
              <button data-edit-dashboard="${cat.id}" class="btn-secondary" style="width:auto;padding:0.35rem 0.75rem">Editar</button>
              <button data-remove-dashboard="${cat.id}" class="btn-secondary" style="width:auto;padding:0.35rem 0.75rem">Remover</button>
            </div>
          </div>
        `).join("");
    }



    function renderCashflowChart() {
      const canvas = qs("#cashflowChart");
      if (!canvas) return;
      const ctxCash = canvas.getContext("2d");
      const { start, end } = getChartRange();
      const vendasByMonth = aggregateChartVendasByMonth(start, end);
      const labels = getChartMonthLabels(start, end);
      const chartTransactions = getChartTransactions();
      const { revenue, expense } = aggregateChartTotalsByMonth(chartTransactions, labels);
      const sales = labels.map((label) => vendasByMonth[label] ?? 0);

      const gradientRevenue = ctxCash.createLinearGradient(0, 0, 0, 200);
      gradientRevenue.addColorStop(0, "rgba(74,222,128,0.5)");
      gradientRevenue.addColorStop(1, "rgba(74,222,128,0)");
      const gradientExpense = ctxCash.createLinearGradient(0, 0, 0, 200);
      gradientExpense.addColorStop(0, "rgba(248,113,113,0.5)");
      gradientExpense.addColorStop(1, "rgba(248,113,113,0)");

      const textColor = getThemeColor("--text") || "#e2e8f0";
      const gridColor = state.theme === "light" ? "rgba(15,23,42,0.12)" : "rgba(148,163,184,0.1)";

      if (state.chartCashflow) state.chartCashflow.destroy();
      state.chartCashflow = new Chart(ctxCash, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Total de Recebimentos", data: revenue, fill: true, backgroundColor: gradientRevenue, borderColor: "#4ade80", tension: 0.4 },
            { label: "Total de Despesas", data: expense, fill: true, backgroundColor: gradientExpense, borderColor: "#f87171", tension: 0.4 },
            { label: "Total de Vendas", data: sales, fill: false, backgroundColor: "rgba(250,204,21,0.25)", borderColor: "#facc15", tension: 0.4 }
          ]
        },
        options: {
          plugins: { legend: { labels: { color: textColor } } },
          scales: {
            x: { ticks: { color: textColor }, grid: { color: gridColor } },
            y: { ticks: { color: textColor }, grid: { color: gridColor } }
          }
        }
      });
    }

    function renderCharts() {
      renderCashflowChart();
    }

    function aggregateMonthlyFromAggregate(aggregate) {
      return Object.entries(aggregate.byMonth || {})
        .sort(([a], [b]) => a.localeCompare(b))
        .map(([key, items]) => ({
          label: key,
          receita: items.receita || 0,
          despesa: items.despesa || 0
        }));
    }

    function aggregateMonthlyVendas(data) {
      const byMonth = {};
      data.forEach((item) => {
        const d = parseDateInput(item.data);
        if (Number.isNaN(d.getTime())) return;
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
        byMonth[key] = (byMonth[key] ?? 0) + (Number(item.valor) || 0);
      });
      return byMonth;
    }

    async function ensureAggregateForFilters(filters) {
      if (!state.user) return;
      const key = getTransactionCacheKey(filters);
      const cached = transactionAggregateCache.get(key);
      if (cached?.data || cached?.loading) return;
      // Aggregate in background, paging through Firestore to keep the UI responsive.
      const token = ++transactionState.aggregateToken;
      transactionAggregateCache.set(key, { loading: true, data: null });
      let aggregate = createAggregateSeed();
      let startAfterDoc = null;
      let hasMore = true;
      try {
        while (hasMore) {
          if (token !== transactionState.aggregateToken) return;
          const q = await buildTransactionsQuery(filters, {
            startAfterDoc,
            limit: AGGREGATE_PAGE_SIZE
          });
          const { fns } = await getFirebase();
          const snap = await fns.getDocs(q);
          const items = snap.docs.map((docSnap) => mapTransactionRecord(docSnap.data(), docSnap.id));
          const filtered = filterTransactionsUntilToday(items);
          aggregate = mergeAggregates(aggregate, aggregateTransactions(filtered));
          startAfterDoc = snap.docs[snap.docs.length - 1] || null;
          hasMore = snap.docs.length === AGGREGATE_PAGE_SIZE;
          await new Promise((resolve) => setTimeout(resolve, 0));
        }
        transactionAggregateCache.set(key, { loading: false, data: aggregate });
        updateDashboard();
      } catch (error) {
        console.error("Falha ao agregar transacoes.", error);
        transactionAggregateCache.set(key, { loading: false, data: aggregate });
      }
    }

    async function refreshTransactionsAndDashboard() {
      if (!state.user) return;
      const filters = resolveTransactionFilters();
      const key = getTransactionCacheKey(filters);
      if (transactionState.key !== key) {
        transactionState.key = key;
        transactionState.pageIndex = 0;
      }
      await ensureTransactionListener(filters);
      try {
        await loadAllTransactions(filters);
      } catch (error) {
        console.error("Falha ao atualizar transacoes.", error);
        allTransactions = [];
        filteredTransactions = [];
      }
      applyTransactionFilters();
      updateDashboard();
      ensureAggregateForFilters(filters);
    }

    async function refreshTransactionsAndUI() {
      await refreshTransactionsAndDashboard();
      refreshUI();
    }

    function applyTransactionFilters() {
      const { start, end, month, year, type, parametro, descriptionSearch } = state.transactionFilters;

      const startDate = normalizeFilterDate(start);
      const endDate = normalizeFilterDate(end);

      currentPage = 1;
      filteredTransactions = allTransactions.filter((t) => {
        // Filtro de mes/ano (principal)
        if (month && year) {
          if (t.month !== Number(month) || t.year !== Number(year)) return false;
        }

        // Data
        if (startDate || endDate) {
          const txDate = normalizeFilterDate(t.date);
          if (!txDate) return false;
          if (startDate && txDate < startDate) return false;
          if (endDate && txDate > endDate) return false;
        }

        // Tipo
        if (type !== "all") {
          const txType = normalizeType(t.type);
          if (txType !== type) return false;
        }

        // Parametro
        if (parametro !== "all") {
          const txParam = normalizeParametro(t.parametro);
          const selectedParam = normalizeParametro(parametro);

          if (!txParam) return false;
          if (txParam !== selectedParam) return false;
        }

        // Descricao
        if (descriptionSearch) {
          const search = descriptionSearch.toLowerCase();
          const desc = (t.description || "").toLowerCase();
          if (!desc.includes(search)) return false;
        }

        return true;
      });

      renderTransactionTable(filteredTransactions);
      updateFilteredDeleteButton();
    }

    function parseDateInput(value) {
      if (!value) return new Date("");
      if (value && typeof value.toDate === "function") return value.toDate();
      if (value instanceof Date) return value;
      if (typeof value === "string" && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
        const [year, month, day] = value.split("-").map(Number);
        return new Date(year, month - 1, day);
      }
      return new Date(value);
    }

    function filterTransactionsUntilToday(data) {
      if (!Array.isArray(data)) return [];
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      return data.filter((t) => {
        const date = parseDateInput(t.date);
        if (Number.isNaN(date.getTime())) return false;
        return date <= today;
      });
    }

    function hasActiveTransactionFilters() {
      const { start, end, month, year, type, parametro, descriptionSearch } = state.transactionFilters;
      return Boolean(
        start ||
        end ||
        month ||
        year ||
        (type && type !== "all") ||
        (parametro && parametro !== "all") ||
        descriptionSearch
      );
    }

    function clearTransactionFilters() {
      state.transactionFilters = {
        start: "",
        end: "",
        month: "",
        year: "",
        type: "all",
        parametro: "all",
        descriptionSearch: ""
      };
      syncTransactionFiltersUI();
      updateFilteredDeleteButton();
      filteredTransactions = [...allTransactions];
      currentPage = 1;
      renderTransactionTable(filteredTransactions);
    }

    function updateMissingParametroIndicator(data) {
      const indicator = qs("#missing-param-indicator");
      if (!indicator) return;
      const missingCount = data.filter((t) => {
        const parametro = t.parametro || resolveParametro(t.category);
        return !parametro || !parametro.toString().trim();
      }).length;
      if (!missingCount) {
        indicator.classList.add("hidden");
        indicator.textContent = "";
        return;
      }
      indicator.textContent = `${missingCount} lan\u00e7amento(s) sem par\u00e2metro associado.`;
      indicator.classList.remove("hidden");
    }

    function formatCurrency(value) {
      const numeric = typeof value === "number" ? value : Number(value);
      if (!Number.isFinite(numeric)) return value?.toString?.() ?? "";
      return numeric.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function formatDate(value) {
      const date = parseDateInput(value);
      if (Number.isNaN(date.getTime())) return "";
      return date.toLocaleDateString("pt-BR");
    }

      function handlePeriodTypeChange(evt) {
        const nextType = evt.target.value;
        state.overviewFilters.periodType = nextType;
        state.overviewFilters.periodValue = "all";
        if (
          (nextType === "quarter" || nextType === "semester") &&
          (!state.overviewFilters.year || state.overviewFilters.year === "all")
        ) {
          state.overviewFilters.year = String(new Date().getFullYear());
        }
        populateCompetencySelectors();
      }

      function handlePeriodValueChange(evt) {
        state.overviewFilters.periodValue = evt.target.value;
        if (
          state.overviewFilters.periodValue !== "all" &&
          (state.overviewFilters.periodType === "quarter" || state.overviewFilters.periodType === "semester") &&
          (!state.overviewFilters.year || state.overviewFilters.year === "all")
        ) {
          state.overviewFilters.year = String(new Date().getFullYear());
          populateCompetencySelectors();
        }
      }

      function handlePeriodYearChange(evt) {
        state.overviewFilters.year = evt.target.value;
      }

      function handleAccountGroupChange(evt) {
        state.overviewFilters.accountGroup = evt.target.value || "all";
        renderVendas();
      }

    async function handleCompanySwitch(evt) {
      const previous = state.companyScopeId;
      state.companyScopeId = evt.target.value || "";
      const filterSelect = qs("#filter-account-group");
      if (filterSelect && filterSelect.value !== state.overviewFilters.accountGroup) {
        filterSelect.value = state.overviewFilters.accountGroup || "all";
      }
      renderCompanyBrand();
      if (previous !== state.companyScopeId) {
        invalidateTransactionCache();
        await refreshCompanyScopedData();
      }
      debouncedRefreshTransactions();
    }

    function handleClinicCreation(evt) {
      evt.preventDefault();
      const name = evt.target.clinicName.value.trim();
      if (!name) return;
      const id = crypto.randomUUID();
      clinics.push({ id, name });
      showToast("Consult\u00f3rio cadastrado!");
      evt.target.reset();
      refreshUI();
    }

    function updateLogoPreview(src) {
      const preview = qs("#logo-preview");
      if (!preview) return;
      if (!src) {
      preview.textContent = "Pr\u00e9via do logo";
        return;
      }
      preview.innerHTML = `<img src="${src}" alt="Pr\u00e9via do logo">`;
    }

    function addClientUserRow() {
      const list = qs("#client-user-list");
      if (!list) return;
      const row = document.createElement("div");
      row.className = "client-user-row";
      row.innerHTML = `
        <input name="clientUsername" placeholder="Usuário" required>
        <input name="clientPassword" placeholder="Senha" type="password" required>
        <button type="button" class="btn-secondary" data-remove-user style="width:auto;padding:0.45rem 0.8rem">Remover</button>
      `;
      list.appendChild(row);
    }

    function resetClientForm() {
      const form = qs("#client-form");
      const list = qs("#client-user-list");
      if (!form || !list) return;
      form.reset();
      list.innerHTML = "";
      addClientUserRow();
      updateLogoPreview("");
    }

    function openClientModal() {
      const modal = qs("#client-modal");
      if (!modal) return;
      resetClientForm();
      modal.classList.remove("hidden");
    }

    function closeClientModal() {
      const modal = qs("#client-modal");
      if (!modal) return;
      modal.classList.add("hidden");
    }

    async function handleClientCreation(evt) {
      evt.preventDefault();
      const form = evt.target;
      const name = form.companyName.value.trim();
      if (!name) return;
      if (clinics.some((c) => c.name.toLowerCase() === name.toLowerCase())) {
        showToast("Empresa ja cadastrada.", "error");
        return;
      }
      const rows = [...form.querySelectorAll(".client-user-row")];
      if (!rows.length) {
        showToast("Adicione ao menos um usuario.", "error");
        return;
      }
      const newUsers = rows.map((row) => ({
        username: row.querySelector("[name='clientUsername']").value.trim(),
        password: row.querySelector("[name='clientPassword']").value.trim()
      }));
      if (newUsers.some((u) => !u.username || !u.password)) {
        showToast("Preencha usuario e senha para todos.", "error");
        return;
      }
      const existingUser = newUsers.find((u) => users.some((user) => user.username === u.username));
      if (existingUser) {
        showToast(`Usuario ${existingUser.username} ja existe.`, "error");
        return;
      }
      const uniqueNames = new Set(newUsers.map((u) => u.username));
      if (uniqueNames.size !== newUsers.length) {
        showToast("Usu\u00e1rios duplicados.", "error");
        return;
      }

      const logoInput = form.companyLogo;
      try {
        const { db, storage, authFns, secondaryAuth, fns } = await getFirebase();
        const { collection, doc, setDoc, ref, uploadBytes, getDownloadURL } = fns;
        const companyRef = doc(collection(db, "companies"));
        let logoUrl = "";
        if (logoInput?.files?.length) {
          const fileRef = ref(storage, `companies/${companyRef.id}`);
          await uploadBytes(fileRef, logoInput.files[0]);
          logoUrl = await getDownloadURL(fileRef);
        }
        await setDoc(companyRef, {
          id: companyRef.id,
          name,
          cnpj: "",
          hasLivroCaixa: false,
          logoUrl,
          regimeTributario: "",
          simplesAnexo: "",
          aliquotaHospitalar: false,
          issFixo: false,
          issValor: 0,
          issAliquota: 0,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
        for (const user of newUsers) {
          const cred = await authFns.createUserWithEmailAndPassword(secondaryAuth, user.username, user.password);
          const userId = cred.user.uid;
          await setDoc(doc(db, "users", userId), {
            id: userId,
            name: user.username,
            username: user.username,
            role: "client",
            companyId: companyRef.id,
            active: true
          });
          await authFns.signOut(secondaryAuth);
        }
        await loadCompanies(state.user);
        await loadUsers(state.user);
        closeClientModal();
        showToast("Empresa cadastrada!");
        refreshUI();
      } catch (error) {
        console.error(error);
        showToast("Falha ao cadastrar empresa.", "error");
      }
    }

    function updateTransactionConditionalFields() {
      const form = qs("#transaction-form");
      if (!form) return;
      const isRevenue = form.type.value === "receita";
      const paymentWrapper = form.querySelector("[data-field='payment']");
      const expenseWrapper = form.querySelector("[data-field='expense']");
      paymentWrapper?.classList.toggle("active", isRevenue);
      expenseWrapper?.classList.toggle("active", !isRevenue);
      if (form.paymentMethod) form.paymentMethod.required = isRevenue;
      if (form.expenseGroup) form.expenseGroup.required = !isRevenue;
    }

    async function handleTransaction(evt) {
      evt.preventDefault();
      const form = evt.target;
      const clinicId = state.user.role === "admin" ? form.clinic.value : state.user.clinicId;
      const type = form.type.value;
      const amount = Number(form.amount.value);
      const category = form.category.value.trim();
      const date = form.date.value;
      if (!clinicId || !type || !category || !date || !Number.isFinite(amount)) return;
      const parsedDate = parseDateInput(date);
      if (Number.isNaN(parsedDate.getTime())) {
        showToast("Data invalida.", "error");
        return;
      }
      const entry = {
        clinicId,
        type,
        category,
        description: category,
        amount,
        date: parsedDate,
        year: parsedDate.getFullYear(),
        month: parsedDate.getMonth() + 1,
        accountName: "Operacional Manual"
      };
      if (type === "receita") {
        if (!form.paymentMethod.value) {
          showToast("Informe a forma de pagamento.", "error");
          return;
        }
        entry.paymentMethod = form.paymentMethod.value;
      } else {
        if (!form.expenseGroup.value) {
          showToast("Selecione o grupo da despesa.", "error");
          return;
        }
        entry.expenseGroup = form.expenseGroup.value;
      }
      try {
        const { db, fns } = await getFirebase();
        const { collection, doc, setDoc } = fns;
        const docRef = doc(collection(db, "companies", entry.clinicId, "transactions"));
        const parametro = resolveParametro(entry.category) || "";
        await setDoc(docRef, {
          id: docRef.id,
          companyId: entry.clinicId,
          type: entry.type,
          category: entry.category,
          parametro,
          amount: entry.amount,
          date: entry.date,
          year: entry.year,
          month: entry.month,
          accountName: entry.accountName,
          description: entry.description,
          paymentMethod: entry.paymentMethod || "",
          expenseGroup: entry.expenseGroup || ""
        });
        invalidateTransactionCache();
        if (!categories.includes(entry.category)) {
          await createCategory(entry.category, entry.clinicId);
        }
        showToast("Lan\u00e7amento registrado!");
        form.reset();
        updateTransactionConditionalFields();
        await refreshTransactionsAndDashboard();
        refreshUI();
      } catch (error) {
        console.error(error);
        showToast("Falha ao registrar lancamento.", "error");
      }
    }

    async function handleAccountGroupCreation(evt) {
      evt.preventDefault();
      const form = evt.target;
      const name = form.groupName.value.trim();
      const selectedAccounts = [...form.querySelectorAll("input[name='accountOption']:checked")].map((input) => input.value);
      const vendasTipos = [...form.querySelectorAll("input[name='vendasTipo']:checked")]
        .map((input) => normalizeVendasTipoValue(input.value))
        .filter(Boolean);
      if (!name) return;
      if (!selectedAccounts.length) {
        showToast("Selecione ao menos uma conta.", "error");
        return;
      }
      if (!vendasTipos.length) {
        showToast("Selecione ao menos um tipo de venda.", "error");
        return;
      }
      if (accountGroups.some((group) => group.name.toLowerCase() === name.toLowerCase())) {
        showToast("Grupo j\u00e1 cadastrado.", "error");
        return;
      }
      try {
        const { db, fns } = await getFirebase();
        const { doc, setDoc } = fns;
        const companyId = resolveScopedCompanyId();
        if (!companyId) {
          showToast("Selecione uma empresa.", "error");
          return;
        }
        const ref = doc(getCompanyCollectionRef(db, fns, companyId, "accountGroups"));
        await setDoc(ref, {
          id: ref.id,
          name,
          accounts: selectedAccounts,
          vendasTipos,
          companyId
        });
        await loadAccountGroups();
        form.reset();
        refreshUI();
        showToast("Grupo banc\u00e1rio criado!");
      } catch (error) {
        console.error(error);
        showToast("Falha ao salvar grupo.", "error");
      }
    }

    async function handleAccountGroupRemove(evt) {
      const id = evt.target.dataset.removeGroup;
      if (!id) return;
      try {
        const { db, fns } = await getFirebase();
        const companyId = resolveScopedCompanyId();
        if (!companyId) {
          showToast("Selecione uma empresa.", "error");
          return;
        }
        await fns.deleteDoc(fns.doc(db, "companies", companyId, "accountGroups", id));
        await loadAccountGroups();
        refreshUI();
        showToast("Grupo removido.");
      } catch (error) {
        console.error(error);
        showToast("Falha ao remover grupo.", "error");
      }
    }

    function handleTransactionFiltersChange(evt) {
      const form = evt.currentTarget?.form || qs("#transaction-filter-form");
      if (!form) return;
      state.transactionFilters = {
        start: form.startDate?.value ?? "",
        end: form.endDate?.value ?? "",
        month: form.month?.value ?? "",
        year: form.year?.value ?? "",
        type: form.type?.value ?? "all",
        parametro: form.parametro?.value ?? "all",
        descriptionSearch: form.descriptionSearch?.value ?? ""
      };
      applyTransactionFilters();
    }

    function handleClearTransactionFilters() {
      clearTransactionFilters();
    }

    async function handleTransactionCategoryChange(evt) {
      const select = evt.target.closest("select[data-transaction-category]");
      if (!select) return;
      const id = select.dataset.transactionCategory;
      const tx = allTransactions.find((item) => item.id === id);
      if (!tx) return;
      try {
        const nextCategory = select.value;
        const { db, fns } = await getFirebase();
        const companyId = tx.clinicId || tx.companyId || "";
        if (!companyId) {
          showToast("Empresa nao encontrada para o lancamento.", "error");
          return;
        }
        await fns.updateDoc(fns.doc(db, "companies", companyId, "transactions", id), {
          category: nextCategory,
          parametro: resolveParametro(nextCategory) || ""
        });
        invalidateTransactionCache();
        await refreshTransactionsAndDashboard();
      } catch (error) {
        console.error(error);
        showToast("Falha ao atualizar categoria.", "error");
      }
    }

    function updateFilteredDeleteButton() {
      const button = qs("#delete-filtered-transactions");
      if (!button) return;
      const shouldShow = hasActiveTransactionFilters();
      button.classList.toggle("hidden", !shouldShow);
    }

    function hasActiveVendasDateFilters() {
      const { start, end } = state.vendasFilters;
      return Boolean(start || end);
    }

    function updateFilteredVendasDeleteButton() {
      const button = qs("#delete-filtered-vendas");
      if (!button) return;
      button.classList.toggle("hidden", !hasActiveVendasDateFilters());
    }

    async function deleteFilteredTransactions() {
      if (!hasActiveTransactionFilters()) return;
      const confirmDelete = confirm("Excluir todos os lancamentos do filtro atual?");
      if (!confirmDelete) return;
      try {
        const { db, fns } = await getFirebase();
        const { writeBatch, doc } = fns;
        let deleted = 0;

        if (state.transactionFilters.descriptionSearch || state.transactionFilters.parametro !== "all") {
          const items = filteredTransactions.slice();
          const batchSize = 450;
          for (let i = 0; i < items.length; i += batchSize) {
            const batch = writeBatch(db);
            items.slice(i, i + batchSize).forEach((tx) => {
              const companyId = tx.clinicId || tx.companyId || "";
              if (!companyId) return;
              batch.delete(doc(db, "companies", companyId, "transactions", tx.id));
              deleted += 1;
            });
            await batch.commit();
          }
        } else {
          const filters = resolveTransactionDeleteFilters();
          let startAfterDoc = null;
          let hasMore = true;
          while (hasMore) {
            const q = await buildTransactionsQuery(filters, { startAfterDoc, limit: 500 });
            const snap = await fns.getDocs(q);
            if (snap.empty) break;
            const batch = writeBatch(db);
            snap.docs.forEach((docSnap) => {
              batch.delete(docSnap.ref);
              deleted += 1;
            });
            await batch.commit();
            startAfterDoc = snap.docs[snap.docs.length - 1] || null;
            hasMore = snap.docs.length === 500;
            await new Promise((resolve) => setTimeout(resolve, 0));
          }
        }
        invalidateTransactionCache();
        clearTransactionFilters();
        await refreshTransactionsAndDashboard();
        showToast(`Extrato filtrado excluido (${deleted} lancamento(s)).`);
      } catch (error) {
        console.error(error);
        showToast("Falha ao excluir extrato.", "error");
      }
    }

    async function deleteFilteredVendas() {
      if (!hasActiveVendasDateFilters()) return;
      const confirmDelete = confirm("Excluir todas as vendas do filtro atual?");
      if (!confirmDelete) return;
      try {
        const { db, fns } = await getFirebase();
        const { writeBatch, doc } = fns;
        const items = applyVendasFilters(getVisibleVendas());
        if (!items.length) {
          showToast("Nenhuma venda filtrada para excluir.", "error");
          return;
        }
        let deleted = 0;
        const batchSize = 450;
        for (let i = 0; i < items.length; i += batchSize) {
          const batch = writeBatch(db);
          items.slice(i, i + batchSize).forEach((venda) => {
            const companyId = venda.companyId || venda.clinicId || "";
            if (!companyId || !venda.id) return;
            batch.delete(doc(db, "companies", companyId, "vendas", venda.id));
            deleted += 1;
          });
          await batch.commit();
        }
        await loadVendas(state.user);
        renderVendas();
        updateDashboard();
        showToast(`Vendas filtradas excluidas (${deleted} venda(s)).`);
      } catch (error) {
        console.error(error);
        showToast("Falha ao excluir vendas.", "error");
      }
    }

    async function handleCategoryMappingCreation(evt) {
      evt.preventDefault();
      const form = evt.target;
      const source = form.sourceCategory.value.trim();
      const targetId = form.targetCategory.value;
      if (!source || !targetId) return;
      if (categoryMappings.some((map) => map.source === source)) {
        showToast("Essa categoria j\u00e1 foi mapeada.", "error");
        return;
      }
      const targetCategory = dashboardCategories.find((cat) => cat.id === targetId);
      try {
        const { db, fns } = await getFirebase();
        const { doc, setDoc } = fns;
        const companyId = resolveScopedCompanyId();
        if (!companyId) {
          showToast("Selecione uma empresa.", "error");
          return;
        }
        const ref = doc(getCompanyCollectionRef(db, fns, companyId, "categoryMappings"));
        await setDoc(ref, {
          id: ref.id,
          source,
          targetId,
          parametro: targetCategory?.accountingName || ""
        });
        await loadCategoryMappings();
        form.reset();
        refreshUI();
        showToast("Mapeamento salvo!");
      } catch (error) {
        console.error(error);
        showToast("Falha ao salvar mapeamento.", "error");
      }
    }

    async function handleCategoryMappingRemove(evt) {
      const id = evt.target.dataset.removeMapping;
      if (!id) return;
      try {
        const { db, fns } = await getFirebase();
        const companyId = resolveScopedCompanyId();
        if (!companyId) {
          showToast("Selecione uma empresa.", "error");
          return;
        }
        await fns.deleteDoc(fns.doc(db, "companies", companyId, "categoryMappings", id));
        await loadCategoryMappings();
        refreshUI();
        showToast("Mapeamento removido.");
      } catch (error) {
        console.error(error);
        showToast("Falha ao remover mapeamento.", "error");
      }
    }

    async function handleDashboardCategoryCreate(evt) {
      evt.preventDefault();
      const form = evt.target;
      const name = form.dashboardCategoryName.value.trim();
      if (!name) return;
      try {
        const created = await addDashboardCategory(name);
        if (!created) {
          showToast("Selecione uma empresa.", "error");
          return;
        }
        form.reset();
        renderDashboardCategories();
        renderCategoryMappings();
        applyTransactionFilters();
        updateDashboard();
        showToast("Categoria adicionada!");
      } catch (error) {
        console.error(error);
        showToast("Falha ao adicionar categoria.", "error");
      }
    }

    async function handleDashboardCategoryActions(evt) {
      const editId = evt.target.dataset.editDashboard;
      const removeId = evt.target.dataset.removeDashboard;
      const saveId = evt.target.dataset.saveDashboard;
      const companyId = resolveScopedCompanyId();
      if (!companyId) {
        showToast("Selecione uma empresa.", "error");
        return;
      }
      if (saveId) {
        const cat = dashboardCategories.find((c) => c.id === saveId);
        if (!cat) return;
        const input = evt.target.closest(".account-group-pill")?.querySelector(".association-input");
        const parametro = input ? input.value.trim() : (cat.accountingName || "");
        try {
          const { db, fns } = await getFirebase();
          await fns.updateDoc(fns.doc(db, "companies", companyId, "dashboardCategories", saveId), { accountingName: parametro });
          const existing = categoryMappings.find((map) => map.source === cat.name);
          if (existing) {
            await fns.updateDoc(fns.doc(db, "companies", companyId, "categoryMappings", existing.id), {
              targetId: saveId,
              parametro
            });
          } else {
            const ref = fns.doc(getCompanyCollectionRef(db, fns, companyId, "categoryMappings"));
            await fns.setDoc(ref, {
              id: ref.id,
              source: cat.name,
              targetId: saveId,
              parametro
            });
          }
          await ensureDashboardCategories();
          await loadCategoryMappings();
          refreshUI();
          showToast("Associa\u00e7\u00e3o salva!");
        } catch (error) {
          console.error(error);
          showToast("Falha ao salvar associacao.", "error");
        }
        return;
      }
      if (editId) {
        const cat = dashboardCategories.find((c) => c.id === editId);
        if (!cat) return;
        const previousName = cat.name;
        const next = prompt("Novo nome da categoria:", cat.name);
        if (!next || !next.trim()) return;
        try {
          const { db, fns } = await getFirebase();
          await fns.updateDoc(fns.doc(db, "companies", companyId, "dashboardCategories", editId), { name: next.trim() });
          const affected = categoryMappings.filter((map) => map.source === previousName);
          await Promise.all(affected.map((map) =>
            fns.updateDoc(fns.doc(db, "companies", companyId, "categoryMappings", map.id), { source: next.trim() })
          ));
          await ensureDashboardCategories();
          await loadCategoryMappings();
          renderDashboardCategories();
          renderCategoryMappings();
          applyTransactionFilters();
          updateDashboard();
          showToast("Categoria atualizada!");
        } catch (error) {
          console.error(error);
          showToast("Falha ao atualizar categoria.", "error");
        }
        return;
      }
      if (removeId) {
        try {
          const { db, fns } = await getFirebase();
          const removedCategory = dashboardCategories.find((c) => c.id === removeId);
          await fns.deleteDoc(fns.doc(db, "companies", companyId, "dashboardCategories", removeId));
          const toRemove = categoryMappings.filter((map) =>
            map.targetId === removeId || (removedCategory && map.source === removedCategory.name)
          );
          await Promise.all(toRemove.map((map) =>
            fns.deleteDoc(fns.doc(db, "companies", companyId, "categoryMappings", map.id))
          ));
          await ensureDashboardCategories();
          await loadCategoryMappings();
          renderDashboardCategories();
          renderCategoryMappings();
          applyTransactionFilters();
          updateDashboard();
          showToast("Categoria removida.");
        } catch (error) {
          console.error(error);
          showToast("Falha ao remover categoria.", "error");
        }
      }
    }

    async function handleDashboardCategoryAssociationInput(evt) {
      const id = evt.target.dataset.assocDashboard;
      if (!id) return;
      const value = evt.target.value;
      try {
        const { db, fns } = await getFirebase();
        const companyId = resolveScopedCompanyId();
        if (!companyId) return;
        await fns.updateDoc(fns.doc(db, "companies", companyId, "dashboardCategories", id), { accountingName: value });
        await ensureDashboardCategories();
      } catch (error) {
        console.error(error);
      }
    }
    async function handleCategory(evt) {
      evt.preventDefault();
      const value = evt.target.categoryName.value.trim();
      if (!value) return;
      try {
        const companyId = resolveScopedCompanyId();
        if (!companyId) {
          showToast("Selecione uma empresa.", "error");
          return;
        }
        await createCategory(value, companyId);
        evt.target.reset();
        renderCategoryTags();
        showToast("Categoria adicionada.");
      } catch (error) {
        console.error(error);
        showToast("Falha ao adicionar categoria.", "error");
      }
    }

    async function handleCategoryRemove(evt) {
      const cat = evt.target.dataset.remove;
      if (!cat) return;
      try {
        await deleteCategoryByName(cat);
        renderCategoryTags();
      } catch (error) {
        console.error(error);
        showToast("Falha ao remover categoria.", "error");
      }
    }

    function setEmpresaFormMode(isEditing) {
      const form = qs("#empresa-form");
      if (!form) return;
      const button = form.querySelector("button[type='submit']");
      if (button) {
        button.textContent = isEditing ? "Salvar Alteracoes" : "Cadastrar Empresa";
      }
    }

    function updateEmpresaRegimeFields() {
      const form = qs("#empresa-form");
      if (!form) return;
      const regime = form.empresaRegime?.value || "";
      const simplesWrap = qs("#empresa-simples-fields");
      const lucroWrap = qs("#empresa-lucro-fields");
      const simplesSelect = qs("#empresa-simples-anexo");
      const aliquotaInput = qs("#empresa-aliquota-hospitalar");
      const issInput = qs("#empresa-iss-fixo");
      const issAliquotaInput = qs("#empresa-iss-aliquota");
      const isSimples = regime === "simples_nacional";
      const isLucro = regime === "lucro_presumido";
      simplesWrap?.classList.toggle("hidden", !isSimples);
      lucroWrap?.classList.toggle("hidden", !isLucro);
      if (simplesSelect) simplesSelect.required = isSimples;
      if (!isSimples && simplesSelect) simplesSelect.value = "";
      if (!isLucro) {
        if (aliquotaInput) aliquotaInput.checked = false;
        if (issInput) issInput.checked = false;
        if (issAliquotaInput) issAliquotaInput.value = "";
      }
      updateEmpresaIssValorField();
    }

    function sanitizeEmpresaIssAliquota() {
      const input = qs("#empresa-iss-aliquota");
      if (!input || input.value === "") return;
      const value = Number(input.value);
      if (!Number.isFinite(value) || value < 0 || value > 100) {
        input.value = "";
      }
    }

    function updateEmpresaIssValorField() {
      const form = qs("#empresa-form");
      if (!form) return;
      const issInput = qs("#empresa-iss-fixo");
      const issValueField = qs("#empresa-iss-valor-field");
      const issValueInput = qs("#empresa-iss-valor");
      const issAliquotaField = qs("#empresa-iss-aliquota-field");
      const issAliquotaInput = qs("#empresa-iss-aliquota");
      const isLucro = form.empresaRegime?.value === "lucro_presumido";
      const isIssFixo = issInput?.checked === true;
      const showIssValue = isLucro && isIssFixo;
      const showAliquota = isLucro;
      issValueField?.classList.toggle("active", Boolean(showIssValue));
      issAliquotaField?.classList.toggle("active", Boolean(showAliquota));
      if (issValueInput) issValueInput.required = Boolean(showIssValue);
      if (!showIssValue && issValueInput) issValueInput.value = "";
      if (issAliquotaInput) {
        issAliquotaInput.disabled = Boolean(isIssFixo || !isLucro);
        if (isIssFixo || !isLucro) issAliquotaInput.value = "";
      }
      if (isLucro && !isIssFixo) sanitizeEmpresaIssAliquota();
    }

    function startEmpresaEdit(id) {
      const empresa = empresas.find((item) => item.id === id);
      if (!empresa) return;
      const form = qs("#empresa-form");
      if (!form) return;
      form.dataset.editingId = empresa.id;
      form.dataset.logoUrl = empresa.logoUrl || "";
      form.empresaNome.value = empresa.nome || "";
      form.empresaCnpj.value = empresa.cnpj || "";
      form.empresaLivro.value = empresa.livroCaixa ? "sim" : "nao";
      form.empresaRegime.value = empresa.regimeTributario || "";
      form.empresaSimplesAnexo.value = empresa.simplesAnexo || "";
      form.empresaAliquotaHospitalar.checked = empresa.aliquotaHospitalar === true;
      form.empresaIssFixo.checked = empresa.issFixo === true;
      form.empresaIssValor.value = empresa.issValor ? String(empresa.issValor) : "";
      form.empresaIssAliquota.value = empresa.issAliquota ? String(empresa.issAliquota) : "";
      if (form.empresaLogo) form.empresaLogo.value = "";
      updateEmpresaRegimeFields();
      setEmpresaFormMode(true);
      showToast("Editando empresa.");
    }

    function resetEmpresaForm(form) {
      form.reset();
      delete form.dataset.editingId;
      delete form.dataset.logoUrl;
      updateEmpresaRegimeFields();
      if (form.empresaIssValor) form.empresaIssValor.value = "";
      if (form.empresaIssAliquota) form.empresaIssAliquota.value = "";
      setEmpresaFormMode(false);
    }

    async function addEmpresa(form) {
      setLoading(true);
      try {
        const nome = form.empresaNome.value.trim();
        const cnpj = form.empresaCnpj.value.trim();
        const livroCaixa = form.empresaLivro.value === "sim";
        const regimeTributario = form.empresaRegime?.value || "";
        const simplesAnexo = form.empresaSimplesAnexo?.value || "";
        const aliquotaHospitalar = form.empresaAliquotaHospitalar?.checked === true;
        const issFixo = form.empresaIssFixo?.checked === true;
        const issValor = Number(form.empresaIssValor?.value) || 0;
        const issAliquotaRaw = form.empresaIssAliquota?.value || "";
        const issAliquotaValue = Number(issAliquotaRaw);
        const issAliquotaValid = issAliquotaRaw !== ""
          && Number.isFinite(issAliquotaValue)
          && issAliquotaValue >= 0
          && issAliquotaValue <= 100;
        if (!issAliquotaValid && form.empresaIssAliquota) {
          form.empresaIssAliquota.value = "";
        }
        const logoFile = form.empresaLogo?.files?.[0];
        const isEditing = Boolean(form.dataset.editingId);
        if (!nome || !cnpj || !regimeTributario) {
          showToast("Preencha nome, CNPJ e regime tributario.");
          return;
        }
        if (regimeTributario === "simples_nacional" && !simplesAnexo) {
          showToast("Selecione o anexo do Simples Nacional.");
          return;
        }
        if (regimeTributario === "lucro_presumido" && issFixo && !form.empresaIssValor?.value) {
          showToast("Informe o valor do ISS Fixo.");
          return;
        }

        const { db, storage, fns } = await getFirebase();
        const { collection, doc, setDoc, updateDoc, ref, uploadBytes, getDownloadURL, deleteObject } = fns;
        const companyRef = isEditing
          ? doc(db, "companies", form.dataset.editingId)
          : doc(collection(db, "companies"));
        let logoUrl = form.dataset.logoUrl || "";

        if (logoFile) {
          const logoRef = ref(storage, `companies/${companyRef.id}/logo`);
          try { await deleteObject(logoRef); } catch (error) {}
          try { await deleteObject(ref(storage, `companies/${companyRef.id}`)); } catch (error) {}
          await uploadBytes(logoRef, logoFile);
          logoUrl = await getDownloadURL(logoRef);
        }

        const payload = {
          name: nome,
          cnpj,
          hasLivroCaixa: livroCaixa,
          regimeTributario,
          updatedAt: new Date().toISOString()
        };
        if (regimeTributario === "simples_nacional") {
          payload.simplesAnexo = simplesAnexo;
          payload.aliquotaHospitalar = false;
          payload.issFixo = false;
          payload.issValor = 0;
          payload.issAliquota = 0;
        } else if (regimeTributario === "lucro_presumido") {
          payload.simplesAnexo = "";
          payload.aliquotaHospitalar = aliquotaHospitalar;
          payload.issFixo = issFixo;
          payload.issValor = issFixo ? issValor : 0;
          payload.issAliquota = issFixo ? 0 : (issAliquotaValid ? issAliquotaValue : 0);
        }
        if (logoFile || !isEditing) {
          payload.logoUrl = logoUrl || "";
        }

        if (isEditing) {
          await updateDoc(companyRef, payload);
        } else {
          await setDoc(companyRef, {
            id: companyRef.id,
            ...payload,
            createdAt: new Date().toISOString()
          });
        }

        await loadCompanies(state.user);
        renderAccountGroupFilter();
        populateCompanySwitcher();
        renderCompanyBrand();
        renderEmpresasTable();
        syncUserCompanyOptions();
        resetEmpresaForm(form);
        showToast(isEditing ? "Empresa atualizada com sucesso." : "Empresa cadastrada com sucesso.");
      } catch (error) {
        console.error(error);
        showToast("Erro ao salvar empresa.", "error");
      } finally {
        setLoading(false);
      }
    }

    async function deleteEmpresa(id) {
      const empresa = empresas.find((item) => item.id === id);
      if (!empresa) return;
      const hasActiveUsers = users.some((user) =>
        user.active !== false &&
        user.role === "client" &&
        (user.clinicId === id || user.companyId === id)
      );
      if (hasActiveUsers) {
        showToast("Nao e possivel excluir: ha usuarios ativos vinculados.", "error");
        return;
      }
      const confirmDelete = confirm("Tem certeza que deseja excluir esta empresa? Esta a\u00e7\u00e3o n\u00e3o poder\u00e1 ser desfeita.");
      if (!confirmDelete) return;
      try {
        const { db, storage, fns } = await getFirebase();
        const { deleteObject, ref } = fns;
        if (empresa.logoUrl) {
          try { await deleteObject(ref(storage, `companies/${id}/logo`)); } catch (error) {}
          try { await deleteObject(ref(storage, `companies/${id}`)); } catch (error) {}
        }
        await fns.deleteDoc(fns.doc(db, "companies", id));
        await loadCompanies(state.user);
        renderEmpresas();
        renderAccountGroupFilter();
        populateCompanySwitcher();
        renderCompanyBrand();
        syncUserCompanyOptions();
        showToast("Empresa removida.");
      } catch (error) {
        console.error(error);
        showToast("Falha ao remover empresa.", "error");
      }
    }

    function buildRegimeDetail(empresa) {
      if (empresa.regimeTributario === "simples_nacional") {
        return empresa.simplesAnexo ? `Anexo ${empresa.simplesAnexo}` : "-";
      }
      if (empresa.regimeTributario === "lucro_presumido") {
        const details = [];
        if (empresa.issFixo) details.push("ISS Fixo");
        if (empresa.aliquotaHospitalar) details.push("Aliquota Hospitalar");
        return details.length ? details.join(" / ") : "-";
      }
      return "-";
    }

    function renderEmpresas() {
      const tbody = qs("#empresas-table tbody");
      if (!tbody) return;
      if (!empresas.length) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted)">Nenhuma empresa cadastrada.</td></tr>`;
        return;
      }
      const isAdmin = state.user?.role === "admin";
      tbody.innerHTML = empresas.map((empresa) => {
        const badgeClass = empresa.livroCaixa ? "ok" : "neutral";
        const badgeLabel = empresa.livroCaixa ? "Sim" : "N\u00e3o";
        const logoCell = empresa.logoUrl
          ? `<img src="${empresa.logoUrl}" alt="Logo ${escapeHtml(empresa.nome)}" style="width:44px;height:44px;object-fit:cover;border-radius:10px;border:1px solid rgba(148,163,184,0.2)">`
          : `<span style="color:var(--muted)">-</span>`;
        const regimeLabel = empresa.regimeTributario === "simples_nacional"
          ? "Simples"
          : (empresa.regimeTributario === "lucro_presumido" ? "Lucro Presumido" : "-");
        const detailLabel = buildRegimeDetail(empresa);
        const actionsCell = isAdmin
          ? `<div style="display:flex;gap:0.5rem;flex-wrap:wrap">
              <button class="btn-secondary" style="width:auto;padding:0.35rem 0.75rem" data-edit-empresa="${empresa.id}">Editar</button>
              <button class="btn-secondary" style="width:auto;padding:0.35rem 0.75rem" data-remove-empresa="${empresa.id}">Excluir</button>
            </div>`
          : `<span style="color:var(--muted)">-</span>`;
        return `
          <tr>
            <td>${logoCell}</td>
            <td>${escapeHtml(empresa.nome)}</td>
            <td>${escapeHtml(empresa.cnpj)}</td>
            <td><span class="badge ${badgeClass}">${badgeLabel}</span></td>
            <td>${escapeHtml(regimeLabel)}</td>
            <td>${escapeHtml(detailLabel)}</td>
            <td>${actionsCell}</td>
          </tr>`;
      }).join("");
    }

    function renderCompaniesTable() {
      renderEmpresas();
    }

    function populateCompanySelects() {
      const select = document.getElementById("user-company");
      if (!select) return;
      select.innerHTML = `<option value="">Selecione</option>`;
      empresas.forEach((empresa) => {
        const opt = document.createElement("option");
        opt.value = empresa.id;
        opt.textContent = empresa.nome;
        select.appendChild(opt);
      });
    }

    function renderEmpresasTable() {
      renderEmpresas();
    }

    function syncUserCompanyOptions(selectedId = "") {
      const select = qs("#user-company");
      if (!select) return;
      if (!empresas.length) {
        select.innerHTML = `<option value="">Nenhuma empresa cadastrada</option>`;
        select.value = "";
        select.disabled = true;
        return;
      }
      select.disabled = false;
      const sorted = [...empresas].sort((a, b) => a.nome.localeCompare(b.nome));
      select.innerHTML = sorted
        .map((empresa) => {
          const selected = empresa.id === selectedId ? "selected" : "";
          return `<option value="${empresa.id}" ${selected}>${escapeHtml(empresa.nome)}</option>`;
        })
        .join("");
      select.value = selectedId || sorted[0].id;
    }

    function updateUserFormType() {
      const form = qs("#user-form");
      if (!form) return;
      const isClient = form.userRole.value === "client";
      const field = qs("#user-company-field");
      field?.classList.toggle("active", isClient);
      form.userPassword.required = !form.dataset.editingId;
      if (isClient) {
        syncUserCompanyOptions(form.userCompany?.value || "");
        form.userCompany.required = true;
      } else {
        form.userCompany.required = false;
      }
    }

    async function addOrUpdateUser(form) {
      const editingId = form.dataset.editingId || "";
      const name = form.userName.value.trim();
      const username = form.userUsername.value.trim();
      const password = form.userPassword.value.trim();
      const role = form.userRole.value;
      const companyId = role === "client" ? form.userCompany.value : "";
      const needsPassword = !editingId;
      if (!name || !username || (needsPassword && !password) || !role) {
        showToast("Preencha todos os campos obrigatorios.", "error");
        return;
      }
      if (role === "client" && !companyId) {
        showToast("Selecione a empresa vinculada.", "error");
        return;
      }
      const existingUsername = users.find((user) =>
        user.username === username && user.id !== editingId
      );
      if (existingUsername) {
        showToast("Esse usuario ja existe.", "error");
        return;
      }
      try {
        const { db, authFns, secondaryAuth, fns } = await getFirebase();
        if (editingId) {
          const existing = users.find((user) => user.id === editingId);
          await fns.updateDoc(fns.doc(db, "users", editingId), {
            name,
            username,
            role,
            companyId: role === "client" ? companyId : "",
            active: existing ? existing.active : true
          });
          showToast("Usuario atualizado!");
        } else {
          const cred = await authFns.createUserWithEmailAndPassword(secondaryAuth, username, password);
          const userId = cred.user.uid;
          await fns.setDoc(fns.doc(db, "users", userId), {
            id: userId,
            name,
            username,
            role,
            companyId: role === "client" ? companyId : "",
            active: true
          });
          await authFns.signOut(secondaryAuth);
          showToast("Usuario cadastrado!");
        }
        form.reset();
        delete form.dataset.editingId;
        updateUserFormType();
        await loadUsers(state.user);
        renderUsers();
      } catch (error) {
        console.error(error);
        showToast("Falha ao salvar usuario.", "error");
      }
    }

    async function toggleUserStatus(id) {
      const user = users.find((item) => item.id === id);
      if (!user) return;
      try {
        const { db, fns } = await getFirebase();
        await fns.updateDoc(fns.doc(db, "users", id), { active: !user.active });
        await loadUsers(state.user);
        renderUsers();
        showToast("Status atualizado!");
      } catch (error) {
        console.error(error);
        showToast("Falha ao atualizar status.", "error");
      }
    }

    function startUserEdit(id) {
      const user = users.find((item) => item.id === id);
      if (!user) return;
      const form = qs("#user-form");
      if (!form) return;
      form.dataset.editingId = user.id;
      form.userName.value = user.name || "";
      form.userUsername.value = user.username || "";
      form.userPassword.value = "";
      form.userRole.value = user.role || "client";
      form.userPassword.required = false;
      updateUserFormType();
      if (user.role === "client") {
        syncUserCompanyOptions(user.clinicId || "");
      }
      showToast("Editando usuario.");
    }

    function renderUsers() {
      const tbody = qs("#users-table tbody");
      if (!tbody) return;
      if (!users.length) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--muted)">Nenhum usuario cadastrado.</td></tr>`;
        return;
      }
      const empresaMap = new Map(empresas.map((empresa) => [empresa.id, empresa.nome]));
      tbody.innerHTML = users.map((user) => {
        const tipoLabel = user.role === "admin" ? "BPO" : "Cliente";
        const empresaLabel = user.role === "client"
          ? (empresaMap.get(user.clinicId) || clinics.find((c) => c.id === user.clinicId)?.name || "-")
          : "-";
        const statusClass = user.active ? "ok" : "neutral";
        const statusLabel = user.active ? "Ativo" : "Inativo";
        const toggleLabel = user.active ? "Desativar" : "Ativar";
        return `
          <tr>
            <td>${escapeHtml(user.name || "-")}</td>
            <td>${escapeHtml(user.username)}</td>
            <td>${tipoLabel}</td>
            <td>${escapeHtml(empresaLabel)}</td>
            <td><span class="badge ${statusClass}">${statusLabel}</span></td>
            <td style="display:flex;gap:0.5rem;flex-wrap:wrap">
              <button class="btn-secondary" style="width:auto;padding:0.35rem 0.75rem" data-edit-user="${user.id}">Editar</button>
              <button class="btn-secondary" style="width:auto;padding:0.35rem 0.75rem" data-toggle-user="${user.id}">${toggleLabel}</button>
            </td>
          </tr>`;
      }).join("");
    }

    async function handleTableActions(evt) {
      const action = evt.target.dataset.action;
      const id = evt.target.dataset.id;
      if (!action) return;
      if (action === "delete") {
        const confirmDelete = confirm("Excluir este lancamento?");
        if (!confirmDelete) return;
        try {
          const { db, fns } = await getFirebase();
          const tx = allTransactions.find((item) => item.id === id);
          const companyId = tx?.clinicId || tx?.companyId || "";
          if (!companyId) {
            showToast("Empresa nao encontrada para o lancamento.", "error");
            return;
          }
          await fns.deleteDoc(fns.doc(db, "companies", companyId, "transactions", id));
          invalidateTransactionCache();
          await refreshTransactionsAndDashboard();
          showToast("Lancamento excluido.");
          refreshUI();
        } catch (error) {
          console.error(error);
          showToast("Falha ao excluir lancamento.", "error");
        }
      }
      if (action === "edit") {
        const tx = allTransactions.find((t) => t.id === id);
        if (!tx) return;
        const value = Number(prompt("Novo valor (R$):", tx.amount));
        if (!Number.isFinite(value)) return;
        try {
          const { db, fns } = await getFirebase();
          const companyId = tx.clinicId || tx.companyId || "";
          if (!companyId) {
            showToast("Empresa nao encontrada para o lancamento.", "error");
            return;
          }
          await fns.updateDoc(fns.doc(db, "companies", companyId, "transactions", id), { amount: value });
          invalidateTransactionCache();
          await refreshTransactionsAndDashboard();
          showToast("Lancamento atualizado.");
          refreshUI();
        } catch (error) {
          console.error(error);
          showToast("Falha ao atualizar lancamento.", "error");
        }
      }
    }

    function canAccessSection(sectionId) {
      if (!state.user) return false;
      if (state.user.role === "admin") return true;
      return ["overview", "indicadores"].includes(sectionId);
    }

    function handleSectionChange(evt) {
      const btn = evt.target.closest("button[data-section]");
      if (!btn) return;
      if (!canAccessSection(btn.dataset.section)) {
        showToast("Acesso restrito para este perfil.", "error");
        return;
      }
      if (btn.dataset.section === "indicadores") {
        initIndicadoresFilters();
      }
      qsa("nav button").forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      const target = `${btn.dataset.section}-section`;
      qsa("main > section").forEach((section) => {
        section.classList.toggle("hidden", section.id !== target);
      });
    }

    async function handleLogout() {
      try {
        const { auth, authFns } = await getFirebase();
        await authFns.signOut(auth);
      } catch (error) {
        console.error(error);
      }
      stopTransactionListener();
      state.user = null;
      overviewDefaultApplied = false;
      users = [];
      empresas = [];
      clinics = [];
      allTransactions = [];
      filteredTransactions = [];
      vendas = [];
      categories = [];
      dashboardCategories = [];
      categoryMappings = [];
      accountGroups = [];
      accountRegistry = [];
      invalidateTransactionCache();
      qsa("[data-section]").forEach((btn, idx) => {
        btn.classList.toggle("active", idx === 0);
      });
      qsa("main > section").forEach((section, idx) => {
        section.classList.toggle("hidden", idx !== 0);
      });
      qs("#dashboard").classList.add("hidden");
      qs("#login-view").classList.remove("hidden");
      qs("#login-form").reset();
      closeClientModal();
      showToast("Sess\u00e3o encerrada.");
    }

    function handleFileImport(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const ext = file.name.split(".").pop().toLowerCase();
      if (ext === "csv") {
        const reader = new FileReader();
        setLoading(true);
        reader.onload = async () => {
          try {
            const imported = parseCsv(reader.result);
            const importedOk = await ingestImportedTransactions(imported);
            if (importedOk) evt.target.value = "";
          } catch (error) {
            console.error(error);
            showToast("Falha ao importar CSV.", "error");
          } finally {
            setLoading(false);
          }
        };
        reader.readAsText(file, "utf-8");
        return;
      }
      if (["xls", "xlsx"].includes(ext)) {
        if (typeof XLSX === "undefined") {
          showToast("Suporte a planilhas n\u00e3o carregado.", "error");
          return;
        }
        const reader = new FileReader();
        setLoading(true);
        reader.onload = async () => {
          try {
            const workbook = XLSX.read(new Uint8Array(reader.result), { type: "array" });
            const imported = parseExtratoWorkbook(workbook);
            const importedOk = await ingestImportedTransactions(imported);
            if (importedOk) evt.target.value = "";
          } catch (error) {
            console.error(error);
            showToast("Falha ao importar extrato.", "error");
          } finally {
            setLoading(false);
          }
        };
        reader.readAsArrayBuffer(file);
        return;
      }
      showToast("Formato n\u00e3o suportado. Use CSV ou XLS/XLSX.", "error");
    }

    function handleImportButtonClick() {
      if (!resolveImportCompanyId()) {
        showToast("Selecione a empresa para importar.", "error");
        return;
      }
      const input = qs("#csvInput");
      const file = input?.files?.[0];
      if (!file) {
        showToast("Selecione um arquivo.", "error");
        return;
      }
      handleFileImport({ target: input });
    }

    function handleVendasImportButton(tipo, inputSelector) {
      if (!resolveImportCompanyId()) {
        showToast("Selecione a empresa para importar.", "error");
        return;
      }
      const input = qs(inputSelector);
      const file = input?.files?.[0];
      if (!file) {
        showToast("Selecione um arquivo.", "error");
        return;
      }
      importVendasFile(file, tipo, input);
    }

    function importVendasFile(file, tipo, input) {
      const ext = file.name.split(".").pop().toLowerCase();
      if (tipo === "Nota Fiscal") {
        if (!["csv", "xls", "xlsx"].includes(ext)) {
          showToast("Formato n\u00e3o suportado. Use CSV, XLS ou XLSX.", "error");
          return;
        }
        if (typeof XLSX === "undefined") {
          showToast("Suporte a planilhas n\u00e3o carregado.", "error");
          return;
        }
        if (ext === "csv") {
          const reader = new FileReader();
          reader.onload = async () => {
            try {
              const workbook = XLSX.read(reader.result, { type: "string", FS: ";", raw: true });
              const rows = parsePlanilhaWorkbook(workbook);
              const importedOk = await importarNotasFiscaisPlanilha(rows);
              if (importedOk && input) input.value = "";
            } catch (error) {
              console.error(error);
              showToast("Falha ao importar vendas.", "error");
            }
          };
          reader.readAsText(file, "utf-8");
          return;
        }
        const reader = new FileReader();
        reader.onload = async () => {
          try {
            const workbook = XLSX.read(new Uint8Array(reader.result), { type: "array" });
            const rows = parsePlanilhaWorkbook(workbook);
            const importedOk = await importarNotasFiscaisPlanilha(rows);
            if (importedOk && input) input.value = "";
          } catch (error) {
            console.error(error);
            showToast("Falha ao importar vendas.", "error");
          }
        };
        reader.readAsArrayBuffer(file);
        return;
      }
      if (!["csv", "xls", "xlsx"].includes(ext)) {
        showToast("Formato n\u00e3o suportado. Use CSV ou XLS/XLSX.", "error");
        return;
      }
      if (typeof XLSX === "undefined") {
        showToast("Suporte a planilhas n\u00e3o carregado.", "error");
        return;
      }
      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const workbook = XLSX.read(new Uint8Array(reader.result), { type: "array" });
          const imported = parseVendasWorkbook(workbook, tipo);
          const importedOk = await ingestImportedVendas(imported);
          if (importedOk && input) input.value = "";
        } catch (error) {
          console.error(error);
          showToast("Falha ao importar vendas.", "error");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function parseVendasWorkbook(workbook, tipo) {
      const sheets = workbook?.SheetNames ?? [];
      if (!sheets.length) return [];
      const sheet = workbook.Sheets[sheets[0]];
      return parseVendasSheet(sheet, tipo);
    }

    function parsePlanilhaWorkbook(workbook) {
      const sheets = workbook?.SheetNames ?? [];
      if (!sheets.length) return [];
      const sheet = workbook.Sheets[sheets[0]];
      if (!sheet) return [];
        const data = XLSX.utils.sheet_to_json(sheet, {
          raw: true,
          defval: ""
        });
        return data;
    }

    async function importarNotasFiscaisPlanilha(sheetData) {
      if (!sheetData || !sheetData.length) {
        showToast("Arquivo vazio ou inv\u00e1lido.", "error");
        return false;
      }
      const headers = Object.keys(sheetData[0]);
      const normalizedHeaders = headers.map((header) => normalizeHeader(header));
      const isLikelyName = (value) => {
        const text = value?.toString().trim();
        if (!text) return false;
        if (/^\d+$/.test(text)) return false;
        return /[A-Za-z\u00C0-\u00FF]/.test(text);
      };
      const pickColumn = (candidates) => {
        for (const candidate of candidates) {
          const index = normalizedHeaders.findIndex((header) => header.includes(candidate));
          if (index < 0) continue;
          const header = headers[index];
          if (sheetData.some((row) => isLikelyName(row[header]))) return header;
        }
        return "";
      };
      const pickColumnByIndex = (index) => {
        if (index < 0 || index >= headers.length) return "";
        const header = headers[index];
        if (!header) return "";
        return sheetData.some((row) => isLikelyName(row[header])) ? header : "";
      };
      const pacienteCol = pickColumn([
        "razao social do tomador",
        "nome do tomador",
        "razao social tomador",
        "razao social",
        "nome do cliente",
        "cliente",
        "paciente"
      ]) || pickColumnByIndex(29)
        || pickColumn(["tomador"]);
      const valorCol = findColumn(headers, [
        "valor servicos",
        "valor dos servicos",
        "valor",
        "total"
      ]);
      const numeroCol = findColumn(headers, [
        "nº da nota fiscal eletronica",
        "numero da nota fiscal eletronica",
        "numero da nota fiscal",
        "numero da nota",
        "nf",
        "nota fiscal"
      ]);
      const dataCol = findColumn(headers, [
        "data hora da emissao da nota fiscal",
        "data de emissao",
        "emissao",
        "data"
      ]) || headers[4] || "";
      if (!pacienteCol || !valorCol || !dataCol) {
        showToast("Modelo de NF-e n\u00e3o reconhecido.", "error");
        return false;
      }
      const vendasValidas = [];
      sheetData.forEach((row) => {
        const paciente = row[pacienteCol];
        const valorNF = parseNotaFiscalValor(row[valorCol]);
        const data = resolveDataNotaFiscal(row, headers);
        const numero = numeroCol && row[numeroCol]
          ? row[numeroCol].toString().trim()
          : "";
        if (!data || !paciente || valorNF <= 0) return;
        vendasValidas.push({
          id: crypto.randomUUID(),
          clinicId: state.user.clinicId || null,
          tipo: "Nota Fiscal",
          data,
          numero,
          paciente: paciente.toString().trim(),
          valor: valorNF
        });
      });
      if (!vendasValidas.length) {
        showToast("Nenhuma venda v\u00e1lida encontrada no arquivo.", "error");
        return false;
      }
      return await ingestImportedVendas(vendasValidas);
    }

    function parseVendasSheet(sheet, tipo) {
      if (!sheet) return [];
      const rawRows = XLSX.utils.sheet_to_json(sheet, { defval: "", header: 1 });
      if (!rawRows.length) return [];
      const headerInfo = tipo === "Recibo" ? findReciboHeaderRow(rawRows) : findVendasHeaderRow(rawRows);
      if (!headerInfo) return [];
      const headers = headerInfo.headers;
      const columnMap = mapVendasColumns(headers, tipo);
      return rawRows
        .slice(headerInfo.index + 1)
        .map((row) => mapVendasRow(row, columnMap, tipo, headers))
        .filter(Boolean);
    }

    function findVendasHeaderRow(rows) {
      if (!rows?.length) return null;
      const headers = rows[0]?.map((header) => header?.toString().trim() ?? "");
      return { index: 0, headers };
    }

    function findReciboHeaderRow(rows) {
      let best = null;
      rows.forEach((row, index) => {
        if (!row || !row.length) return;
        const headers = row.map((cell) => cell?.toString().trim() ?? "");
        const normalized = headers.map((header) => normalizeHeader(header));
        const hasData = normalized.some((h) => h.includes("data"));
        const hasValor = normalized.some((h) => h.includes("valor") || h.includes("credito"));
        const hasNumero = normalized.some((h) => h.includes("documento") || h.includes("recibo") || h.includes("doc") || h.includes("numero"));
        const hasPaciente = normalized.some((h) => h.includes("descricao") || h.includes("historico") || h.includes("paciente"));
        const score = [hasData, hasValor, hasNumero, hasPaciente].filter(Boolean).length;
        if (hasData && hasValor && (!best || score > best.score)) {
          best = { index, headers, score };
        }
      });
      return best ? { index: best.index, headers: best.headers } : null;
    }

    function mapVendasColumns(headers, tipo) {
      const normalizedHeaders = headers.map((header) => header?.toString() ?? "");
      if (tipo === "Recibo") {
        return {
          data: findColumnIndex(normalizedHeaders, ["data"]),
          numero: findColumnIndex(normalizedHeaders, [
            "documento",
            "numero do documento",
            "numero documento",
            "n documento",
            "n doc",
            "no doc",
            "nº doc",
            "num doc",
            "num documento",
            "nº rec",
            "n rec",
            "numero rec",
            "numero do rec",
            "numero do recibo",
            "numero recibo",
            "recibo",
            "numero"
          ]),
          paciente: findColumnIndex(normalizedHeaders, ["descricao", "historico", "paciente"]),
          valor: findColumnIndex(normalizedHeaders, ["valor", "credito"])
        };
      }
      return {
        data: findColumnIndex(normalizedHeaders, ["data", "data emissao", "data da emissao", "emissao", "data de emissao"]),
        numero: findColumnIndex(normalizedHeaders, ["numero", "numero da nf", "numero do recibo", "numero nota", "numero recibo", "nf", "nfe", "nota fiscal", "recibo"]),
        paciente: findColumnIndex(normalizedHeaders, ["paciente", "nome do paciente", "cliente", "nome"]),
        valor: findColumnIndex(normalizedHeaders, ["valor", "valor total", "total", "valor da nota", "valor do recibo", "valor bruto"])
      };
    }

    function findColumnIndex(headers, candidates) {
      const header = findColumn(headers, candidates);
      return header ? headers.findIndex((h) => h === header) : -1;
    }

    function mapVendasRow(row, columnMap, tipo, headers) {
      if (!row || !columnMap) return null;
      if (columnMap.data < 0 || columnMap.valor < 0) return null;
      if (tipo === "Recibo" && shouldIgnoreReciboRow(row, headers)) return null;
      const data = parseBrazilianDate(row[columnMap.data]);
      const valor = parseExtratoAmount(row[columnMap.valor]);
      if (!data || !Number.isFinite(valor) || valor <= 0) return null;
      const numeroRaw = columnMap.numero >= 0 ? row[columnMap.numero] : "";
      const pacienteRaw = columnMap.paciente >= 0 ? row[columnMap.paciente] : "";
      const numero = (numeroRaw ?? "").toString().trim() || (tipo === "Recibo" ? "-" : "");
      const paciente = (pacienteRaw ?? "").toString().trim() || (tipo === "Recibo" ? "Não identificado" : "");
      if (tipo !== "Recibo" && (!numero || !paciente)) return null;
      return {
        id: crypto.randomUUID(),
        clinicId: resolveVendasClinicId(),
        tipo,
        data,
        numero,
        paciente,
        valor: Math.abs(valor)
      };
    }

    function shouldIgnoreReciboRow(row, headers) {
      const normalizedLine = row
        .map((cell) => normalizeHeader(cell ?? ""))
        .join(" ");
      if (!normalizedLine.trim()) return true;
      if (/(saldo|total|subtotal|titulo|titulos|separador)/.test(normalizedLine)) return true;
      const headerLine = headers
        ? headers.map((cell) => normalizeHeader(cell ?? "")).join(" ")
        : "";
      if (headerLine && normalizedLine === headerLine) return true;
      const looksLikeHeader = normalizedLine.includes("data")
        && (normalizedLine.includes("valor") || normalizedLine.includes("credito"))
        && (normalizedLine.includes("documento") || normalizedLine.includes("recibo")
          || normalizedLine.includes("descricao") || normalizedLine.includes("historico")
          || normalizedLine.includes("paciente"));
      return looksLikeHeader;
    }

    function resolveVendasClinicId() {
      if (!state.user) return null;
      if (state.user.role !== "admin") return state.user.companyId || state.user.clinicId;
      const selectedCompany = getActiveCompanyId();
      if (selectedCompany) return selectedCompany;
      if (clinics.length === 1) return clinics[0].id;
      return null;
    }

    function normalizeVendaTipo(tipo = "") {
      const normalized = normalizeText(tipo);
      if (normalized.includes("recibo")) return "recibo";
      return "nota";
    }

    function shouldShowOrigem(categoryName, accountingName) {
      if (!accountingName) return false;
      if (accountingName.trim() === "") return false;
      if (accountingName === categoryName) return false;
      return true;
    }

    async function ingestImportedVendas(imported) {
      if (!Array.isArray(imported) || !imported.length) {
        showToast("Nenhuma venda v\u00e1lida encontrada.", "error");
        return false;
      }
      const forcedCompanyId = resolveImportCompanyId();
      if (!forcedCompanyId) {
        showToast("Selecione a empresa para importar.", "error");
        return false;
      }
      let added = 0;
      const { db, fns } = await getFirebase();
      const { doc, writeBatch } = fns;
      const CHUNK_SIZE = 500;
      for (let i = 0; i < imported.length; i += CHUNK_SIZE) {
        const batch = writeBatch(db);
        const chunk = imported.slice(i, i + CHUNK_SIZE);
        let batchHasWrites = false;
        for (const row of chunk) {
          if (!row || !row.data || !row.numero || !row.paciente || !Number.isFinite(row.valor)) continue;
          const companyId = forcedCompanyId;
          const ref = doc(getCompanyCollectionRef(db, fns, companyId, "vendas"));
          batch.set(ref, {
            id: ref.id,
            companyId,
            tipo: normalizeVendaTipo(row.tipo),
            numero: row.numero,
            paciente: row.paciente,
            valor: Math.abs(row.valor),
            data: row.data
          });
          added += 1;
          batchHasWrites = true;
        }
        if (batchHasWrites) {
          await batch.commit();
        }
        await new Promise((resolve) => setTimeout(resolve, 0));
      }
      if (!added) {
        showToast("Nenhuma venda v\u00e1lida encontrada.", "error");
        return false;
      }
      await loadVendas(state.user);
      showToast(`Importadas ${added} venda(s)!`);
      renderVendas();
      updateDashboard();
      return true;
    }


    function parseCsv(text) {
      if (!text) return [];
      const lines = text.trim().split(/\r?\n/);
      const entries = [];
      lines.forEach((line, index) => {
        if (!line.trim()) return;
        const parts = line.split(",");
        if (!parts.length) return;
        if (index === 0 && normalizeText(parts[1] ?? "") === "tipo") return;
        const [date, type, category, amountStr, clinicName, paymentMethod, expenseGroup, accountName, description] = parts;
        if (!date || !type || !category || !amountStr) return;
        const parsedDate = parseBrazilianDate(date);
        const normalizedType = normalizeText(type);
        const amount = parseExtratoAmount(amountStr);
        if (!parsedDate || !normalizedType || !Number.isFinite(amount)) return;
        const trimmedCategory = category.trim();
        const trimmedDescription = (description ?? "").trim() || trimmedCategory;
        entries.push({
          date: parsedDate,
          type: normalizedType,
          category: trimmedCategory,
          description: trimmedDescription,
          amount,
          clinicName: clinicName?.trim(),
          clinicId: "",
          paymentMethod: (paymentMethod ?? "").trim(),
          expenseGroup: (expenseGroup ?? "").trim(),
          accountName: (accountName ?? "").trim()
        });
      });
      return entries;
    }

    function parseExtratoWorkbook(workbook) {
      const sheets = workbook?.SheetNames ?? [];
      if (!sheets.length) return [];
      const sheet = workbook.Sheets[sheets[0]];
      return parseExtratoSheet(sheet);
    }

    function parseExtratoSheet(sheet) {
      if (!sheet) return [];
      const rawRows = XLSX.utils.sheet_to_json(sheet, { defval: "", header: 1 });
      if (!rawRows.length) return [];
      const headers = rawRows[0].map((header) => (header ?? "").toString());
      const rows = rawRows.slice(1).map((row) => {
        const mapped = {};
        headers.forEach((header, index) => {
          if (!header) return;
          mapped[header] = row[index] ?? "";
        });
        mapped.__colV = row[21];
        mapped.__colA = row[0];
        return mapped;
      });
      return rows.map((row) => mapExtratoRow(row)).filter(Boolean);
    }

    function mapExtratoRow(row) {
      const normalizedRow = {};
      Object.entries(row).forEach(([key, value]) => {
        if (key === "__colV") return;
        const normalizedKey = normalizeText(key);
        if (!normalizedKey) return;
        normalizedRow[normalizedKey] = value ?? "";
      });
      const columnVValue = row.__colV ?? row.V ?? row.v;
      const rawDate = row.__colA ?? normalizedRow["data movimento"];
      const rawType = normalizedRow["tipo da operacao"];
      const rawValue = normalizedRow["valor (r$)"];
      if (!rawDate || !rawType || rawValue === undefined || rawValue === null) return null;
      const date = parseBrazilianDate(rawDate);
      const type = mapExtratoType(rawType);
      const amount = parseExtratoAmount(rawValue);
      if (!date || !type || !Number.isFinite(amount)) return null;
      const description = (normalizedRow["descricao"] || normalizedRow["historico"] || normalizedRow["descricao do movimento"] || "Movimenta\u00e7\u00e3o").toString().trim();
      const rawCategory = normalizedRow["categoria"]
        || normalizedRow["categoria contabilidade"]
        || normalizedRow["categoria contabil"]
        || normalizedRow["categoria da contabilidade"]
        || columnVValue;
      const resolvedCategory = (rawCategory ?? "").toString().trim() || description;
      const account = normalizedRow["conta bancaria"] || normalizedRow["conta"];
      const payment = normalizedRow["forma de pgto/recbto"] || normalizedRow["forma de pagamento"];
      return {
        date,
        type,
        category: resolvedCategory,
        description,
        amount: Math.abs(amount),
        clinicName: account?.toString().trim() || "Conta importada",
        paymentMethod: type === "receita" ? mapPaymentMethod(payment || description) : "",
        expenseGroup: type === "despesa" ? inferExpenseGroup(description) : "",
        accountName: account?.toString().trim() || "Conta importada"
      };
    }

    async function ingestImportedTransactions(imported) {
      if (!Array.isArray(imported) || !imported.length) {
        showToast("Nenhum lan\u00e7amento v\u00e1lido encontrado.", "error");
        return false;
      }
      const forcedCompanyId = resolveImportCompanyId();
      if (!forcedCompanyId) {
        showToast("Selecione a empresa para importar.", "error");
        return false;
      }
      const newCategories = new Set();
      let added = 0;
      const CHUNK_SIZE = 500;
      const { db, fns } = await getFirebase();
      const { doc, writeBatch } = fns;
      for (let i = 0; i < imported.length; i += CHUNK_SIZE) {
        const chunk = imported.slice(i, i + CHUNK_SIZE);
        const batch = writeBatch(db);
        let batchHasWrites = false;
        for (const row of chunk) {
          if (!row || !row.date || !row.type || !row.category || !Number.isFinite(row.amount)) continue;
          const parsedDate = parseDateInput(row.date);
          if (Number.isNaN(parsedDate.getTime())) continue;
          const clinicId = forcedCompanyId;
          const paymentMethod = row.type === "receita" ? (row.paymentMethod || "").trim() : "";
          const expenseGroup = row.type === "despesa" ? (row.expenseGroup || "").trim() : "";
          const accountName = row.accountName?.trim() || "Conta importada";
          const ref = doc(getCompanyCollectionRef(db, fns, clinicId, "transactions"));
          batch.set(ref, {
            id: ref.id,
            companyId: clinicId,
            type: row.type,
            category: row.category,
            parametro: resolveParametro(row.category) || "",
            description: row.description || row.category,
            amount: Math.abs(row.amount),
            date: parsedDate,
            year: parsedDate.getFullYear(),
            month: parsedDate.getMonth() + 1,
            paymentMethod,
            expenseGroup,
            accountName
          });
          if (!categories.includes(row.category)) newCategories.add(row.category);
          added += 1;
          batchHasWrites = true;
        }
        if (batchHasWrites) {
          await batch.commit();
        }
        await new Promise((resolve) => setTimeout(resolve, 0));
      }
      if (!added) {
        showToast("Nenhum lan\u00e7amento v\u00e1lido encontrado.", "error");
        return false;
      }
      for (const category of newCategories) {
        await createCategory(category, forcedCompanyId);
      }
      invalidateTransactionCache();
      showToast(`Importados ${added} lan\u00e7amentos!`);
      await refreshTransactionsAndDashboard();
      refreshUI();
      return true;
    }

    async function resolveClinicId(row) {
      if (!state.user) return null;
      if (state.user.role !== "admin") return state.user.clinicId;
      const directId = row.clinicId?.trim();
      if (directId) {
        const clinicById = clinics.find((c) => c.id === directId);
        if (clinicById) return clinicById.id;
      }
      const name = row.clinicName?.trim();
      if (name) {
        const clinicByName = clinics.find((c) => c.name === name);
        if (clinicByName) return clinicByName.id;
        return await ensureCompanyByName(name);
      }
      const selectedCompany = getActiveCompanyId();
      if (selectedCompany) return selectedCompany;
      const fallback = "Conta importada";
      const fallbackClinic = clinics.find((c) => c.name === fallback);
      return fallbackClinic ? fallbackClinic.id : await ensureCompanyByName(fallback);
    }

    function downloadCsv(rows, filename) {
      const blob = new Blob([rows], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    function exportTransactions() {
      const rows = [["data", "tipo", "categoria", "valor", "clinica", "forma_pagamento", "grupo_despesa"]]
        .concat(getCurrentTransactionsPage().map((t) => [
          formatIsoLocal(parseDateInput(t.date)),
          t.type,
          t.category,
          t.amount,
          clinics.find((c) => c.id === t.clinicId)?.name ?? "",
          t.paymentMethod ?? "",
          t.expenseGroup ?? ""
        ]))
        .map((cols) => cols.join(","))
        .join("\n");
      downloadCsv(rows, "transacoes.csv");
    }

    initializeTheme();
    document.getElementById("theme-toggle").addEventListener("click", toggleTheme);
    const loginForm = document.getElementById("login-form");
    if (loginForm) loginForm.addEventListener("submit", handleLogin);
    document.getElementById("logout").addEventListener("click", handleLogout);
    const transactionForm = document.getElementById("transaction-form");
    if (transactionForm) {
      transactionForm.addEventListener("submit", handleTransaction);
      const typeSelect = transactionForm.querySelector("select[name='type']");
      typeSelect?.addEventListener("change", updateTransactionConditionalFields);
    }
    qsa('[data-role="filter-toolbar"] select').forEach((select) => {
      select.addEventListener("change", (evt) => {
        if (evt.target.id === "filter-account-group") {
          handleAccountGroupChange(evt);
        } else if (evt.target.id === "filter-period") {
          handlePeriodTypeChange(evt);
        } else if (evt.target.id === "filter-period-value") {
          handlePeriodValueChange(evt);
        } else if (evt.target.id === "filter-year") {
          handlePeriodYearChange(evt);
        }
        applyOverviewFilters();
      });
    });
    const chartModeSelect = document.getElementById("filter-chart-mode");
    if (chartModeSelect) {
      chartModeSelect.addEventListener("change", (evt) => {
        state.overviewChartFilters.mode = evt.target.value;
        updateChartYearVisibility();
        renderCashflowChart();
      });
    }
    const chartYearSelect = document.getElementById("filter-chart-year");
    if (chartYearSelect) {
      chartYearSelect.addEventListener("change", (evt) => {
        state.overviewChartFilters.year = evt.target.value;
        renderCashflowChart();
      });
    }
    const companySwitcher = document.getElementById("company-switcher");
    if (companySwitcher) companySwitcher.addEventListener("change", handleCompanySwitch);
    const categoryForm = document.getElementById("category-form");
    if (categoryForm) categoryForm.addEventListener("submit", handleCategory);
    const accountGroupForm = document.getElementById("account-group-form");
    if (accountGroupForm) accountGroupForm.addEventListener("submit", handleAccountGroupCreation);
    const categoryMappingForm = document.getElementById("category-mapping-form");
    if (categoryMappingForm) categoryMappingForm.addEventListener("submit", handleCategoryMappingCreation);
    const dashboardCategoryForm = document.getElementById("dashboard-category-form");
    if (dashboardCategoryForm) dashboardCategoryForm.addEventListener("submit", handleDashboardCategoryCreate);
    const importButton = document.getElementById("process-import");
    if (importButton) importButton.addEventListener("click", handleImportButtonClick);
    const importNotasButton = document.getElementById("importar-notas");
    if (importNotasButton) {
      importNotasButton.addEventListener("click", () => handleVendasImportButton("Nota Fiscal", "#vendas-notas-input"));
    }
    const importRecibosButton = document.getElementById("importar-recibos");
    if (importRecibosButton) {
      importRecibosButton.addEventListener("click", () => handleVendasImportButton("Recibo", "#vendas-recibos-input"));
    }
    document.getElementById("transaction-table").addEventListener("click", handleTableActions);
    document.getElementById("transaction-table").addEventListener("change", handleTransactionCategoryChange);
    const categoryTags = document.getElementById("category-tags");
    if (categoryTags) categoryTags.addEventListener("click", handleCategoryRemove);
    const accountGroupList = document.getElementById("account-group-list");
    if (accountGroupList) accountGroupList.addEventListener("click", handleAccountGroupRemove);
    const dashboardCategoryList = document.getElementById("dashboard-category-list");
    if (dashboardCategoryList) {
      dashboardCategoryList.addEventListener("click", handleDashboardCategoryActions);
      dashboardCategoryList.addEventListener("change", handleDashboardCategoryAssociationInput);
    }
    const categoryMappingList = document.getElementById("category-mapping-list");
    if (categoryMappingList) categoryMappingList.addEventListener("click", handleCategoryMappingRemove);
    const empresaForm = document.getElementById("empresa-form");
    if (empresaForm) {
      empresaForm.addEventListener("submit", (e) => {
        e.preventDefault();
        addEmpresa(empresaForm);
      });
      const regimeSelect = document.getElementById("empresa-regime");
      if (regimeSelect) regimeSelect.addEventListener("change", updateEmpresaRegimeFields);
      const issCheckbox = document.getElementById("empresa-iss-fixo");
      if (issCheckbox) issCheckbox.addEventListener("change", updateEmpresaIssValorField);
      const issAliquotaInput = document.getElementById("empresa-iss-aliquota");
      if (issAliquotaInput) issAliquotaInput.addEventListener("change", sanitizeEmpresaIssAliquota);
      updateEmpresaRegimeFields();
    }
    const clientForm = document.getElementById("client-form");
    if (clientForm) clientForm.addEventListener("submit", handleClientCreation);
    const empresasTable = document.getElementById("empresas-table");
    if (empresasTable) {
      empresasTable.addEventListener("click", (evt) => {
        const editId = evt.target.dataset.editEmpresa;
        if (editId) startEmpresaEdit(editId);
        const removeId = evt.target.dataset.removeEmpresa;
        if (removeId) deleteEmpresa(removeId);
      });
    }
    const userForm = document.getElementById("user-form");
    if (userForm) {
      userForm.addEventListener("submit", (evt) => {
        evt.preventDefault();
        addOrUpdateUser(evt.target);
      });
      userForm.userRole?.addEventListener("change", updateUserFormType);
    }
    const usersTable = document.getElementById("users-table");
    if (usersTable) {
      usersTable.addEventListener("click", (evt) => {
        const editId = evt.target.dataset.editUser;
        const toggleId = evt.target.dataset.toggleUser;
        if (editId) startUserEdit(editId);
        if (toggleId) toggleUserStatus(toggleId);
      });
    }
    const transactionFilterForm = document.getElementById("transaction-filter-form");
    if (transactionFilterForm) {
      transactionFilterForm.addEventListener("input", () => {
        state.transactionFilters.start =
          document.getElementById("filter-start-date").value;

        state.transactionFilters.end =
          document.getElementById("filter-end-date").value;

        const monthInput = document.getElementById("filter-transaction-month");
        if (monthInput) state.transactionFilters.month = monthInput.value;

        const yearInput = document.getElementById("filter-transaction-year");
        if (yearInput) state.transactionFilters.year = yearInput.value;

        state.transactionFilters.type =
          document.getElementById("filter-type").value;

        state.transactionFilters.parametro =
          document.getElementById("filter-parametro").value;

        state.transactionFilters.descriptionSearch =
          document.getElementById("filter-description").value;

        applyTransactionFilters();
      });
    }
    const vendasFilterForm = document.getElementById("vendas-filter-form");
    if (vendasFilterForm) {
      vendasFilterForm.addEventListener("input", () => {
        state.vendasFilters.start =
          document.getElementById("vendas-filter-start-date").value;

        state.vendasFilters.end =
          document.getElementById("vendas-filter-end-date").value;

        state.vendasFilters.type =
          document.getElementById("vendas-filter-type").value;

        state.vendasFilters.descriptionSearch =
          document.getElementById("vendas-filter-description").value;

        renderVendas();
      });
    }
    const vendasPrevButton = document.getElementById("vendas-prev-page");
    if (vendasPrevButton) {
      vendasPrevButton.addEventListener("click", () => {
        if (vendasCurrentPage > 1) {
          vendasCurrentPage -= 1;
          renderVendasTable();
        }
      });
    }
    const vendasNextButton = document.getElementById("vendas-next-page");
    if (vendasNextButton) {
      vendasNextButton.addEventListener("click", () => {
        const maxPage = Math.max(1, Math.ceil(vendasFiltered.length / vendasPageSize));
        if (vendasCurrentPage < maxPage) {
          vendasCurrentPage += 1;
          renderVendasTable();
        }
      });
    }
    const vendasPageSizeSelect = document.getElementById("vendas-page-size");
    if (vendasPageSizeSelect) {
      vendasPageSizeSelect.addEventListener("change", (e) => {
        vendasPageSize = Number(e.target.value) || 100;
        vendasCurrentPage = 1;
        renderVendasTable();
      });
    }
    document.querySelector("nav").addEventListener("click", handleSectionChange);
    const clearFiltersButton = document.getElementById("clear-transaction-filters");
    if (clearFiltersButton) {
      clearFiltersButton.addEventListener("click", () => {
        state.transactionFilters = {
          start: "",
          end: "",
          month: "",
          year: "",
          type: "all",
          parametro: "all",
          descriptionSearch: ""
        };

        transactionFilterForm?.reset();
        filteredTransactions = [...allTransactions];
        currentPage = 1;
        renderTransactionTable(filteredTransactions);
        updateFilteredDeleteButton();
      });
    }
    const clearVendasFiltersButton = document.getElementById("clear-vendas-filters");
    if (clearVendasFiltersButton) {
      clearVendasFiltersButton.addEventListener("click", () => {
        state.vendasFilters = {
          start: "",
          end: "",
          type: "all",
          descriptionSearch: ""
        };

        vendasFilterForm?.reset();
        renderVendas();
      });
    }
    const deleteFilteredVendasButton = document.getElementById("delete-filtered-vendas");
    if (deleteFilteredVendasButton) {
      deleteFilteredVendasButton.addEventListener("click", deleteFilteredVendas);
    }
    document.getElementById("delete-filtered-transactions").addEventListener("click", deleteFilteredTransactions);
    updateTransactionConditionalFields();
  </script>
</body>
</html>


















